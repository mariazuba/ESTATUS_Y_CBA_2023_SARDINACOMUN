---
title: "Figuras y Tablas para  Informe de Estatus y CBA de sardina común Centro sur "
output: 
    pdf_document:
      toc: TRUE
      toc_depth: '3'
      number_sections: yes
      extra_dependencies: ["flafter"]
header-includes:
- \usepackage{draftwatermark}
- \SetWatermarkText{}
- \usepackage[spanish,es-tabla]{babel}
- \usepackage{setspace}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{parskip}
- \usepackage{caption}
- \captionsetup[table]{name=\textbf{Tabla},labelsep=period}
- \captionsetup[figure]{name=\textbf{Figura},labelsep=period}
- \captionsetup{justification=justified,format=plain,font=small,labelfont=bf,margin=40pt}
- \pagestyle{fancy}
- \usepackage{geometry}
- \geometry{top=1.5cm, bottom=1cm, left=2.5cm, right=2.5cm}
- \usepackage{helvet}
- \renewcommand{\familydefault}{\sfdefault}
- \usepackage{multirow}
- \usepackage{natbib}
- \renewcommand{\baselinestretch}{1.2}
- \newcommand{\sietepuntos}{\fontsize{7pt}{\baselineskip}\selectfont}
- \newcommand{\cincopuntos}{\fontsize{6pt}{\baselineskip}\selectfont}
- \usepackage{color,colortbl}
- \definecolor{Gray}{rgb}{0.801,0.801,0.801}
- \definecolor{Gray1}{rgb}{0.790,0.790,0.790}
- \definecolor{Gray2}{rgb}{0.830,0.830,0.830}
- \definecolor{Gray3}{rgb}{0.870,0.870,0.870}
- \definecolor{Gray4}{rgb}{0.940,0.940,0.940}
- \addtolength{\headheight}{4.5\baselineskip}
- \setlength{\headheight}{70pt}
- \setlength{\footskip}{5pt}
- \setlength{\textheight}{658pt}
- \fancyhead[CO,CE]{\includegraphics[height=1.5cm]{Figuras/logoifop.png}\\ \sietepuntos INSTITUTO DE FOMENTO PESQUERO / DIVISION INVESTIGACION PESQUERA}
- \fancyhead[LO,LE]{ }
- \fancyhead[RO,RE]{ }
- \renewcommand{\headrulewidth}{0.5pt}
- \fancyfoot[C]{\cincopuntos \thepage \\ \vspace{-0.2cm} ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \\ \vspace{-0.2cm} \cincopuntos CONVENIO DE DESEMPEÑO 2023 IFOP/SUBSECRETARÍA DE ECONOMíA Y EMT \\ \vspace{-0.1cm} INFORME. SARDINA COMÚN, REGIÓN DE VALPARAÍSO A LA REGIÓN DE LOS LAGOS}


bibliography: Referencias_noviembre2021.bib
csl: apa_1.csl

link-citations: yes

linkcolor: blue
urlcolor: blue
citecolor: blue

---


\pagebreak

```{r llama codigos, warning=F, include=T, message=F, echo=FALSE}
library(knitr) # para generar reporte Rmarkdown
library(stringr)
library(reshape) 
library(dplyr) 
library(ggplot2)
library(ggthemes) # para ggplot
library(patchwork) # para unir gráficos de ggplot
library(strucchange) # libreria utilizada para análisis de quiebres
library(kableExtra)

dir.Fig     <-"Figuras/" # carpeta de las figuras utilizadas y generadas en este estudio
fig         <-c("pdf") # formato de figuras generadas por este código
dir.0       <-getwd() # directorio de trabajo 
dir.1       <-paste(dir.0,"/codigos_admb",sep="") # carpeta de códigos ADMB 
dir.2       <-paste(dir.0,"/codigos_admb_12.3_windows",sep="") # carpeta de códigos ADMB 
dir.fun     <-paste(dir.0,"/funciones/",sep="") # carpeta de funciones utilizadas en este informe
source(paste(dir.fun,"functions.R",sep="")) # funciones para leer .dat y .rep
source(paste(dir.fun,"Fn_PBRs.R",sep="")) # funciones para leer .dat y .rep
ant <-reptoRlist(paste(dir.0,"/DatosEntrada.dat",sep=""))  # datos utilizados para antecedentes

```

```{r CORRE MODELO BASE SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)

#system("~/admb-12.2/admb MAE922")
#system("./MAE922")

system("/ADMB/admb MAE922")
system("MAE922")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAE922") 

```

```{r CORRE MODELO BASE MARZO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
system("~/admb-12.2/admb MAE322")
system("./MAE322")

#system("/ADMB/admb MAE322")
#system("MAE322")


source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAE322") 

```


```{r CORRE MODELO BASE JULIO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
system("~/admb-12.2/admb MAE722")
system("./MAE722")

#system("/ADMB/admb MAE722") No compila en windows revisar!!!
#system("MAE722")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAE722")

```


```{r  leer datos, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)

# ASESORÍA DE SEPTIEMBRE
data1        <- lisread("MAE922.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAE922.rep")
std1         <- read.table("MAE922.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE MARZO
data2        <- lisread("MAE322.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAE322.rep")
std2         <- read.table("MAE322.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE JULIO
data3        <- lisread("MAE722.dat") 
names(data3) <- str_trim(names(data3), side="right")
dat3         <- data3
rep3         <- reptoRlist("MAE722.rep")
std3         <- read.table("MAE722.std",header=T,sep="",na="NA",fill=T) 

```

<!--- Arreglos para tablas -->

```{r t1_indices, echo=FALSE,eval=T,warning=F, include=T, message=F}
year<-format(dat1$Ind[,1],nsmall=0, big.mark="")
recl<-dat1$Ind[,2]
pela<-dat1$Ind[,4]
mpdh<-dat1$Ind[,6]

dataInd<-data.frame(year,recl,pela,mpdh)

```


```{r t2_desembarques y descarte, echo=FALSE,eval=T,warning=F, include=T, message=F,}

bioyear<-c("1990-91","1991-92","1992-93","1993-94","1994-95",
           "1995-96","1996-97","1997-98","1998-99","1999-00",
           "2000-01","2001-02","2002-03","2003-04","2004-05",
           "2005-06","2006-07","2007-08","2008-09","2009-10",
           "2010-11","2011-12","2012-13","2013-14","2014-15",
           "2015-16","2016-17","2017-18","2018-19","2019-20",
           "2020-21",'2021-22')

desemYdesc_previo<-c(494567,514787,250237,358949,120608,
                     361735,552515,73892,212993,205616,
                     52469,317467,293654,387597,252695,
                     516296,358380,742168,942051,627588,
                     828172,859565,418607,520667,417249,
                     300574,407403,355545,319650,289779,
                     391294.5,218835)

desc_previo<-c(rep(1,10),rep(1.04,16),rep(1.02,2),rep(1.06,2),1.04,1.04)
desembarque<-desemYdesc_previo/desc_previo

desc_actualizado<-c(rep(1,10),rep(1.04,17),1.07,1.05,1.04,1.04,1.04)
CapturaDescartada<- -(1-desc_actualizado)*desembarque
CapturaTotal<-desembarque+CapturaDescartada

porcDesc_actualizado<-c(rep("0%",10),rep("4%",17),"7%","5%","4%","4%",'4%')

dataDes_y_descar<-data.frame("Año biológico"=bioyear,
                 "Desembarques t."=round(desembarque,0),
                 "Porcentaje descarte" =porcDesc_actualizado,
                 "Captura descartada t."=round(CapturaDescartada,0),
                 "Captura total t."=round(CapturaTotal,0))



```


```{r Tab17_varpobl, echo=F,warning=FALSE,include=T}

yearsb<-c("1990/91","1991/92","1992/93","1993/94","1994/95","1995/96","1996/97",
          "1997/98","1998/99","1999/00","2000/01","2001/02","2002/03","2003/04",
          "2004/05","2005/06","2006/07","2007/08","2008/09","2009/10","2010/11",
          "2011/12","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18",
          "2018/19","2019/20",'2020/21','2021/22')

Rt1      <- c(subset(std1,name=="Reclutas")$value) 
Rt1std   <- c(subset(std1,name=="Reclutas")$std)
BT1      <- c(subset(std1,name=="BT")$value)   
BT1std   <- c(subset(std1,name=="BT")$std)
BD1      <- c(subset(std1,name=="SSB")$value)   
BD1std   <- c(subset(std1,name=="SSB")$std)
Ft1      <- c(subset(std1,name=="log_Ft")$value)   
Ft1std   <- c(subset(std1,name=="log_Ft")$std)


Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std


Rt3      <- c(rep3$Reclutas)
Rt3std   <- c(subset(std3,name=="Reclutas")$std)
BT3      <- c(rep3$BT) 
BT3std   <- c(subset(std3,name=="BT")$std)
BD3      <- c(rep3$SSB)  
BD3std   <- c(subset(std3,name=="SSB")$std)
Ft3      <- c(log(rep3$Ftot)) 
Ft3std   <- c(subset(std3,name=="log_Ft")$std)



```


<!-- Puntos biológicos de referencia -->

```{r Data_PBR_biologico_sept, echo=F}
#PBR año biologico
Amax        <- dat1$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat1$par[5]             
Dat$Tspw	  <- dat1$Dt[3]              
Dat$Mad	    <- dat1$madurezsexual        
Dat$Wmed	  <- colMeans(dat1$Wmed)      
Dat$Wini	  <- colMeans(dat1$Wini) 
Dat$Sel     <- rep1$Sel_flota[1,] 

Rmed1        <- mean(Rt1,na.rm = T)           
Bmed1        <- mean(BD1,na.rm = T)         
Fmedian1     <- exp(median(Ft1,na.rm = T))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR1 		    <- SPRFmort(Rmed1,c(0,Fobj$par,Fmedian1,rep1$Ftot[25]),Amax,Dat) 
pSPR_Fmh1    <- as.numeric(SPR1[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh1      <- pSPR_Fmh1-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv1 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```




```{r Data_PBR_biologico_marzo, echo=F}
#PBR año biologico
Amax        <- dat2$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat2$par[5]             
Dat$Tspw	  <- dat2$Dt[3]              
Dat$Mad	    <- dat2$madurezsexual        
Dat$Wmed	  <- colMeans(dat2$Wmed)      
Dat$Wini	  <- colMeans(dat2$Wini) 
Dat$Sel     <- rep2$Sel_flota[1,] 

Rmed2        <- mean(Rt2)           
Bmed2        <- mean(BD2)         
Fmedian2     <- exp(median(Ft2))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR2 		    <- SPRFmort(Rmed2,c(0,Fobj$par,Fmedian2,rep2$Ftot[25]),Amax,Dat) 
pSPR_Fmh2    <- as.numeric(SPR2[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh2      <- pSPR_Fmh2-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv2 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```




```{r Data_PBR_biologico_julio, echo=F}
#PBR año biologico
Amax        <- dat3$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat3$par[5]             
Dat$Tspw	  <- dat3$Dt[3]              
Dat$Mad	    <- dat3$madurezsexual        
Dat$Wmed	  <- colMeans(dat3$Wmed)      
Dat$Wini	  <- colMeans(dat3$Wini) 
Dat$Sel     <- rep3$Sel_flota[1,] 

Rmed3        <- mean(Rt3)           
Bmed3        <- mean(BD3)         
Fmedian3     <- exp(median(Ft3))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR3 		    <- SPRFmort(Rmed3,c(0,Fobj$par,Fmedian3,rep3$Ftot[25]),Amax,Dat) 
pSPR_Fmh3    <- as.numeric(SPR3[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh3      <- pSPR_Fmh3-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv3 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```


```{r pbrs septiembre, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo1           <- rep1$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS1         <- rep1$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS1         <- rep1$Fs[2]
BLIM1         <- Bo1*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM1         <- rep1$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB1          <- BD1                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE1        <- BD1std                               # desviaci?n estandar BD
ln_Fyr1       <- Ft1                                    # logaritmo de Ft
ln_FSE1       <- Ft1std                                 # logaritmo de la desviaci?n standar de Ft
```




```{r pbrs marzo, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo2           <- rep2$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS2         <- rep2$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS2         <- rep2$Fs[2]
BLIM2         <- Bo2*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM2         <- rep2$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB2          <- BD2                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE2        <- BD2std                               # desviaci?n estandar BD
ln_Fyr2       <- Ft2                                    # logaritmo de Ft
ln_FSE2       <- Ft2std                                 # logaritmo de la desviaci?n standar de Ft
```

\pagebreak


```{r pbrs julio, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo3           <- rep3$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS3         <- rep3$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS3         <- rep3$Fs[2]
BLIM3         <- Bo3*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM3         <- rep3$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB3          <- BD3                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE3        <- BD3std                               # desviaci?n estandar BD
ln_Fyr3       <- Ft3                                    # logaritmo de Ft
ln_FSE3       <- Ft3std                                 # logaritmo de la desviaci?n standar de Ft
```



```{r Estatus_sept, echo=F,message=FALSE, warning=FALSE, include=T}

years1<-rep1$years
nyears1<-length(years1)
#para serie histórica
Rpr1     <- c(subset(std1,name=="RPRequ3")$value); 
Rpr1std  <- c(subset(std1,name=="RPRequ3")$std)
Frpr1    <- c(subset(std1,name=="Frpr")$value); 
Frpr1std <- c(subset(std1,name=="Frpr")$std)

EstatusSep<- data.frame(x=years1, 
                        Rpr1=Rpr1,
                        Frpr1=Frpr1,
                        lowerRpr1  = (Rpr1 - 1.96*Rpr1std ), 
                        upperRpr1  = (Rpr1 +1.96*Rpr1std ),
                        lowerFrpr1 = (Frpr1 -1.96*Frpr1std), 
                        upperFrpr1 = (Frpr1 +1.96*Frpr1std))

#Para densidad de probabilidad
rprSEPT     <-subset(std1,name=="RPRequ3")$value[nyears1]
rprSEPTstd  <-subset(std1,name=="RPRequ3")$std[nyears1]
FrprSEPT    <-subset(std1,name=="Frpr")$value[nyears1]
FrprSEPTstd <-subset(std1,name=="Frpr")$std[nyears1]

# biomasa desovante vs BDrms
xbs1 <-rnorm(1000, mean = rprSEPT, sd = rprSEPTstd)
xbs  <-seq(min(xbs1),max(xbs1),0.005)
ybs  <-dnorm(xbs, mean = rprSEPT, sd =rprSEPTstd)
icbs <-qnorm(c(0.05,0.95,0.5),rprSEPT,rprSEPTstd)

# mortalidad por pesca vs Frms
xfs1 <- rnorm(1000, mean = FrprSEPT, sd = FrprSEPTstd)
xfs  <-seq(min(xfs1),max(xfs1),0.005)
yfs  <-dnorm(xfs, mean = FrprSEPT, sd =FrprSEPTstd)
icfs <-qnorm(c(0.05,0.95,0.5),FrprSEPT,FrprSEPTstd)

#distribución probabilidad
xxbs      <- c(xbs[xbs>=icbs[1]&xbs<=icbs[2]],
               rev(xbs[xbs>=icbs[1]&xbs<=icbs[2]]))

yybs      <- c(ybs[xbs>=icbs[1]&xbs<=icbs[2]],
               rep(0,length(ybs[xbs>=icbs[1]&xbs<=icbs[2]])))

xxfs      <- c(xfs[xfs>=icfs[1]&xfs<=icfs[2]],
               rev(xfs[xfs>=icfs[1]&xfs<=icfs[2]]))

yyfs      <- c(yfs[xfs>=icfs[1]&xfs<=icfs[2]],
               rep(0,length(yfs[xfs>=icfs[1]&xfs<=icfs[2]])))

densb_bs  <- data.frame(x=xxbs, y=yybs , t=rep('a', length(xxbs)), r=seq(1,length(xxbs),1))
densb_fs  <- data.frame(x=xxfs, y=yyfs , t=rep('a', length(xxfs)), r=seq(1,length(xxfs),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría Septiembre #P(BD<BDrms) 
pa_sept<-pnorm(0.9,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría Septiembre #P(F>Frms)
pb_sept<-1-pnorm(1.1,FrprSEPT,FrprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría Septiembre #P(BD<BDrms) 
pc_sept<-pnorm(0.9,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)-pnorm(0.5,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
#Asesoría Septiembre #P(BD<BDrms) 
pd_sept<-pnorm(0.5,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
#Asesoría Septiembre #P(F>Frms)
pe_sept<-1-pnorm(1.1,FrprSEPT,FrprSEPTstd,lower.tail = TRUE,log.p = F)
```



<!-- Estatus -->

```{r Estatus_marzo, echo=F,message=FALSE, warning=FALSE, include=T}

years2<-rep2$years
nyears2<-length(years2)

#para serie histórica indicadores del estatus
Rpr2     <- subset(std2,name=="RPRequ3")$value; 
Rpr2std  <- subset(std2,name=="RPRequ3")$std
Frpr2    <- subset(std2,name=="Frpr")$value; 
Frpr2std <- subset(std2,name=="Frpr")$std

EstatusMar<- data.frame(x=years2, 
                        Rpr2=Rpr2,
                        Frpr2=Frpr2,
         lowerRpr2  = (Rpr2 - 1.96*Rpr2std ),
         upperRpr2   = (Rpr2 +1.96*Rpr2std ),
         lowerFrpr2 = (Frpr2 -1.96*Frpr2std), 
         upperFrpr2 = (Frpr2+1.96*Frpr2std))

#Para densidad de probabilidad
rprMARZO     <-subset(std2,name=="RPRequ3")$value[nyears2]
rprMARZOstd  <-subset(std2,name=="RPRequ3")$std[nyears2]
FrprMARZO    <-subset(std2,name=="Frpr")$value[nyears2]
FrprMARZOstd <-subset(std2,name=="Frpr")$std[nyears2]
# biomasa desovante vs BDrms - densidad de probabilidad
xbm1 <-rnorm(1000, mean = rprMARZO, sd = rprMARZOstd)
xbm  <-seq(min(xbm1),max(xbm1),0.005)
ybm  <-dnorm(xbm, mean = rprMARZO, sd =rprMARZOstd)
icbm <-qnorm(c(0.05,0.95,0.5),rprMARZO,rprMARZOstd)
# mortalidad por pesca vs Frms - densidad de probabilidad
xfm1 <- rnorm(1000, mean = FrprMARZO, sd = FrprMARZOstd)
xfm  <-seq(min(xfm1),max(xfm1),0.005)
yfm  <-dnorm(xfm, mean = FrprMARZO, sd =FrprMARZOstd)
icfm <-qnorm(c(0.05,0.95,0.5),FrprMARZO,FrprMARZOstd)
#distribución probabilidad
xxbm      <- c(xbm[xbm>=icbm[1]&xbm<=icbm[2]],
               rev(xbm[xbm>=icbm[1]&xbm<=icbm[2]]))

yybm      <- c(ybm[xbm>=icbm[1]&xbm<=icbm[2]],
               rep(0,length(ybm[xbm>=icbm[1]&xbm<=icbm[2]])))

xxfm      <- c(xfm[xfm>=icfm[1]&xfm<=icfm[2]],
               rev(xfm[xfm>=icfm[1]&xfm<=icfm[2]]))

yyfm      <- c(yfm[xfm>=icfm[1]&xfm<=icfm[2]],
               rep(0,length(yfm[xfm>=icfm[1]&xfm<=icfm[2]])))

densb_bm  <- data.frame(x=xxbm, y=yybm , t=rep('a', length(xxbm)), r=seq(1,length(xxbm),1))
densb_fm  <- data.frame(x=xxfm, y=yyfm , t=rep('a', length(xxfm)), r=seq(1,length(xxfm),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría marzo #P(BD<BDrms) 
pa_mar<-pnorm(0.9,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría marzo #P(F>Frms)
pb_mar<-1-pnorm(1.1,FrprMARZO,FrprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría marzo #P(BD<BDrms) 

pc_mar<-pnorm(0.9,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)-pnorm(0.5,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)

### *Probabilidad de estar en zona de colapso*
#Asesoría marzo #P(BD<BDrms) 
pd_mar<-pnorm(0.5,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)

### *Probailidad de sobrepesca*
#Asesoría marzo #P(F>Frms)
pe_mar<-1-pnorm(1.1,FrprMARZO,FrprMARZOstd,lower.tail = TRUE,log.p = F)

```


<!--- Este estatus se calcula en la asesoría de julio -->
```{r Estatus_julio, echo=F,message=FALSE, warning=FALSE, include=T}

years3  <-rep3$years
nyears3 <-length(years3)

#para serie histórica indicadores del estatus
Rpr3     <- subset(std3,name=="RPRequ3")$value; 
Rpr3std  <- subset(std3,name=="RPRequ3")$std
Frpr3    <- subset(std3,name=="Frpr")$value; 
Frpr3std <- subset(std3,name=="Frpr")$std

EstatusJul<- data.frame(x=years3,
                        Rpr3=Rpr3,
                        Frpr3=Frpr3,
                  lowerRpr3   = (Rpr3  -1.96*Rpr3std ), 
                  upperRpr3   = (Rpr3 +1.96*Rpr3std ),
                  lowerFrpr3  = (Frpr3 -1.96*Frpr3std), 
                  upperFrpr3  = (Frpr3 +1.96*Frpr3std))

#Para densidad de probabilidad
rprJULIO     <-subset(std3,name=="RPRequ3")$value[nyears3]
rprJULIOstd  <-subset(std3,name=="RPRequ3")$std[nyears3]
FrprJULIO    <-subset(std3,name=="Frpr")$value[nyears3]
FrprJULIOstd <-subset(std3,name=="Frpr")$std[nyears3]
# biomasa desovante vs BDrms - densidad de probabilidad
xbj1 <-rnorm(1000, mean = rprJULIO, sd = rprJULIOstd)
xbj  <-seq(min(xbj1),max(xbj1),0.005)
ybj  <-dnorm(xbj, mean = rprJULIO, sd =rprJULIOstd)
icbj <-qnorm(c(0.05,0.95,0.5),rprJULIO,rprJULIOstd)
# mortalidad por pesca vs Frms - densidad de probabilidad
xfj1 <- rnorm(1000, mean = FrprJULIO, sd = FrprJULIOstd)
xfj  <-seq(min(xfj1),max(xfj1),0.005)
yfj  <-dnorm(xfj, mean = FrprJULIO, sd =FrprJULIOstd)
icfj <-qnorm(c(0.05,0.95,0.5),FrprJULIO,FrprJULIOstd)
#distribución probabilidad
xxbj      <- c(xbj[xbj>=icbj[1]&xbj<=icbj[2]],rev(xbj[xbj>=icbj[1]&xbj<=icbj[2]]))
yybj      <- c(ybj[xbj>=icbj[1]&xbj<=icbj[2]],rep(0,length(ybj[xbj>=icbj[1]&xbj<=icbj[2]])))
xxfj      <- c(xfj[xfj>=icfj[1]&xfj<=icfj[2]],rev(xfj[xfj>=icfj[1]&xfj<=icfj[2]]))
yyfj      <- c(yfj[xfj>=icfj[1]&xfj<=icfj[2]],rep(0,length(yfj[xfj>=icfj[1]&xfj<=icfj[2]])))

densb_bj  <- data.frame(x=xxbj, y=yybj , t=rep('a', length(xxbj)), r=seq(1,length(xxbj),1))
densb_fj  <- data.frame(x=xxfj, y=yyfj , t=rep('a', length(xxfj)), r=seq(1,length(xxfj),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría julio #P(BD<BDrms) 
pa_jul<-pnorm(0.9,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría julio#P(F>Frms)
pb_jul<-1-pnorm(1.1,FrprJULIO,FrprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría julio #P(BD<BDrms) 
pc_jul<-pnorm(0.9,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)-pnorm(0.5,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
#Asesoría julio #P(BD<BDrms) 
pd_jul<-pnorm(0.5,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
#Asesoría julio #P(F>Frms)
pe_jul<-1-pnorm(1.1,FrprJULIO,FrprJULIOstd,lower.tail = TRUE,log.p = F)

```


<!-- CBA Inicial (Asesoría de septiembre) -->


```{r proyecciona,warning=F, include=T, message=F,eval=T, echo=F}

dira<-paste(dir.0,"/CBA_sept/",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE92211.rep")  
reps2a     <- reptoRlist("MAE92212.rep") 
reps3a     <- reptoRlist("MAE92213.rep") 

carpeta<-"/CBA_sept/"
stds1     <- read.table(paste(dir.0,carpeta,"MAE92211.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds2     <- read.table(paste(dir.0,carpeta,"MAE92212.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds3     <- read.table(paste(dir.0,carpeta,"MAE92213.std", sep=''),header=T,sep="",na="NA",fill=T) 

bds1     <- subset(stds1,name=="BD_p0")$value ; 
bds1std  <- subset(stds1,name=="BD_p0")$std #reclutamiento medios
bds2     <- subset(stds2,name=="BD_p0")$value ; 
bds2std  <- subset(stds2,name=="BD_p0")$std #reclutamiento 2018
bds3     <- subset(stds3,name=="BD_p0")$value ; 
bds3std  <- subset(stds3,name=="BD_p0")$std #reclutamiento 2012

RpRps1     <- subset(stds1,name=="RPR_p0")$value ; 
RpRps1std  <- subset(stds1,name=="RPR_p0")$std #reclutamiento medios
RpRps2     <- subset(stds2,name=="RPR_p0")$value ; 
RpRps2std  <- subset(stds2,name=="RPR_p0")$std #reclutamiento 2018
RpRps3     <- subset(stds3,name=="RPR_p0")$value ; 
RpRps3std  <- subset(stds3,name=="RPR_p0")$std #reclutamiento 2012

cs1     <- subset(stds1,name=="YTP_p0")$value ; 
cs1std  <- subset(stds1,name=="YTP_p0")$std #reclutamiento medios
cs2     <- subset(stds2,name=="YTP_p0")$value ; 
cs2std  <- subset(stds2,name=="YTP_p0")$std #reclutamiento 2018
cs3     <- subset(stds3,name=="YTP_p0")$value ; 
cs3std  <- subset(stds3,name=="YTP_p0")$std #reclutamiento 2012


```


```{r Tabla32_CBA_septiembre, echo=FALSE, warning=F, include=T, message=F}
dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA     <- matrix(ncol=nq,nrow=nes)
CBAp    <- matrix(ncol=1,nrow=1)
CBApstd <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE9221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA[i,j]<-qnorm(q[j],CBAp[i],CBApstd[i])}}

```


```{r CBAinicial_sept, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_sept     <- matrix(ncol=nq,nrow=nes)
CBAp_sept    <- matrix(ncol=1,nrow=1)
CBApstd_sept <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE9221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_sept[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_sept[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_sept[i,j]<-qnorm(q[j],CBAp_sept[i],CBApstd_sept[i])}}

```


```{r CBAinicial-descarte_sept, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBAd_sept     <- matrix(ncol=nq,nrow=nes)
CBApd_sept    <- matrix(ncol=1,nrow=1)
CBApdstd_sept <- matrix(ncol=1,nrow=1)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE9221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBApd_sept[i]    <-subset(std,name=="CBA_c0d")$value[1]
	CBApdstd_sept[i] <-subset(std,name=="CBA_c0d")$std[1]
	for(j in 1:nq){	CBAd_sept[i,j]<-qnorm(q[j],CBApd_sept[i],CBApdstd_sept[i])}}



```



<!--- FUNCIONES PARA ANÁLISIS RETROSPECTIVO DE CADA ASESORÍA -->

```{r Retrospectivo_sept, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE922",
              dir.0,
              dir.1,
              "/Retrospectivo_sept",
              system="mac") 
```

```{r Retrospectivo_marzo, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE322",
              dir.0,
              dir.1,
              "/Retrospectivo_marz",
              system="mac") 
```

```{r Retrospectivo_julio, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE722",
              dir.0,
              dir.1,
              "/Retrospectivo_jul",
              system="mac") 
```

<!--- FUNCIONES PARA PERFIL DE VEROSIMILITUD DE CADA ASESORÍA -->

```{r Verosimilitud_sept, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE922",
              dir.0,
              dir.1,
              "/Verosimilitud_sept",
              logRo,
              priorRo,
              l_log_Ro=274,
              l_opt_Ro=313,
              l_Fase_desRt=316,
              system="mac") 
```

```{r Verosimilitud_marz, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE322",
              dir.0,
              dir.1,
              "/Verosimilitud_marz",
              logRo,
              priorRo,
              l_log_Ro=274,
              l_opt_Ro=313,
              l_Fase_desRt=316,
              system="mac") 

```

```{r Verosimilitud_jul, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE722",
              dir.0,
              dir.1,
              "/Verosimilitud_jul",
              logRo,
              priorRo,
              l_log_Ro=274,
              l_opt_Ro=313,
              l_Fase_desRt=316,
              system="mac") 
```

<!--- FUNCIONES PARA CBA POR ESCENARIO DE RECLUTAMIENTO DE CADA ASESORÍA -->

```{r PRIMER PASO CBA ASESORIA SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_sept", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE922", #códigos .dat y .tpl de asesoría de septiembre
    l_opt_proy=337, # línea  de opción de proyección que se debe cambiar
    l_opRec=343,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=349, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=340,  # linea de opción de estrategia de captura 
    l_mf=352,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=2,     # Proyecta de un año para otro (CBA inicial, asesoría de septiembre)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="windows")   # denpende si estoy en computador de windows o mac

source(paste(dir.fun,"removefile.R",sep=""))
dir.1<-paste(dir.0,"/CBA_sept",sep="")
removefileadmb(dir.1,"MAE922")

```

```{r PRIMER PASO CBA ASESORIA MARZO, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_marzo", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE322", #códigos .dat y .tpl de asesoría de marzo
    l_opt_proy=337, # línea  de opción de proyección que se debe cambiar
    l_opRec=343,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=349, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=340,  # linea de opción de estrategia de captura 
    l_mf=352,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=1,     # IMPORTANTE!! Proyecta para el mismo año (1era y 2da revisión de CBA, asesorías de marzo y julio)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="windows")   # denpende si estoy en computador de windows o mac

source(paste(dir.fun,"removefile.R",sep=""))
dir.1<-paste(dir.0,"/CBA_marzo",sep="")
removefileadmb(dir.1,"MAE322")

```

```{r PRIMER PASO CBA ASESORIA JULIO, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_julio", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE722", #códigos .dat y .tpl de asesoría de julio
    l_opt_proy=337, # línea  de opción de proyección que se debe cambiar
    l_opRec=343,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=349, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=340,  # linea de opción de estrategia de captura 
    l_mf=352,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=1,     # IMPORTANTE!! Proyecta para el mismo año (1era y 2da revisión de CBA, asesorías de marzo y julio)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="mac")   # denpende si estoy en computador de windows o mac

source(paste(dir.fun,"removefile.R",sep=""))
dir.1<-paste(dir.0,"/CBA_julio",sep="")
removefileadmb(dir.1,"MAE722")

```

<!--- FUNCIONES PARA ACTUALIZACION DE TAMAÑO DE MUESTRA -->

```{r TamañosMuestra, eval=FALSE, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)


#------------------------------------------------
dat.file   = "MAE922.dat"
data.0        <- lisread(paste(dir.1,dat.file, sep='/'));
names(data.0) <-  str_trim(names(data.0), side="right")
data.1        <- data.0
rep           <- reptoRlist("MAE922.rep")                                               
std           <- read.table("MAE922.std",header=T,sep="",na="NA",fill=T) 

# ============================================================================== #
# I. INDICES DE ABUNDANCIA                                                       #
# ============================================================================== #
years  <- data.1$Ind[,1]                                                              
nyears <- data.1$nanos                                                                
age    <- seq(0,4,1)                    
nage   <- data.1$nedades                                                            
Amax   <- data.1$nedades        
Age    <- seq(0,4,1) 
    

x  <-c(years,rev(years))
x1 <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <-c(years[1]-1,years[nyears]+1) #xlim

#============================================================#
# II. COMPOSICI?N EDAD DE LAS CAPTURAS                       #
#============================================================#
#age <-dat$"#Edades"                                         
age  <-seq(0,4,1)                                            
nage<-length(age)                                            
#Proporci?n observada                                        
pobsF<-rep$pf_obs                                              
pobsR<-rep$pobs_RECLAS                                       
pobsP<-rep$pobs_PELACES                                      
#Proporci?n predicha                                         
ppredF<-rep$pf_pred                                          
ppredR<-rep$ppred_RECLAS                                     
ppredP<-rep$ppred_PELACES                                    
resfl <-matrix(ncol=nage,nrow=nyears)                         
for(i in 1:nyears){                                          
	for(j in 1:nage){                                          
		resfl[,j]<-pobsF[,j]-ppredF[,j]}}                        
#Proporciones                                                
pF   <- c(pobsF,ppredF); pF[pF==0]  <-NA                     
pR   <- c(pobsR,ppredR); pR[pR==0]  <-NA                     
pP   <- c(pobsP,ppredP); pP[pP==0]  <-NA                     
#arreglos                                                    
edad <- rep(gl((length(age)),length(years),label=age),2)     
años <- rep(years,length(age)*2)                             
ind  <- c(rep("capt_obs",length(years)*length(age)),         
	rep("capt_est",length(years)*length(age)))        
pro  <- data.frame(años,edad,ind,pF,pR,pP)    
# ==========================================================================

#=================================================================#
# M?TODO de Francis
#=================================================================#
Nf1 <-60
Nr1 <-34
Np1 <-6
#-------------------------------------------#
#FLOTA
fanos<-years
fobs <-pobsF
fpre <-ppredF 
#RECLAS
ranos<-years
robs <-pobsR[rowSums(pobsR)>0,]
rpre <-ppredR[rowSums(pobsR)>0,]
#PELACES
panos<-years
pobs <-pobsP[rowSums(pobsP)>0,]
ppre <-ppredP[rowSums(pobsP)>0,] 

Of  <- rep(0,length(fanos))
Ef  <- rep(0,length(fanos))
vf  <- rep(0,length(fanos))
vNf <- rep(0,length(fanos))

Or  <- rep(0,length(robs[,1]))
Er  <- rep(0,length(robs[,1]))
vr  <- rep(0,length(robs[,1]))
vNr <- rep(0,length(robs[,1]))

Op  <- rep(0,length(pobs[,1]))
Ep  <- rep(0,length(pobs[,1]))
vp  <- rep(0,length(pobs[,1]))
vNp <- rep(0,length(pobs[,1]))
#-------------------------------------------#
for(i in 1:length(fanos)){
	Of[i]  <- sum(fobs[i,]*age)
	Ef[i]  <- sum(fpre[i,]*age)
	vf[i]  <- sum(fpre[i,]*age^2)-Ef[i]^2
	vNf[i] <- vf[i]/Nf1}

for(i in 1:length(robs[,1])){
	Or[i]  <- sum(robs[i,]*age)
	Er[i]  <- sum(rpre[i,]*age)
	vr[i]  <- sum(rpre[i,]*age^2)-Er[i]^2
	vNr[i] <- vr[i]/Nr1}

for(i in 1:length(pobs[,1])){
	Op[i]  <- sum(pobs[i,]*age)
	Ep[i]  <- sum(ppre[i,]*age)
	vp[i]  <- sum(ppre[i,]*age^2)-Ep[i]^2
	vNp[i] <- vp[i]/Np1}
#--------------------------------------------#
wf  <- 1/var((Of-Ef)/sqrt(vNf)) 
wr  <- 1/var((Or-Er)/sqrt(vNr)) 
wp  <- 1/var((Op-Ep)/sqrt(vNp))

Nf2 <- Nf1*wf                   # NM FLOTA
Nr2 <- Nr1*wr                   # NM RECLAS
Np2 <- Np1*wp                   # NM PELACES
#-----------------------------------------------------------------#
NM_Fran <- data.frame(nmF=c(Nf1,Nf2),nmR=c(Nr1,Nr2),nmP=c(Np1,Np2));NM_Fran
#-----------------------------------------------------------------#

#=================================================================#
# M?todo de Ianelli 2002
#=================================================================#
Ofl <-ppredF[rowSums(pobsF)>0,]*(1-ppredF[rowSums(pobsF)>0,])
Efl <-(pobsF[rowSums(pobsF)>0,]-ppredF[rowSums(pobsF)>0,])^2
wfl <-rep(0,length(Ofl[,1]))
for(i in 1:length(Ofl[,1])){
	wfl[i] <-sum(Ofl[i,])/sum(Efl[i,])}

nmf_ari <-mean(wfl)                      # MEDIA ARITMETICA
nmf_geo <-exp(sum(log(wfl))/length(wfl)) # MEDIA GEOM?TRICA
nmf_arm <-1/mean(1/wfl)                  # MEDIA ARM?NICA

#------------------------------------------------------------
Ore <-ppredR[rowSums(pobsR)>0,]*(1-ppredR[rowSums(pobsR)>0,])
Ere <-(pobsR[rowSums(pobsR)>0,]-ppredR[rowSums(pobsR)>0,])^2
wre <-rep(0,length(Ore[,1]))
for(i in 1:length(Ore[,1])){	
	wre[i] <-sum(Ore[i,])/sum(Ere[i,])}
nmr_ari <-mean(wre)                      # MEDIA ARITMETICA
nmr_geo <-exp(sum(log(wre))/length(wre)) # MEDIA GEOM?TRICA
nmr_arm <-1/mean(1/wre)                  # MEDIA ARM?NICA
#------------------------------------------------------------
Ope <-ppredP[rowSums(pobsP)>0,]*(1-ppredP[rowSums(pobsP)>0,])
Epe <-(pobsP[rowSums(pobsP)>0,]-ppredP[rowSums(pobsP)>0,])^2
wpe <-rep(0,length(Ope[,1]))
for(i in 1:length(Ope[,1])){
	wpe[i] <-sum(Ope[i,])/sum(Epe[i,])}

nmp_ari <-mean(wpe)                      # MEDIA ARITMETICA
nmp_geo <-exp(sum(log(wpe))/length(wpe)) # MEDIA GEOM?TRICA
nmp_arm <-1/mean(1/wpe)                  # MEDIA ARM?NICA
#------------------------------------------------------------
#------------------------------------------------------------
NM_Ian <- data.frame(nmF=c(nmf_ari,nmf_geo,nmf_arm),
                     nmR=c(nmr_ari,nmr_geo,nmr_arm),
                     nmP=c(nmp_ari,nmp_geo,nmp_arm))
kable(NM_Ian)
#------------------------------------------------------------

```




```{r echo=F}

asesoria_1<-"Septiembre 2022"

```


El presente informe contiene el estatus del año biológico 2021/22 y de la Captura Biológicamente Aceptable (CBA) del año calendario 2023 para el stock de sardina común en la Unidad de Pesquería Centro-Sur (UPCS) de Chile, Región de Valparaíso a Región de Los Lagos. El estudio es actualizado con la información disponible a junio de 2022: (1) Estadísticas de desembarques SERNAPESCA desde 1990/91 hasta 2021/22; (2) El porcentaje de descarte proveniente del Programa de Descarte de IFOP corresponde al período 2015-2021; (3) Información de captura a la edad y pesos individuales a la edad provenientes del "Programa de Seguimiento de las Principales Pesquerías Nacionales (Pesquerías Pelágicas)" desde 1990/91 hasta 2021/22; (4) Series de biomasas acústicas y composiciones de edad de verano (años 2000 a 2022) y otoño (años 2003 a 2022) provenientes del programa de cruceros IFOP "Evaluación hidroacústica de los stocks de anchoveta y sardina común entre las Regiones de Valparaíso y Los Lagos".; (5) publicaciones científicas y técnicas relacionadas con los parámetros del ciclo de vida (mortalidad natural y madurez).

El modelo de evaluación de stock de sardina común se basa en el análisis estadístico de la dinámica de estructuras de edad anual y pesos medios a la edad estimados del muestreo de tallas de los desembarques (período 1990 - junio 2022) y de los cruceros acústicos de verano (RECLAS, desde 2001 - 2022) y otoño (PELACES, período desde 2007 hasta 2022), de los índices de biomasa de los cruceros acústicos (biomasa de reclutas en verano, período desde 2000 hasta 2022 y biomasa vulnerable en otoño, desde 2003 al 2022 y los desembarques totales (período 1990 - junio 2022), estos últimos convertidos a temporada de pesca considerando la estacionalidad de la pesquería. Las fuentes de información utilizados en la evaluación de sardina común se resumen en la \textbf{Figura \ref{Fig19}}. 

## Descripción de los datos

Una de las principales características del stock de sardina común es el comportamiento estacional de las capturas, donde cerca del 70% de la captura total anual se obtiene al primer semestre de cada año, con máximos entre marzo y abril. Esta estacionalidad es altamente influenciada por el pulso de reclutamiento de enero, observándose una fuerte relación entre la biomasa estimada por el crucero de enero y los desembarques. Al respecto, se observa que durante los años 2015 al 2019, las biomasas acústicas de verano se mantuvieron en niveles en torno a los 2 millones de toneladas, lo cual se ve reflejado también en una estabilidad en las capturas totales en torno a las 360 mil toneladas. Por otro lado, las biomasas acústicas estimadas por el crucero de otoño reflejan el efecto de la remoción ejercidas por la pesca y causas naturales, con biomasas en general menores a las estimadas en el crucero de verano, en torno a 1,2 millones de toneladas promedio entre el 2015 al 2019 (\textbf{Tabla \ref{t1}} y \textbf{Figura \ref{Fig20}}). No obstante, para el año 2020 la biomasa estimada por el crucero acústico de verano se redujo a un millón de toneladas (54% menor al 2019), la biomasa del crucero de otoño disminuye un 39% respecto al 2019 y las capturas totales del año 2019/20 se redujeron un 10% respecto al año previo. El desembarque 2020 estuvo en torno a las 258 mil toneladas, equivalente a un 80% de la CBA 2020 recomendada por el CCT-PP (321.307 toneladas). La biomasa total estimada por el crucero de enero 2021 retorno a los niveles observados entre el 2015 al 2019 (2,36 millones de t), incrementando un 125% respecto a lo estimado para el año 2020 (\textbf{Tabla \ref{t1}} y \textbf{Figura \ref{Fig20}}). En el crucero de otoño, se estimó una biomasa de 1,1 millón de t, lo que equivale a un incremento del 26,8% respecto del año anterior. En relación con la captura total 2020/21 se registró un aumento del 38% respecto del año biológico 2019/20 (\textbf{Tabla \ref{t1}}). Para el año 2022, el crucero de enero registró un aumento del 35 % de la biomasa respecto al año previo, el crucero de otoño se mantuvo en torno al millón de toneladas y los niveles de capturas se redujeron un 44% respecto al año previo.

La pesquería de sardina común está sustentada principalmente por la abundancia del grupo de edad 0, con una proporción en torno al 60-70% de la captura en número de la flota. La captura en número a la edad se caracteriza por presentar una alta variabilidad interanual, siendo los años 2007, 2013, 2016, 2019 y 2020 los años con menor proporción de reclutas. Los pesos medios del grupo de edad 0 se encuentra en torno a los 8 grs. Se observa una estabilización de los pesos medios a partir del 2013 para todos los grupos de edad (\textbf{Figuras \ref{Fig22}}). En relación de la composición de edad de los cruceros de verano se observa que el grupo de edad 0 representa el 77% de la captura en número. Por otro lado, en el caso del crucero de otoño, el grupo de edad 0 representa el 67% de la captura en número (\textbf{Figuras \ref{Fig24}}). 

Los resultados del crucero de verano 2019 y 2020 presentan una disminución en los niveles de abundancia de la fracción recluta, el estimado de biomasa total del crucero de verano 2019 estuvo sostenido por la fracción adulta (edad 1+) principalmente.  Esta disminución se observó al actualizar la composición de edad de la flota 2018/19 y 2019/20 y del crucero de otoño 2019 y 2020. Por lo tanto, la disminución de la biomasa total 2020 estaría fuertemente relacionada a la reducción del número de individuos de los grupos de edad 0 y 1 principalmente.

Los resultados del crucero de verano 2021 mostraron un incremento significativo en los niveles de abundancia de la fracción recluta (94% individuos de edad 0), a diferencia de los dos años previos, la biomasa total del crucero de verano 2021 estuvo sostenido principalmente por la fracción recluta (edad 0), observandose una baja presencia de individuos adultos (edad 1+). Esta importante participación de la fracción recluta continúa en el crucero de otoño, con un 83% de individuos de edad 0 y una baja presencia de ejemplares adultos (edad 1+). Para el año 2022, el crucero de verano registró una disminución en la abundancia de la fracción recluta (46% individuos de edad 0), a diferencia de lo observado el año 2021. La biomasa total estimada por el crucero es sostenida por la fracción recluta y adulta (edad 1, principalmente). El crucero de otoño 2022 y flota 2021/2022 también evidencian una reducción del grupo de edad 0 (70% crucero de otoño y 16% flota de individuos de edad 0).



## Ajuste del modelo a los datos

Los índices de abundancia de los cruceros acústicos de verano y otoño contienen un importante nivel de variabilidad que se resume en la amplitud de los intervalos de confianza supuestos con coeficiente de variación cv=0,3. El modelo reproduce la tendencia general de la variabilidad en los niveles de biomasa que han presentado las estimaciones de los cruceros, siendo los valores más altos los que se escapan del ajuste, lo cual es consistente con la distribución de probabilidades empleada log-normal que considera sesgo positivo en su distribución. La \textbf{Figura \ref{Fig26}} muestra que a partir del 2014 el modelo ajusta muy bien la señal de los cruceros acústicos de verano y otoño. Para el año 2022 el modelo no logra capturar el incremento que se observa al incorporar  la  biomasa del crucero de verano 2022. No obstante es consistente con la señal que entrega el crucero de otoño y desembarques del último año.

El suavizador tipo oess de los residuales del modelo sugieren tendencias,  principalmente la serie de cruceros de verano y otoño, quienes tienen mayor variabilidad y lejanía relativa respecto de la línea esperada en el qqplot (\textbf{Figura \ref{Fig27}}). Los datos de captura (desembarques) se asumen insesgados y precisos con un CV de residuos de 0,01 lo cual se refleja en un buen ajuste del modelo a los datos de entrada.

El ajuste del modelo a la información de composición de edades en general presenta un buen desempeño, particularmente en representar de mejor forma la composición de edades de los cruceros de verano (\textbf{Figuras \ref{Fig28}}, \textbf{\ref{Fig29}} y \textbf{\ref{Fig30}}). El supuesto de invariabilidad anual de los patrones de explotación como medida de parsimonia, genera algunos desajustes en las composiciones de edades de las capturas, principalmente al inicio de la serie histórica y grupo de edad 0. El comportamiento de los residuales de las composiciones de edades de los cruceros sugiere ciertos patrones que se reflejan principalmente en una tendencia a la subestimación de los grupos de edad 0 en los cruceros de verano y otoño (\textbf{Figura \ref{Fig31}}).



## Comparación con asesorías previas


Se comparan los resultados de los principales indicadores de estatus del modelo base actual (`r asesoria_1`), con versiones anteriores para evaluar la consistencia de la evaluación presente (\textbf{Figura \ref{Fig32}}). Al respecto, el análisis no muestra diferencias significativas entre asesorías en términos de reclutamientos y biomasa desovante. Las diferencias observadas en términos de la mortalidad por pesca tiene relación con el supuesto de captura utilizado en las asesorías de marzo, que es corregido en la asesoría de julio y septiembre. La actualización de datos de la actual asesoría genera un reescalamiento de la serie en torno al 7% de la mortalidad por pesca (disminuye respecto de la asesoría previa) y un 8% de la biomasa desovante (incrementa respecto de la asesoría previa).



## Análisis retrospectivo

En la \textbf{Figura \ref{Fig33}} se muestra el patrón retrospectivo estándar y relativo de los reclutas, biomasa desovante y de la mortalidad por pesca de sardina común para el caso base de `r asesoria_1`. El análisis retrospectivo del modelo de evaluación muestra que en términos de rho (promedio de anomalías retrospectivas) la reducción de información genera un patrón de subestimación de los reclutas y de la biomasa desovante (rho = -0,19 y rho = -0,01, respectivamente), con una sobreestimación de la mortalidad por pesca (rho = +0,14). En general, los últimos años de las series pueden variar sustancialmente entre las sucesivas actualizaciones, mientras que hacia los primeros años tienden a converger a valores estables. La varianza estadística de las variables utilizadas para medidas de manejo tiende a aumentar en los últimos años de la serie, por lo tanto, son considerados estimaciones menos confiables.




## Perfil de verosimilitud

La \textbf{Figura \ref{Fig34}} muestra el perfil de verosimilitud realizado para la asesoría de `r asesoria_1` de cada fuente de dato cuyo mínimo representa la estimación máxima a posteriori del reclutamiento medio ($R_0$) para cada fuente de error del caso base. El perfil muestra que los datos cuyos perfiles estuvieron más próximos entre si y la diferencia del log verosimilitud respecto del mínimo se elevó por sobre el criterio estadístico $X^2=1,92$ fueron la biomasa acústica de verano (Bio_Reclas) y la proporción de edad del crucero de verano (C.Edad_Recl).  No obstante, la proporción de edad de la flota (C.Edad_Flota) estaría generando  un incremento en Ro, generando el reescalamiento de las series históricas (Ro_julio_2022 = 121, Ro_marzo_2022 = 118).


### Indicadores del stock

#### Reclutamientos:

Las tendencias de los reclutamientos han mostrado importantes fluctuaciones interanuales y en su historia conocida se aprecian tres períodos relevantes, a) Reclutamiento promedio del período 1991-2007 con los niveles más bajos de reclutamientos (117 mil millones de peces), b) Reclutamiento promedio del período 2008-2012 con los más altos niveles de reclutamiento (427 mil millones de peces) y c) Reclutamiento promedio del período 2013-2022 en torno a 187 mil millones de peces. Se destaca una recuperación importante de la clase anual 2021 respecto de los bajos niveles estimados en los 2 años precedentes. En relación a los tres períodos relevantes, el reclutamiento 2022 es un 12% mayor al Reclutamiento bajo (período 1991-2007), un 76% menor al Reclutamiento alto (período 2008-2012) y un 45% menor al Reclutamiento medio (2013-2022) (\textbf{Tabla \ref{Tab20a}} y \textbf{Figura \ref{Fig35}}).  El reclutamiento 2022 disminuye un 42% respecto a lo estimado en la asesoría previa al incorporar información del crucero de otoño (biomasa acústica y composición de edad) y flota (desembarques, composición de edad y pesos medios).


#### Biomasa total y desovante:

La biomasa total de este recurso, es sustentada esencialmente en los grupos de edad 0 y 1 año. En general, los grupos de edad 2+ no revisten mayor contribución en la producción tanto a nivel de desove como de biomasa disponible a la flota. La tendencia de la biomasa total muestra un importante crecimiento a partir del año 2008 que genera un cambio de nivel que se mantiene hasta el 2018. Sin embargo, presenta una alta variabilidad producto de las fluctuaciones del reclutamiento. El promedio de la biomasa total para el período de mayor productividad de sardina común entre los años 2008 y 2012 es de 2,88 millones de toneladas. Para el año 2022 se estimó una biomasa total actualizada de 2 millones de toneladas, un 29% menor al promedio del período de mayor productividad y un 14% mayor al promedio histórico de la serie (promedio 1991-2022 = 1,77 millones de t.) (\textbf{Tabla \ref{Tab20a}} y \textbf{Figura \ref{Fig35}}). Por otro lado, la biomasa desovante promedio de la serie histórica se encuentra en torno a 806 mil toneladas, mientras que el promedio de los ultimos 10 años  (período 2013-2022) de la serie es de 1,10 millones de toneladas. Al respecto, la biomasa desovante esperada para el año biológico 2021/2022 es un 46% mayor al promedio histórico y un 7% menor al promedio de los últimos 10 años (período 2013-2022) (\textbf{Tabla \ref{Tab20a}} y \textbf{Figura \ref{Fig35}}). La biomasa desovante al Máximo Rendimiento Sostenido (BD~RMS~) está en torno a las 859 mil toneladas, de esta forma la BD~2021/2022~ esperada está un 37% sobre BD~RMS~ (\textbf{Tabla \ref{Tab22}} y \textbf{\ref{Tab21}} y \textbf{Figura \ref{Fig35}}). La biomasa desovante está sustentada principalente por la fracción adulta, correspondiente a individuos de edad 1+, la cual disminuyó su abundancia producto de la disminución del reclutamiento de dos años previos consecutivos 2019 y 2020 junto a la disminución de la biomasa adulta (1+ años) el 2020, provocando que la biomasa desovante del año biológico 2020/2021 disminuyera significativamente respecto a años previos. No obstante, los altos reclutamientos registrados durante el 2021, junto a la disminución de las capturas permitirían retornar a  niveles de biomasa desovante sobre la biomasa objetivo para el año actual (2021/2022).

#### Mortalidad por pesca:

La mortalidad por pesca (Ft) ha sido más bien baja, en general menor a la mortalidad natural (M=1,0 año^-1^), excepto para el año 2004 cuando los niveles de biomasa eran bajos. Esto se ve reflejado en las capturas, que, en promedio, han seguido las fluctuaciones en biomasa con tasas de explotación moderadas (\textbf{Tabla \ref{Tab20a}} y \textbf{Figura \ref{Fig35}}). A partir del año 2005, la mortalidad por pesca ha seguido una tendencia al descenso, acentuada desde el año 2013 bajo el valor de F~RMS~ producto de la aplicación de F60%. Para el año 2021/2022 la mortalidad por pesca se redujo en un 55% respecto al año previo (año 2021) y un 57% respecto al supuesto de captura de la asesoría previa (marzo 2022) en torno al RMS.


#### Selectividades:

Por su parte, la selectividad de la flota indica que el recurso alcanza su completo reclutamiento a la pesquería a la edad de 1 año cuando su retención es del 100% aprox., mientras que los individuos de edad 0  son vulnerados un 70%. De igual forma, la información del crucero acústico de verano y otoño indican que todos los individuos son vulnerables en un 100% por el arte de pesca empleado (arrastre de media-agua y cubre-copo) y cubiertos por el diseño de muestreo (\textbf{Figura \ref{Fig36}}).
En esta actualización, la selectividad del crucero de otoño cambia respecto a la asesoría previa, registrando un mayor porcentaje de individuos de edad 0, con un 80% en la asesoría previa (marzo 2022) a un 100% de vulnerabilidad (julio 2022).  

### Puntos Biológicos de Referencia (PBRs)

En la \textbf{Tabla \ref{Tab21}} se muestran los valores calculados en la asesoría de septiembre 2021, marzo 2022 y julio 2022 de BD~0~, BD~RMS~, BD~LIM~ y F~RMS~, recomendados por el Comité Científico Técnicos de Pelágicos Pequeños (Informe Técnico CCT-PP N°01/2015) de acuerdo con la metodología discutida durante el segundo taller (Abril, 2014) y tercer taller (Agosto, 2014) de PBRs [@Paya2014]. El valor mediano de la mortalidad por pesca experimentado históricamente ($F_{mh}$) por el stock de sardina común centro-sur cercano a $F_{RMS}$ ($F_{57\%BDPR}$) un porcentaje bajo considerando los altos niveles de mortalidad por pesca que ha experimentado el stock (bajo el valor de mortalidad natural, M=1,0 año^-1^) (\textbf{Figura \ref{Fig37}}). Esto podría explicarse por la ubicación de la curva de selectividad respecto a la madurez, donde la selectividad se encuentra a la izquierda de la curva de madurez, producto de que la pesquería presenta una alta selección de juveniles, de manera que la selectividad de la flota comienza antes de la madurez (\textbf{Figura \ref{Fig38}}). Esta condición produciría valores de F60% más moderados, que aumentaría si la selectividad fuese igual a la madurez.



### Estado de explotación

La \textbf{Figura \ref{Fig39}} muestra que en el inicio de la serie histórica la biomasa indicaría una caída BD\<BD~RMS~ entre los años 1994 y 1995 producto probablemente de fallas sucesivas en los reclutamientos. El estado de la pesquería de sardina común durante los años 1998 y 2006 estuvo marcado por condiciones ambientales "El Niño" 1997-1998, provocando la caída hacia niveles inferiores de la biomasa desovante límite (BD~LIM~) bajo el cual una pesquería califica de agotada o colapsada. A partir del 2007 comienza un período favorable para la condición de sardina común, ingresando a un proceso de expansión poblacional que permite el año 2009 desplazarse hacia un nivel de biomasa desovante superior al BD~RMS~.  En la evaluación actual (julio 2022) la BD~2021/2022~ esperada está un 37% sobre BD~RMS~ (\textbf{Figura \ref{Fig39}}). La biomasa desovante está sustentada principalente por la fracción adulta, correspondiente a individuos de edad 1+, la cual disminuyó su abundancia producto de la disminución del reclutamiento de dos años previos consecutivos 2019 y 2020 junto a la disminución de la biomasa adulta (1+ años) el 2020, provocando que la biomasa desovante del año biológico 2020/2021 disminuyera significativamente respecto a años previos. No obstante, los altos reclutamientos registrados durante el 2021 permitirían retornar a  niveles de biomasa desovante sobre la biomasa objetivo para el año actual (2021/2022).  En términos de la mortalidad por pesca (Ft año^-1^), ésta se había mantenido por sobre el nivel objetivo de referencia F~RMS~ en prácticamente toda la serie histórica analizada, producto de la alta selección de juveniles capturados antes de que estos maduren (\textbf{Figura \ref{Fig39}}). La alta selectividad de juveniles conlleva a un valor de F~RMS~ (F60%BDPR) más moderado que una selectividad cercana o por sobre la ojiva de madurez. A partir del año 2013 los niveles de Ft se han mantenido bajo el nivel de referencia generado posiblemente por las caídas de los reclutamientos en algunos años y las bajas CBAs recomendadas luego de la implementación de los PBRs. Con respecto a la razón entre F~2021/22~ y F~RMS~ es de 0,42, en la asesoría previa (marzo 2022) se asumió un valor en torno a F~RMS~  para el año actual, a la espera de actualizar el valor de captura 2021/2022 en esta asesoría (julio 2022). Al respecto, se registraron capturas por debajo del RMS y por lo tanto, la mortalidad por pesca estimada con información actualizada es un 58% menor al supuesto utilizado en la asesoría previa (\textbf{Figura \ref{Fig39}}). 

La condición estimada con información preliminar para el año 2021/2022 indica que la sardina común se encuentra al límite de la subexplotación (37% sobre BD~RMS~ y 58% bajo F~RMS~), con un 2% de probabilidad de sobreexplotación y 0% de probabilidad de sobrepesca (\textbf{Tabla \ref{Tab22}}  y \textbf{Figura \ref{Fig40}}).

### Proyección del stock años biológicos 2021/2022 y 2022/2023 

La  proyección de la población se realizó 2 años biológicos hacia el futuro (julio 2021-junio 2022 y julio 2022-junio 2023) en base a tres escenarios de reclutamiento: a) un escenario desfavorable que consiste en el reclutamiento promedio del período 1991-2007 (114 mil millones de ind.), b) un escenario favorable que corresponde al promedio de los reclutamientos del período 2008 - 2012 (409 mil millones de ind.) y un escenario que representa el período reciente entre el 2013-2021 (180 mil millones de ind.) (\textbf{Figura \ref{Fig44as}}), con una mortalidad por pesca en torno al $F_{RMS}$ y pesos medios igual al promedio de los últimos 5 años. 

Las \textbf{Figuras \ref{Fig44as}} y \textbf{Tabla \ref{Tab25s}} indican que independiente del escenario de reclutamiento, en términos de biomasa desovante proyectada al 2021/2022 (755 mil t) se observa un incremento del 53% respecto al año previo 2020/2021 (492 mil t), de este modo la probabilidad de sobreexplotación disminuye a un 46% para el año biológico 2021/2022. Mientras que la biomasa desovante proyectada hacia el 2022/2023 depende del reclutamiento proyectado hacia el 2022 y 2023, la probabilidad de sobreexplotación puede disminuir a un 29% si los reclutamientos se encuentran en torno al promedio de los años recientes 2013-2021. Mientras que la probabilidad puede aumentar a un 90% si los reclutamientos son bajos (1991-2007) (\textbf{Tabla \ref{Tab25s}} y \textbf{Figura \ref{Fig44bs}}).

La \textbf{Tabla \ref{Tab26s}} muestra la  captura proyectada para los años biológicos 2021/2022 y 2022/2023 considerando una mortalidad por pesca igual al $F_{RMS}$, con sus respectivos escenarios de reclutamientos. El cálculo de la Captura al RMS ($C_{RMS}$) para el año calendario 2022 se obtiene como el promedio ponderado según la estacionalidad semestral de la pesquería que a la fecha se asume 70% para el primer semestre y 30% para el segundo semestre para el hito 1 del ciclo de manejo. De este modo, la captura al RMS para el año biológico 2021/2022  puede variar según el escenario de reclutamiento entre 302 mil t a 638 mil t. Si el 70% de la captura 2021/2022 se realiza durante el primer semestre 2022, la captura puede variar entre 221 mil t a 408 mil t, dependiendo del reclutamiento 2022. 
 
El aporte del reclutamiento en la estimación de captura 2021/2022 es de un 63% para un escenario de reclutamiento alto ($R_{2008-2012}$), de un 43% para un escenario de reclutamientos recientes ($R_{2013-2021}$) y de un 33% para un escenario de reclutamiento bajos ($R_{1991-2007}$) (\textbf{Figura \ref{Fig44cs}}). En el caso de la captura proyectada para el año 2022/2023, los escenarios de reclutamientos tienen un efecto en el grupo de edad 0 y 1, por lo tanto, es una estimación con mayor incertidumbre (\textbf{Figura \ref{Fig44cs}}). 


### CBA 2022 Inicial 

El cálculo de la CBA inicial para el año calendario 2022 se obtiene como el promedio ponderado según la estacionalidad semestral de la pesquería que a la fecha se asume 70% para el primer semestre y 30% para el segundo semestre, bajo un criterio de explotación de F60%SPR, sujeto a percentiles de probabilidad entre el 10% y 50%. La \textbf{Tabla \ref{Tab27s}} y \textbf{Figura \ref{Fig44ds}} muestran los rangos de capturas para el año 2022 estimada bajo un escenario de $R_{1991-2007}$ podría situarse entre 225 mil t y 302 mil t; bajo un escenario de $R_{2008-2012}$ entre 510 mil t y 637 mil t y, bajo un escenario de $R_{2013-2021}$ entre 277 mil t y 378 mil t. Considerando el descuento del 4% de descarte 2022, los rangos de capturas para el año 2022 estimada bajo un escenario de $R_{1991-2007}$ podría situarse entre 215 mil t y 290 mil t; bajo un escenario de $R_{2008-2012}$ entre 489 mil t y 612 mil t y, bajo un escenario de $R_{2013-2021}$ entre 266 mil t y 363 mil t. Para evaluar el efecto que tiene la decisión de la CBA en base a los percentiles (10%-50%) que en general son menores a la captura al RMS (percentil del 50%), se calculó el resguardo a lo cual equivale cada percentil (\textbf{Tabla \ref{Tab28s}}). Esos niveles variaron entre un 5% para un percentil del 40% hasta un 26% para un percentil de probabilidad del 10%, considerando tres escenarios de reclutamiento.


\pagebreak

# \Huge \textbf{FIGURAS} {-}

```{r Fig19, warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="\\label{Fig19}Datos de entrada al modelo de evaluación de stock de sardina común"}

setwd(dir.1)
years  <- rep1$years 
nyears <- dat1$nanos                                                                
x2      <-c(years,rev(years))
x1_2    <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2_2    <-c(years[1]-1,years[nyears]+1) #xlim

ydesembarques<-rep1$years[rep1$desembarqueobs>0]
yreclas      <-rep1$years[rep1$reclasobs>0]
ypelaces     <-rep1$years[rep1$pelacesobs>0]
ycompflota   <-rep1$years[rowSums(rep1$pf_obs)>0]
ycompreclas  <-rep1$years[rowSums(rep1$pobs_RECLAS)>0]
ycomppelaces <-rep1$years[rowSums(rep1$pobs_PELACES)>0]
ypesomedio   <-rep1$years[rowSums(dat1$Wmed)>0]
ypesoinicial <-rep1$years[rowSums(dat1$Wini)>0]

par(mfrow=c(1,1),mar=c(2,2,1,1)+0.5)
plot(years,rep(0,length(years)),type="n",ylim=c(0,9),ylab="",xlab="",xaxp=x1_2,axes=F,xlim=c(1991,2030.5),cex.axis=0.8)
abline(v=2023)
points(ydesembarques,rep(1,length(ydesembarques)),lwd=15,col=1)
points(yreclas,rep(2,length(yreclas)),lwd=15,col=2)
points(ypelaces,rep(3,length(ypelaces)),lwd=15,col=3)
points(ycompflota,rep(4,length(ycompflota)),lwd=15,col=4)
points(ycompreclas,rep(5,length(ycompreclas)),lwd=15,col=5)
points(ycomppelaces,rep(6,length(ycomppelaces)),lwd=15,col=6)
points(ypesomedio,rep(7,length(ypesomedio)),lwd=15,col=7)
points(ypesoinicial,rep(8,length(ypesoinicial)),lwd=15,col=8)

ejey<-c("Desembarques","Biom_Cru_verano","Biom_Cru_otoño","CompEdad Flota","CompEdad C.verano","CompEdad C.otoño","Peso medio Flota","Peso inicial Flota")

#legend()
axis(1,years,xaxp=x1_2)
text(rep(2027.5,8),1:8,ejey,cex=0.8)

box()



```


\pagebreak


```{r Fig20, warning=F, include=T, message=F, echo=F,fig.height=8,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig20}Serie de desembarques y biomasas estimadas por la evaluación hidroacústica de verano y otoño utilizadas como datos de entrada al modelo de evaluación de stock de sardina común de las Regiones de Valparaíso a Los Lagos. Los datos de desembarques se agrupan en año biológico. Los datos de cruceros representa al año calendario."}
 
des_obs <- data.frame(rep1$desembarqueobs)
bc_obs  <- data.frame(rep1$reclasobs)
bp_obs  <- data.frame(rep1$pelacesobs)
yearc   <- rep1$years 
nyearc  <-length(yearc)  

 obsC  <- as.data.frame(bc_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='2.Cruceros de Verano')
 obsP  <- as.data.frame(bp_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='3.Cruceros de Otoño')
 obsD  <- as.data.frame(des_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='1.Desembarques')
 Bcru  <-rbind(obsC,obsP,obsD)

p <- ggplot()  +
     geom_bar(data=Bcru, aes(x=year, y =value), stat="identity", fill='gray66',color = 'gray28') + 
     facet_wrap(~type,scale="free",dir = 'v', as.table = TRUE) + 
      labs(x="Años", y="Toneladas")
p +  theme(panel.background = element_rect(fill ="gray99")) + 
      theme(panel.grid=element_line(color="gray66"))



```


\pagebreak

```{r Fig21, warning=F, include=T, message=F,eval=T, echo=F,fig.height=4,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}

years    <- rep1$years 
nyears   <- length(years)
age      <- seq(0,4,1)                                            
nage     <- length(age)
WmedF    <- dat1$Wmed                                             
WiniF    <- dat1$Wini    
pobsF    <- rep1$pf_obs                                              

WmedF <- as.data.frame(WmedF) %>% 
                      mutate(years=years) %>% 
                      melt(id.vars='years') %>%             
                      mutate(edad = rep(age, each=nyears)) %>% 
                      mutate(type='WmedF')

pobsF <- as.data.frame(pobsF) %>% 
                      mutate(years=years) %>% 
                      melt(id.vars='years') %>%             
                      mutate(edad = rep(age, each=nyears)) %>% 
                      mutate(type='pobsF')


f1<-ggplot(pobsF, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 5)) +
  scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("FLOTA")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<-ggplot(WmedF, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Pesos medios (grs)',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 5)) +
  scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
   ggtitle("FLOTA")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5))

f1 + f2

```


```{r Fig22,warning=F, include=T, message=F, echo=F,fig.height=6,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig22}Variabilidad interanual de la proporción de la captura de la flota (panel izquierdo superior) y pesos medios (panel derecho superior) de cada grupo de edad (edad 0 a 4). Composición de edad de la captura de la flota (panel izquierdo inferior) y pesos medios (panel derecho inferior) utilizados en la evaluación de stock de sardina común de las Regiones de Valparaíso a Los Lagos."}
pobsF    <- rep1$pf_obs      
pF       <- c(pobsF); pF[pF==0]  <-NA
WmedF    <- dat1$Wmed    
Wm       <- c(WmedF); Wm[Wm==0]  <-NA     

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)

anos <- rep(years,length(age)) 
edad <- gl((length(age)),length(years),label=age)   

datosProp=data.frame(x=edad,y=anos,tamanio=pF)
datosWmed=data.frame(x=edad,y=anos,tamanio=Wm )

g1 <- ggplot (datosProp,aes(x,y)) +
     geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha = 0.7) +
     scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
     labs(x = 'Edades', y = 'Años',size="Proporción") +
     ggtitle("Proporción de edad de la Flota")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5))

g2 <- ggplot (datosWmed,aes(x,y)) + 
      geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha=0.7) +
      scale_size_continuous(breaks = seq(15,75,20),range=c(0,6))+
      labs(x = 'Edades', y = 'Años',size="Gramos") +
      ggtitle("Pesos medios de la Flota")+
      theme_bw(base_size=11) + 
      theme(plot.title = element_text(hjust = 0.5))

g1 + g2

```


\pagebreak

```{r Fig23, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)
pobsR1    <- rep1$pobs_RECLAS                                               
pobsP1    <- rep1$pobs_PELACES 


pobsR <- as.data.frame(pobsR1) %>% 
                       mutate(years=years) %>% 
                       melt(id.vars='years') %>%            
                       mutate(edad = rep(age, each=nyears)) %>% 
                       mutate(type='pobsR')

pobsP <- as.data.frame(pobsP1) %>% 
                       mutate(years=years) %>% 
                       melt(id.vars='years') %>%             
                       mutate(edad = rep(age, each=nyears)) %>% 
                       mutate(type='pobsP')


f1<-ggplot(pobsR, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 5)) +
    scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("CRUCERO DE VERANO")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<-ggplot(pobsP, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 5)) +
    scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("CRUCERO DE OTOÑO")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5))

f1 + f2

```

```{r Fig24,warning=F, include=T, message=F, echo=F,fig.height=6,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig24}Variabilidad interanual de la proporción de la captura del crucero de verano (panel izquierdo superior) y crucero de otoño (panel derecho superior) de cada grupo de edad (edad 0 a 4). Composición de edad de la captura de los cruceros de verano (panel izquierdo inferior) y otoño (panel derecho inferior) utilizados en la evaluación de stock."}
pobsR    <- rep1$pobs_RECLAS        
pR       <- c(pobsR); pR[pR==0]  <-NA
pobsP    <- rep1$pobs_PELACES      
pP       <- c(pobsP); pP[pP==0]  <-NA 

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)

anos <- rep(years,length(age)) 
edad <- gl((length(age)),length(years),label=age)   

datosPropR=data.frame(x=edad,y=anos,tamanio=pR)
datosPropP=data.frame(x=edad,y=anos,tamanio=pP )

g1 <- ggplot (datosPropR,aes(x,y)) +
     geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha = 0.7) +
     scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
     labs(x = 'Edades', y = 'Años',size="Proporción") +
     ggtitle("Cruceros de Verano")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5))

g2 <- ggplot (datosPropP,aes(x,y)) + 
      geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha=0.7) +
      scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
      labs(x = 'Edades', y = 'Años',size="Proporción") +
      ggtitle("Cruceros de otoño")+
      theme_bw(base_size=11) + 
      theme(plot.title = element_text(hjust = 0.5))

g1 + g2

```



\pagebreak



```{r Fig26,warning=F, include=T, message=F, echo=F,fig.show = "hide",fig.height=6.7,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig}

yrs   <- rep1$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvBcV   <-0.30
cvBcO   <-0.30
cvdes   <-0.01
#=================================================================================
ind_obs           <- cbind(c(rep1$reclasobs),
                           c(rep1$pelacesobs), 
                           c(rep1$desembarqueobs))
ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Crucero_verano', 
                       'Crucero_otoño', 
                       'Desembarques') 
#-----------------------------------------------------     
ind_sept           <- cbind(c(rep1$reclaspred), 
                            c(rep1$pelacespred), 
                            c(rep1$desembarquepred)) 
colnames(ind_sept) <- c('Crucero_verano', 
                        'Crucero_otoño', 
                        'Desembarques') 
#-----------------------------------------------------
ind_marzo           <- cbind(c(rep2$reclaspred),
                             c(rep2$pelacespred), 
                             c(rep2$desembarquepred)) 
colnames(ind_marzo) <- c('Crucero_verano', 
                         'Crucero_otoño', 
                         'Desembarques') 
#-----------------------------------------------------
ind_julio           <- cbind(c(rep3$reclaspred),
                             c(rep3$pelacespred), 
                             c(rep3$desembarquepred)) 
colnames(ind_julio) <- c('Crucero_verano', 
                         'Crucero_otoño', 
                         'Desembarques') 

#=================================================================================
ind               <- data.frame(ind_obs) %>%
                                mutate(Asesoria='observado') %>%
                                mutate (yrs= yrs) %>% 
                                melt(id.var=c('yrs', 'Asesoria'))  

sept               <- data.frame(ind_sept) %>% 
                                 mutate (Asesoria='septiembre_2022') %>%
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

marzo              <- data.frame(ind_marzo) %>% 
                                 mutate (Asesoria='marzo_2022') %>% 
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

julio              <- data.frame(ind_julio) %>% 
                                 mutate (Asesoria='julio_2022') %>% 
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

#=================================================================================
#base1 <- data.frame(rbind(ind, sept,marzo,julio))  
base1 <- data.frame(rbind(ind, sept))  
#=================================================================================

#GRÁFICOS

#=================================================================================

BcV <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_verano'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black')) +
       scale_colour_manual(values=c('black')) +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(ymin = value*exp(-1.96*cvBcO)*10^-6, ymax = value*exp(1.96*cvBcO)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2022, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de verano')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcP <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_otoño'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black'),name="Asesoría") +
       scale_colour_manual(values=c('black'),name="Asesoría") +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Asesoría")+
       scale_linetype_manual(values=c("solid"),name="Asesoría")+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(ymin = value*exp(-1.96*cvBcV)*10^-6, ymax = value*exp(1.96*cvBcV)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2022, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de otoño')+
       theme(plot.title = element_text(hjust = 0.5))

d   <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value/1000)) +
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black')) +
       scale_colour_manual(values=c('black')) +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value/1000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvdes)*10^-3, ymax = value*exp(1.96*cvdes)*10^-3), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (miles)') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques') +
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcV/BcP/d + plot_layout(guides="collect")

```
\pagebreak


```{r Fig_ajusteindices_sardcom,warning=F, include=T, message=F, fig.pos="h!", echo=F,fig.height=5.7,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig26}Ajustes del modelo anual en edades a los valores de biomasas de cruceros de verano, otoño y desembarques. Las barras corresponden al intervalo de confianza asintótico y el círculo al valor del estimador central. Los años de la serie de desembarques corresponden a año biológico."}

yrs   <- rep1$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvBcV   <-0.30
cvBcO   <-0.30
cvmph   <- 100
cvdes   <-0.01
#=================================================================================
ind_obs           <- cbind(c(rep1$reclasobs),
                           c(rep1$pelacesobs),
                           c(rep1$mphobs),
                           c(rep1$desembarqueobs))
ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Crucero_verano', 
                       'Crucero_otoño',
                       'Crucero_huevos',
                       'Desembarques') 
#-----------------------------------------------------     
ind_sept           <- cbind(c(rep1$reclaspred), 
                            c(rep1$pelacespred), 
                            c(rep1$mphpred),
                            c(rep1$desembarquepred)) 
colnames(ind_sept) <- c('Crucero_verano', 
                        'Crucero_otoño', 
                        'Crucero_huevos',
                        'Desembarques') 

#-----------------------------------------------------     
ind_marzo           <- cbind(c(rep2$reclaspred), 
                            c(rep2$pelacespred), 
                            c(rep2$mphpred),
                            c(rep2$desembarquepred)) 
colnames(ind_marzo) <- c('Crucero_verano', 
                        'Crucero_otoño', 
                        'Crucero_huevos',
                        'Desembarques') 
#-----------------------------------------------------     
ind_julio           <- cbind(c(rep3$reclaspred), 
                            c(rep3$pelacespred), 
                            c(rep3$mphpred),
                            c(rep3$desembarquepred)) 
colnames(ind_julio) <- c('Crucero_verano', 
                        'Crucero_otoño', 
                        'Crucero_huevos',
                        'Desembarques') 
#=================================================================================
ind               <- data.frame(ind_obs) %>%
                                mutate(Asesoria='observado') %>%
                                mutate (yrs= yrs) %>% 
                                melt(id.var=c('yrs', 'Asesoria'))  

sept               <- data.frame(ind_sept) %>% 
                                 mutate (Asesoria='sept2022') %>%
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

marzo               <- data.frame(ind_marzo) %>% 
                                 mutate (Asesoria='marzo2022') %>%
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

julio               <- data.frame(ind_julio) %>% 
                                 mutate (Asesoria='julio2022') %>%
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

#=================================================================================
#base1 <- data.frame(rbind(ind, sept,marzo,julio))  
base1 <- data.frame(rbind(ind, sept))  
#=================================================================================

#GRÁFICOS

#=================================================================================

BcV <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_verano'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black')) +
       scale_colour_manual(values=c('black')) +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(ymin = value*exp(-1.96*cvBcV)*10^-6, ymax = value*exp(1.96*cvBcV)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2022, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de verano')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcP <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_otoño'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black'),name="Sardina_común") +
       scale_colour_manual(values=c('black'),name="Sardina_común") +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Sardina_común")+
       scale_linetype_manual(values=c("solid"),name="Sardina_común")+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(ymin = value*exp(-1.96*cvBcO)*10^-6, ymax = value*exp(1.96*cvBcO)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2022, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de otoño')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcH <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_huevos'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black'),name="Sardina_común") +
       scale_colour_manual(values=c('black'),name="Sardina_común") +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Sardina_común")+
       scale_linetype_manual(values=c("solid"),name="Sardina_común")+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_huevos'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       #geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_huevos'),
       #aes(ymin = value*exp(-1.96*cvBcH)*10^-6, ymax = value*exp(1.96*cvBcH)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de huevos')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")


d   <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value/1000)) +
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       #scale_colour_manual(values=c('blue','red','black')) +
       scale_colour_manual(values=c('black')) +
       #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value/1000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvdes)*10^-3, ymax = value*exp(1.96*cvdes)*10^-3), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (miles)') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques') +
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

(BcV/BcP|BcH/d) + plot_layout(guides="collect")

```


\pagebreak

```{r datos_ajustes, echo=F }

# I. INDICES DE ABUNDANCIA                                                       #
years  <- dat1$Ind[,1]                                                              
nyears <- dat1$nanos                                                                
age    <- seq(0,4,1)                    
nage   <- dat1$nedades                                                            
Amax   <- dat1$nedades        
Age    <- seq(0,4,1) 
#Observado                                                                      
obsR <- rep1$reclasobs       ;obsR[obsR<=1] <-NA                                 
obsP <- rep1$pelacesobs      ;obsP[obsP<=1] <-NA                                 
obsM <- rep1$mphobs          ;obsM[obsM<=1] <-NA                                 
obsD <- rep1$desembarqueobs                                                      
#predicho                   #stdpredicho                                        
predR <- rep1$reclaspred             
predP <- rep1$pelacespred              
predM <- rep1$mphpred                         
predD <- rep1$desembarquepred                                                    
#Residuos                                                                       
Res_reclas   <- log(obsR)-log(predR)                                             
Res_Pelaces  <- log(obsP)-log(predP)                                             
Res_MPH      <- log(obsM)-log(predM)                                             
Res_Desemb   <- log(obsD)-log(predD)     

x  <- c(years,rev(years))
x1 <- c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <- c(years[1]-1,years[nyears]+1) #xlim

cvreclas <- rep(0.30,nyears)
cvpela   <- rep(0.30,nyears)
cvdes    <- rep(0.01,nyears)

obsR95i <- obsR*exp(-1.96*cvreclas)
obsR95s <- obsR*exp(1.96*cvreclas)
obsP95i <- obsP*exp(-1.96*cvpela)
obsP95s <- obsP*exp(1.96*cvpela)
obsD95i <- obsD*exp(-1.96*cvdes)
obsD95s <- obsD*exp(1.96*cvdes)
```

\pagebreak

```{r Fig_residuosIndices_sardcom,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=5.7,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig27}Residuales (escala log) del ajuste del modelo base actual a los datos de entrada. Línea azul y zona gris corresponden a un suavizador tipo Loess."}


yrs      <- rep1$years
ind_obs  <- cbind(rep1$reclasobs,
                  rep1$pelacesobs,
                  rep1$desembarqueobs); 

ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Biomasa_CReclas', 
                       'Biomasa_CPelaces',
                       'Desembarques') 

indm <- cbind(c(rep1$reclaspred), 
                  c(rep1$pelacespred),
                  c(rep1$desembarquepred))
colnames(indm) <- c('Biomasa_CReclas', 
                       'Biomasa_CPelaces',
                       'Desembarques') 

ind     <- data.frame(ind_obs) %>% 
           mutate(Asesoría='observado') %>% 
           mutate (yrs= yrs) %>% 
           melt(id.var=c('yrs', 'Asesoría'))  

marzo    <- data.frame(indm) %>% 
           mutate (Asesoría='base') %>%
           mutate (yrs= yrs)  %>% 
           melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, marzo))  


Res_matt <- data.frame(log(ind_obs) - log(indm)) %>% 
            mutate(yrs = yrs) %>% 
            mutate(Asesoría = 'base')

Res      <- rbind(Res_matt) %>%
            melt(id.vars= c('yrs','Asesoría'))
pred     <- base1 %>% 
            filter(Asesoría!='observado') %>% 
            mutate (pred = log(value))

predm    <- pred$pred
Res2     <- cbind(Res,predm)

###################################################################################################
r1   <- ggplot(Res, aes(yrs,value)) + 
        geom_bar(aes(fill=Asesoría), stat='identity', position='dodge') +
        geom_smooth()+
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2   <- ggplot(Res2, aes(predm,value)) + 
        geom_point(aes(colour=Asesoría), size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3   <- ggplot(Res, aes(value, colour=Asesoría)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4   <- ggplot(Res, aes(sample = value, colour = Asesoría)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=10)

r1.1  <-ggplot(filter(Res, Asesoría=='base'), aes(yrs,value)) + 
        geom_smooth()+
        geom_bar(stat='identity', position='dodge') +
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2.2  <-ggplot(filter(Res, Asesoría=='base'), aes(predm,value)) + 
        geom_smooth()+
        geom_point(size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3.3 <- ggplot(filter(Res, Asesoría=='base'), aes(value)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4.4 <- ggplot(filter(Res, Asesoría=='base'), aes(sample = value)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=9)

r1.1 + r2.2 + r4.4

```


\pagebreak

```{r Fig28,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig28}Ajuste del modelo base a las composiciones de edades de la flota de sardina común de las Regiones de Valparaíso a Los Lagos. Los años corresponden a año biológico."}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pf_obs)
etcf1_pre <- rbind(rep1$pf_pred)
etcf2_pre <- rep2$pf_pred 
etcf3_pre <- rep3$pf_pred 

 obs  <- as.data.frame(etcf1_obs) %>% 
                       mutate(year=years) %>% 
                       melt(id.vars='year') %>%
                       mutate(edad = rep(age, each=nyears)) %>%
                       mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% 
                            mutate(year=years) %>%
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>%
                            mutate(type='septiembre_2022')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>% 
                              mutate(year=years) %>%
                              melt(id.vars='year') %>%
                              mutate(edad = rep(age, each=nyears)) %>% 
                              mutate(type='marzo_2022')
 
  pred_julio <- as.data.frame(etcf3_pre) %>% 
                              mutate(year=years) %>%
                              melt(id.vars='year') %>%
                              mutate(edad = rep(age, each=nyears)) %>% 
                              mutate(type='julio_2022')
  
   
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
  
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + 
          labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'),
                    aes(x = edad, y = value, colour=type,linetype =type)) +
          #scale_colour_manual(values=c('blue','red','black'),name="Asesoría") +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Asesoría")+
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA") + theme(plot.title = element_text(size = 12))
  fig1
  
  
```
\pagebreak

```{r Fig29,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig29}Ajuste del modelo base a las composiciones de edades de los Cruceros de verano de sardina común de las Regiones de Valparaíso a Los Lagos."}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pobs_RECLAS)
etcf1_pre <- rbind(rep1$ppred_RECLAS) 
etcf2_pre <- rep2$ppred_RECLAS
etcf3_pre <- rep3$ppred_RECLAS

 obs  <- as.data.frame(etcf1_obs) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>%
                        mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>%
                            mutate(type='septiembre_2022')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>% 
                            mutate(type='marzo_2022')
 
 pred_julio <- as.data.frame(etcf3_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>% 
                            mutate(type='julio_2022')
  
 
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type,linetype =type)) +
          #scale_colour_manual(values=c('blue','red','black'),name="Asesoría") +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Asesoría")+
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("CRUCEROS DE VERANO") + theme(plot.title = element_text(size = 12))
  fig1
  
```

\pagebreak

```{r Fig30,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig30}Ajuste del modelo base a las composiciones de edades de los Cruceros de otoño de sardina común de las Regiones de Valparaíso a Los Lagos."}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pobs_PELACES)
etcf1_pre <- rbind(rep1$ppred_PELACES) 
etcf2_pre <- rep2$ppred_PELACES
etcf3_pre <- rep3$ppred_PELACES

 obs  <- as.data.frame(etcf1_obs) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>%
                        mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>% 
                        mutate(type='septiembre_2021')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>% 
                          mutate(year=years) %>% 
                          melt(id.vars='year') %>%
                          mutate(edad = rep(age, each=nyears)) %>% 
                          mutate(type='marzo_2022')
 
  pred_julio <- as.data.frame(etcf3_pre) %>% 
                          mutate(year=years) %>% 
                          melt(id.vars='year') %>%
                          mutate(edad = rep(age, each=nyears)) %>% 
                          mutate(type='julio_2022')
  
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
  
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type,linetype =type)) +
          #scale_colour_manual(values=c('blue','red','black'),name="Asesoría") +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          #scale_linetype_manual(values=c("solid", "longdash","dashed"),name="Asesoría")+
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("CRUCEROS DE OTOÑO") + theme(plot.title = element_text(size = 12))
  fig1
  
```

\pagebreak

```{r Fig31, echo=F, warning=F, include=T,fig.pos="h!", message=F,fig.height=5,fig.width=10,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig31}Residuales del modelo base actual a las composiciones de edades de la flota y cruceros. Subestimaciones (círculos negros) y sobreestimaciones (circulo blanco), donde el tamaño corresponde a la magnitud relativa de error por edad."}

ppredF<-rep1$pf_pred                                          
ppredR<-rep1$ppred_RECLAS                                     
ppredP<-rep1$ppred_PELACES

#DESEMBARQUES
anos <-dat1$Ind[,1] 
obsF <-pobsF
preF <-ppredF  
resF <-obsF-preF

rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,3),mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}

mtext("Flota",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
	mtext("a)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

# RECLAS
anos<-years[11:nyears]
obsR <-pobsR[11:nyears,]
preR <-ppredR[11:nyears,]
resR <-obsR-preR

rng <-range(resR,na.rm=T)
dd  <-dim(resR)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resR[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

#par(mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}
mtext("Crucero de verano",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
mtext("b)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

# PELACES
anos<-years[17:nyears]
obsP <-pobsP[17:nyears,]
preP <-ppredP[17:nyears,]  
resP <-obsP-preP

rng <-range(resP,na.rm=T)
dd  <-dim(resP)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resP[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

#par(mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}
mtext("Crucero de otoño",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
mtext("c)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

```


\pagebreak



```{r VariablesSept_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep1$years
nyears<-length(years)

Rt1      <- subset(std1,name=="Reclutas")$value 
Rt1std   <- subset(std1,name=="Reclutas")$std
BT1      <- subset(std1,name=="BT")$value   
BT1std   <- subset(std1,name=="BT")$std
BD1      <- subset(std1,name=="SSB")$value   
BD1std   <- subset(std1,name=="SSB")$std
Ft1      <- subset(std1,name=="log_Ft")$value   
Ft1std   <- subset(std1,name=="log_Ft")$std

VarPob<- data.frame(x=years,
                    Rt1=Rt1,
                    BT1=BT1,
                    BD1=BD1,
                    Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std),
         upperRt1 = (Rt1 +1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std),
         upperBT1 = (BT1 +1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), 
         upperBD1 = (BD1 +1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), 
         upperFt1 = exp(Ft1 +1.96*Ft1std))

```


```{r VariablesMarzo_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep2$years
nyears<-length(years)

Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std

VarPobMar<- data.frame(x=years,
                    Rt2=Rt2,
                    BT2=BT2,
                    BD2=BD2,
                    Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std),
         upperRt2 = (Rt2 +1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std),
         upperBT2 = (BT2 +1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), 
         upperBD2 = (BD2 +1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), 
         upperFt2 = exp(Ft2 +1.96*Ft2std))

```



```{r VariablesJulioo_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep3$years
nyears<-length(years)

Rt3      <- subset(std3,name=="Reclutas")$value 
Rt3std   <- subset(std3,name=="Reclutas")$std
BT3      <- subset(std3,name=="BT")$value   
BT3std   <- subset(std3,name=="BT")$std
BD3      <- subset(std3,name=="SSB")$value   
BD3std   <- subset(std3,name=="SSB")$std
Ft3      <- subset(std3,name=="log_Ft")$value   
Ft3std   <- subset(std3,name=="log_Ft")$std

VarPobJul<- data.frame(x=years,
                    Rt3=Rt3,
                    BT3=BT3,
                    BD3=BD3,
                    Ft3=exp(Ft3), 
         lowerRt3 = (Rt3 -1.96*Rt3std),
         upperRt3 = (Rt3 +1.96*Rt3std),
         lowerBT3 = (BT3 -1.96*BT3std),
         upperBT3 = (BT3 +1.96*BT3std),
         lowerBD3 = (BD3 -1.96*BD3std), 
         upperBD3 = (BD3 +1.96*BD3std),
         lowerFt3 = exp(Ft3 -1.96*Ft3std), 
         upperFt3 = exp(Ft3 +1.96*Ft3std))

```


```{r Fig32_data, eval=T, warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}

dir<-paste(dir.0,"/rep_AsesoriasPrevias",sep="")
setwd(dir)

sept18 <-paste(dir,"/MAE0918.rep",sep="")
mar19  <-paste(dir,"/MAE0319.rep",sep="")
jul19  <-paste(dir,"/MAE0719.rep",sep="")
sept19 <-paste(dir,"/MAE0919.rep",sep="")
mar20  <-paste(dir,"/MAE0320.rep",sep="")
jul20  <-paste(dir,"/MAE0720.rep",sep="")
sept20 <-paste(dir,"/MAE0920.rep",sep="")
mar21  <-paste(dir,"/MAE0321.rep",sep="")
jul21  <-paste(dir,"/MAE0721.rep",sep="")
sept21 <-paste(dir,"/MAE0921.rep",sep="")
mar22  <-paste(dir,"/MAE322.rep",sep="")
jul22  <-paste(dir.1,"/MAE722.rep",sep="")
#================================================================================#
rep_sept18 <- reptoRlist(sept18)
rep_mar19  <- reptoRlist(mar19)
rep_jul19  <- reptoRlist(jul19)
rep_sept19 <- reptoRlist(sept19)
rep_mar20  <- reptoRlist(mar20)
rep_jul20  <- reptoRlist(jul20)
rep_sept20 <- reptoRlist(sept20)
rep_mar21  <- reptoRlist(mar21)
rep_jul21  <- reptoRlist(jul21)
rep_sept21 <- reptoRlist(sept21)
rep_mar22  <- reptoRlist(mar22)
rep_jul22  <- reptoRlist(jul22)
#================================================================================#
years  <- rep_jul22$years
nyears <- length(years)                                                                
x  <-c(years,rev(years))
x1 <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <-c(years[1]-1,years[nyears]+1) #xlim

 Rtcomp <- data.frame(x=years,
                          Rt_sept18=c(rep_sept18$Reclutas,NA,NA,NA,NA),
                          Rt_mar19=c(rep_mar19$Reclutas,NA,NA,NA),
                          Rt_jul19=c(rep_jul19$Reclutas,NA,NA,NA),
                          Rt_sept19=c(rep_sept19$Reclutas,NA,NA,NA),
                          Rt_mar20=c(rep_mar20$Reclutas,NA,NA),
                          Rt_jul20=c(rep_jul20$Reclutas,NA,NA),
                          Rt_sept20=c(rep_sept20$Reclutas,NA,NA),
                          Rt_mar21=c(rep_mar21$Reclutas,NA),
                          Rt_jul21=c(rep_jul21$Reclutas,NA),
                          Rt_sept21=c(rep_sept21$Reclutas,NA),
                          Rt_mar22=c(rep_mar22$Reclutas),
                          Rt_jul22=c(rep_jul22$Reclutas))
 
 SSBtcomp <- data.frame(x=years,
                          SSBt_sept18=c(rep_sept18$SSB,NA,NA,NA,NA),
                          SSBt_mar19=c(rep_mar19$SSB,NA,NA,NA),
                          SSBt_jul19=c(rep_jul19$SSB,NA,NA,NA),
                          SSBt_sept19=c(rep_sept19$SSB,NA,NA,NA),
                          SSBt_mar20=c(rep_mar20$SSB,NA,NA),
                          SSBt_jul20=c(rep_jul20$SSB,NA,NA),
                          SSBt_sept20=c(rep_sept20$SSB,NA,NA),
                          SSBt_mar21=c(rep_mar21$SSB,NA),
                          SSBt_jul21=c(rep_jul21$SSB,NA),
                          SSBt_sept21=c(rep_sept21$SSB,NA),
                          SSBt_mar22=c(rep_mar22$SSB),
                          SSBt_jul22=c(rep_jul22$SSB))
 
 Ftcomp <- data.frame(x=years,
                          Ft_sept18=c(rep_sept18$Ftot,NA,NA,NA,NA),
                          Ft_mar19=c(rep_mar19$Ftot,NA,NA,NA),
                          Ft_jul19=c(rep_jul19$Ftot,NA,NA,NA),
                          Ft_sept19=c(rep_sept19$Ftot,NA,NA,NA),
                          Ft_mar20=c(rep_mar20$Ftot,NA,NA),
                          Ft_jul20=c(rep_jul20$Ftot,NA,NA),
                          Ft_sept20=c(rep_sept20$Ftot,NA,NA),
                          Ft_mar21=c(rep_mar21$Ftot,NA),
                          Ft_jul21=c(rep_jul21$Ftot,NA),
                          Ft_sept21=c(rep_sept21$Ftot,NA),
                          Ft_mar22=c(rep_mar22$Ftot),
                          Ft_jul22=c(rep_jul22$Ftot))
  
```


\pagebreak

```{r Fig32, echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=7,fig.pos="h!", fig.width=7,fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig32}Comparación con asesorías anteriores del reclutamiento, biomasa desovante y mortalidad por pesca ($F año^{-1}$) de la sardina común. Los años en el eje x corresponden a año biológico."}

year_retros <- c('2022_sept','2022_julio',"2022_marzo",'2021_sept',"2021_julio","2021_marzo","2020_sept","2020_julio","2020_marzo")
nretros <- 8


#Retrospectivo tradicional
Rt <- ggplot(Rtcomp) + 
    geom_ribbon(data=VarPob,aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=Rt_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=Rt_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=Rt_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=Rt_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=Rt_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=Rt_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    geom_line(aes(y=Rt_mar22, x=x, colour = year_retros[nretros-6]), size=0.5)+
    geom_line(aes(y=Rt_jul22, x=x, colour = year_retros[nretros-7]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c('purple','violet',"gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(SSBtcomp) + 
     geom_ribbon(data=VarPob,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=SSBt_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=SSBt_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=SSBt_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=SSBt_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=SSBt_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=SSBt_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    geom_line(aes(y=SSBt_mar22, x=x, colour = year_retros[nretros-6]), size=0.5)+
    geom_line(aes(y=SSBt_jul22, x=x, colour = year_retros[nretros-7]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c('purple','violet',"gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5))

Ft <- ggplot(Ftcomp) + 
    geom_ribbon(data=VarPob,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=Ft_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=Ft_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=Ft_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=Ft_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=Ft_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=Ft_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    geom_line(aes(y=Ft_mar22, x=x, colour = year_retros[nretros-6]), size=0.5)+
    geom_line(aes(y=Ft_jul22, x=x, colour = year_retros[nretros-7]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c('purple','violet',"gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=9) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft 


```


\pagebreak


```{r Dat_Retrospectivo, echo=F, message=FALSE, warning=FALSE, include=T,eval=T}
dir<-paste(dir.0,"/Retrospectivo_sept",sep="")
setwd(dir)
admb<-"MAE922"

years       <-rep1$years
nyears      <-length(years)
retros      <-seq(1,5)
nretros     <-length(retros)
year_retros <-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,i,".rep",sep=""))
  retroR[,i+1]  <- c(rep$Reclutas,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$SSB,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$Ftot,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j]   <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]        <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, 
                      y1=retroR[,2],
                      y2=retroR[,3],
                      y3=retroR[,4],
                      y4=retroR[,5],
                      y5=retroR[,6],
                      lower = (Rt1 -1.96*Rt1std), 
                      upper = (Rt1 +1.96*Rt1std))
BD_retro<- data.frame(x=years, 
                      y1=retroBD[,2],
                      y2=retroBD[,3],
                      y3=retroBD[,4],
                      y4=retroBD[,5],
                      y5=retroBD[,6],
                      lower = (BD1 -1.96*BD1std), 
                      upper = (BD1 +1.96*BD1std))
Ft_retro<- data.frame(x=years, 
                      y1=retroF[,2],
                      y2=retroF[,3],
                      y3=retroF[,4],
                      y4=retroF[,5],
                      y5=retroF[,6], 
                      lower = exp(Ft1 -1.96*Ft1std), 
                      upper = exp(Ft1 +1.96*Ft1std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, 
                         y1=rel.diff.r[,1],
                         y2=rel.diff.r[,2],
                         y3=rel.diff.r[,3],
                         y4=rel.diff.r[,4],
                         y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, 
                         y1=rel.diff.ssb[,1],
                         y2=rel.diff.ssb[,2],
                         y3=rel.diff.ssb[,3],
                         y4=rel.diff.ssb[,4],
                         y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, 
                         y1=rel.diff.f[,1],
                         y2=rel.diff.f[,2],
                         y3=rel.diff.f[,3],
                         y4=rel.diff.f[,4],
                         y5=rel.diff.f[,5])

```


\pagebreak

```{r Fig33, echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=10,fig.pos="h!", fig.width=10,fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig33}Patrón retrospectivo estándar (panel izquierdo) y relativo (panel derecho) de los reclutamientos, biomasa desovante y de la mortalidad por pesca de sardina común centro-sur para el modelo base actual. Los años en el eje x corresponden a año biológico."}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2021, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```



\pagebreak


```{r Fig_Vesorimilitud_Sardcomun,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=4,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig34}Perfiles de verosimilitud donde la línea horizontal representa el nivel crítico para el test $X^2$."}

dir<-paste(dir.0,"/Verosimilitud_sept",sep="")
setwd(dir)
admb<-"/MAE922"

casos <-23
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=15,nrow=casos)
slikeval <- matrix(ncol=16,nrow=casos)

#
for(i in 1:casos){
report      <- reptoRlist(paste(dir,admb,i,".rep",sep=""))
logRo[i]    <- report$log_Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)  

# busca el mínimo
for(i in 1:16){
  slikeval[,i]<-like[,i]-minLik[i]
  }    # Estandarización

names<-c("Ro","Bio_Reclas","Bio_Pelaces","Desembarques","Bio_Mph","C.Edad_Flota",
	"C.Edad_Recl","C.Edad_Pel","prepPelTall","DesvRt","qreclas","qpela","PenFt",
	"PenFspr","NA","NA","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2<- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names

Ro_reclas  <- TLk2$Ro[TLk2$Bio_Reclas==0]
Ro_pelaces <- TLk2$Ro[TLk2$Bio_Pelaces==0]
Ro_desemb  <- TLk2$Ro[TLk2$Desembarques==0]
Ro_MPDH    <- ifelse(sum(TLk2$Bio_Mph)>0,NA,TLk2$Ro[TLk2$Bio_Mph==0])
Ro_propF   <- TLk2$Ro[TLk2$C.Edad_Flota==0]
Ro_propRecl<- TLk2$Ro[TLk2$C.Edad_Recl==0]
Ro_propPel <- TLk2$Ro[TLk2$C.Edad_Pel==0]
Ro         <- TLk2$Ro[TLk2$Total==0]

names_res<-c("Bio_Reclas","Bio_Pelaces","Desembarques","Bio_MPDH","C.Edad_Flota","C.Edad_Reclas","C.Edad_Pelaces")
res<-c((Ro_reclas-Ro),
       (Ro_pelaces-Ro),
       (Ro_desemb-Ro),
       (Ro_MPDH-Ro),
       (Ro_propF-Ro),
       (Ro_propRecl-Ro),
       (Ro_propPel-Ro))

residuos<-res/Ro
#datares<-data.frame(names_res,residuos)


fig1<-ggplot() +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Bio_Reclas, colour=names[2])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Bio_Pelaces, colour=names[3])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Desembarques,colour=names[4])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Bio_Mph,colour=names[5])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$C.Edad_Flota,colour=names[6])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$C.Edad_Recl,colour=names[7])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$C.Edad_Pel,colour=names[8])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Total,colour=names[17])) +
      geom_hline(yintercept = 2,colour='black',lty=2) +
      scale_colour_manual("",values=c('cyan','magenta','gray',"orange","green","blue","red","black"))+
      coord_cartesian(xlim = c(30000, 210000), ylim = c(0, 3))+
      xlab("Ro") + 
      ylab("L-min(L)") + 
     ggtitle("Asesoría Septiembre 2022")+
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")
     


#fig<-ggplot(data = datares, aes(x = reorder(names_res,residuos), y = residuos)) +
#      ylim(-2, 3)+
#      geom_bar(stat = "identity",fill="azure3") +
#      coord_flip() + # Barras horizontales
#      xlab("") + 
#      ylab("Diferencia porcentual de Ro") + 
#      theme_bw(base_size=10) +
#     ggtitle("Sardina común")+
#      theme(plot.title = element_text(hjust = 0.5))
     
fig1

```


\pagebreak

<!-- Variables poblacionales-->

```{r Variables_sept, echo=F,message=FALSE, warning=FALSE, include=T}

years1<-rep1$years
nyears1<-length(years1)

Rt1      <- c(subset(std1,name=="Reclutas")$value) 
Rt1std   <- c(subset(std1,name=="Reclutas")$std)
BT1      <- c(subset(std1,name=="BT")$value)   
BT1std   <- c(subset(std1,name=="BT")$std)
BD1      <- c(subset(std1,name=="SSB")$value)   
BD1std   <- c(subset(std1,name=="SSB")$std)
Ft1      <- c(subset(std1,name=="log_Ft")$value)   
Ft1std   <- c(subset(std1,name=="log_Ft")$std)

VarPobSep<- data.frame(x=years1,
                       Rt1=Rt1,
                       BT1=BT1,
                       BD1=BD1,
                       Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std), upperRt1 = (Rt1+1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std), upperBT1 = (BT1+1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), upperBD1 = (BD1+1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), upperFt1 = exp(Ft1+1.96*Ft1std))
```



```{r Variables_marzo, echo=F,message=FALSE, warning=FALSE, include=T}

years2<-rep2$years
nyears2<-length(years2)

Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std

VarPobMar<- data.frame(x=years2, 
                       Rt2=Rt2,
                       BT2=BT2,
                       BD2=BD2,
                       Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), 
         upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std), 
         upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), 
         upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), 
         upperFt2 = exp(Ft2+1.96*Ft2std))
```


```{r Variables_julio, echo=F,message=FALSE, warning=FALSE, include=T}

years3   <- rep3$years
nyears3  <- length(years3)

Rt3      <- subset(std3,name=="Reclutas")$value 
Rt3std   <- subset(std3,name=="Reclutas")$std
BT3      <- subset(std3,name=="BT")$value   
BT3std   <- subset(std3,name=="BT")$std
BD3      <- subset(std3,name=="SSB")$value   
BD3std   <- subset(std3,name=="SSB")$std
Ft3      <- subset(std3,name=="log_Ft")$value   
Ft3std   <- subset(std3,name=="log_Ft")$std

VarPobJul<- data.frame(x=years3, 
                       Rt3=Rt3,
                       BT3=BT3,
                       BD3=BD3,
                       Ft3=exp(Ft3), 
         lowerRt3 = (Rt3 -1.96*Rt3std), 
         upperRt3 = (Rt3 +1.96*Rt3std),
         lowerBT3 = (BT3 -1.96*BT3std), 
         upperBT3 = (BT3 +1.96*BT3std),
         lowerBD3 = (BD3 -1.96*BD3std), 
         upperBD3 = (BD3 +1.96*BD3std),
         lowerFt3 = exp(Ft3 -1.96*Ft3std), 
         upperFt3 = exp(Ft3 +1.96*Ft3std))
```


\pagebreak

```{r Fig35, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6,fig.pos="h!", fig.width=8,fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig35}Estimaciones medias de los reclutamientos (R), biomasa total (BT), biomasa desovante (BD) y  mortalidad por pesca (F) y su respectivo Intervalo de Confianza (IC). Las línea segmentada corresponde al promedio y mediana de la serie respectiva. Los años en el eje x corresponden a año biológico."}


Rt <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Rt3, x=x, colour = "julio 2022"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Rt2, x=x, colour = "marzo 2022"),linetype="dashed",size=0.5)+
    geom_line(data=VarPobSep,aes(y=Rt1, x=x, colour = "septiembre 2022"),linetype="solid", size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerRt3, ymax=upperRt3, x=x, fill = "IC"), alpha = 0.2)+
    #geom_ribbon(data=VarPobMar,aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = "IC"), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_hline(yintercept = mean(VarPobMar$Rt2),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(VarPobMar$Rt2)*1.3,label=expression("R"[promedio])) +
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70","grey60"))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
    theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=7))

BT <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BT3, x=x, colour = "julio 2022"),linetype="solid", size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BT2, x=x, colour = "marzo 2022"),linetype="dashed", size=0.5)+
     geom_line(data=VarPobSep,aes(y=BT1, x=x, colour = "septiembre 2022"),linetype="solid", size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = ""), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = ""), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(data=VarPobSep,yintercept = mean(BT1),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(BT1)*1.2,label=expression("BT"[promedio])) +
    labs(x = '', y = 'Biomasa total (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70","grey60"))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BD3, x=x, colour = "julio 2022"),linetype="solid", size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BD2, x=x, colour = "marzo 2022"),linetype="dashed", size=0.5)+
     geom_line(data=VarPobSep,aes(y=BD1, x=x, colour = "septiembre 2022"),linetype="solid", size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "IC"), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "IC"), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(data=VarPobSep,yintercept = mean(BD1),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(BD1)*1.3,label=expression("BD"[promedio])) +
     labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
      #scale_colour_manual("",values=c('blue','red','black'))+
      #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
      #scale_fill_manual("",values=c("grey80","grey70","grey60"))+
      scale_colour_manual("",values=c('black'))+
      scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=7))

Ft <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Ft3, x=x, colour = "julio 2022"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Ft2, x=x, colour = "marzo 2022"),linetype="dashed", size=0.5)+
    geom_line(data=VarPobSep,aes(y=Ft1, x=x, colour = "septiembre 2022"),linetype="solid", size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
    #geom_ribbon(data=VarPobMar,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(yintercept = median(VarPobSep$Ft1),colour='black',lty=2) +
     annotate("text", x=2018, y=median(VarPobSep$Ft1)*1.3,label=expression("F"[mediana])) +
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70","grey60"))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=9) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | (BD/Ft)

```

\pagebreak



```{r Fig36,warning=F, include=T, message=F, echo=F,fig.height=3.5,fig.width=3.5,fig.pos="h!",fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig36}Patrón de explotación o selectividad de la flota y de los cruceros acústicos de sardina común de las Regiones de Valparaíso a Los Lagos."}

sel_Flota<-rep1$Sel_flota[1,]
sel_CruV <-rep1$Sel_reclas[1,]
sel_CruO <-rep1$Sel_pelaces[1,]

g1 <- ggplot () +
     lims(y=c(0,1))+
     #lineas
     geom_line(aes(x=age,y=sel_Flota))+
     geom_line(aes(x=age,y=sel_CruV))+
     geom_line(aes(x=age,y=sel_CruO),linetype="dashed")+
     #puntos
     geom_point(aes(x=age,y=sel_Flota,shape="FLota"),size=2.5) +
     geom_point(aes(x=age,y=sel_CruV,shape="Cruceros de Verano"),size=2.5) +
     geom_point(aes(x=age,y=sel_CruO,shape="Cruceros de Otoño"),size=2.5) +
     #parámetros
     labs(x = 'Edad (años)', y = 'Patrón de explotación',shape="Selectividades") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))
g1

```

\pagebreak


```{r Fig37,warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=9,fig.pos="h!",fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig37}Series de Biomasa desovante y mortalidad por pesca junto a los PBRs calculados a partir de la BD promedio y mediana de F ($F_{mh}$). Los años en el eje x corresponden a año biológico."}

BD <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BD3, x=x, colour = "julio 2022"), linetype="solid",size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BD2, x=x, colour = "marzo 2022"), linetype="dashed",size=0.5)+
     geom_line(data=VarPobSep,aes(y=BD1, x=x, colour = "sept 2022"), linetype="solid",size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "IC"), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "IC"), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = c(BRMS1,BLIM1,Bo1,Bmed1),colour=c('green3','red','blue','black'))+
     annotate("text", x=c(rep(2000,3),2012), y=c(BRMS1*1.1,BLIM1*1.1,Bo1*1.1,Bmed1*1.1),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]),expression("BD"[promedio]))) +
     labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1960, to = 2022, by = 3)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70",'gray60'))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c('gray60'))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=7))

Ft <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Ft3, x=x, colour = "julio 2022"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Ft2, x=x, colour = "marzo 2022"), linetype="dashed",size=0.5)+
    geom_line(data=VarPobSep,aes(y=Ft1, x=x, colour = "sept 2022"), linetype="solid",size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = "IC"), alpha = 0.2)+
    #geom_ribbon(data=VarPobMar,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = "IC"), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = c(FRMS1,median(VarPobSep$Ft1)),colour=c('green3','black')) +
     annotate("text", x=c(2016,2003), y=c(FRMS1*1.02, median(exp(ln_Fyr1)))*1.2, label=c(expression("F"[RMS]), expression("F"[mh]))) +
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2022, by = 3)) +
    #scale_colour_manual("",values=c('blue','red','black'))+
    #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
    #scale_fill_manual("",values=c("grey80","grey70",'gray60'))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c('gray60'))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD + Ft

```




```{r Fig38,warning=F, include=T, message=F, echo=F,fig.height=3.5,fig.width=7.5,fig.pos="h!",fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig38}Madurez, selectividad (Panel izquierdo) y Curva de Biomasa por Recluta (\\%BDPR) (Panel derecho), utilizados en los cálculos de $F_{RMS}$."}

sel_Flota <- rep1$Sel_flota[1,]
madurez   <- dat1$madurezsexual
Fspr      <- SPRcurv1[,1]
BDspr     <- SPRcurv1[,4]

g1 <- ggplot () +
     #lineas
     geom_line(aes(x=age,y=sel_Flota))+
     geom_line(aes(x=age,y=madurez),linetype="dashed")+
     #puntos
     geom_point(aes(x=age,y=sel_Flota,shape="Selectividad de la flota"),size=2.5) +
     geom_point(aes(x=age,y=madurez,shape="Madurez sexual"),size=2.5) +
     #parámetros
     labs(x = 'Edad (años)', y = 'Madurez y selectividad',shape="") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))


g2 <- ggplot () +
     geom_line(aes(x=Fspr,y=BDspr))+
     geom_hline(yintercept = 0.6,colour=c('gray35'),linetype="dashed") +
     geom_vline(xintercept = FRMS1,colour=c('gray35'),linetype="dashed") +
     annotate("text", x=2, y=0.6+0.02,label=c(expression("F"[RMS]))) +
     labs(x = 'Mortalidad por pesca (F)', y = '%BDPR',shape="") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))
g1 + g2
```



\pagebreak


```{r Fig39,warning=F, include=T, message=F, echo=F,fig.height=6.5,fig.width=8,fig.pos="h!",fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig39}a) Razón $BD/BD_{RMS}$, b) la distribución de probabilidad de $BD_{last}/BD_{RMS}$, c) razón $F/F_{RMS}$ y d) la distribución de probabilidad $F_{last}/F_{RMS}$. Los años en el eje x corresponden a año biológico."}

BD_BDrms <- ggplot() + 
     #geom_line(data=EstatusJul,aes(y=Rpr3, x=x, colour = "julio 2022"), linetype="solid", size=0.5)+
     #geom_line(data=EstatusMar,aes(y=Rpr2, x=x, colour = "marzo 2022"), linetype="dashed",size=0.5)+
     geom_line(data=EstatusSep,aes(y=Rpr1, x=x, colour = "sept 2022"), linetype="solid",size=0.5)+
     #geom_ribbon(data=EstatusJul,aes(ymin=lowerRpr3, ymax=upperRpr3, x=x, fill = "IC"), alpha = 0.2)+
     #geom_ribbon(data=EstatusMar,aes(ymin=lowerRpr2, ymax=upperRpr2, x=x, fill = "IC"), alpha = 0.2)+
     geom_ribbon(data=EstatusSep,aes(ymin=lowerRpr1, ymax=upperRpr1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = c(1,0.5),colour=c('green3','red'))+
     annotate("text", x=c(2012,2012), y=c(1,0.5)+0.06,
              label=c(expression("BD"[RMS]),expression("BD"[LIM]))) +
     labs(x = '', y = expression("BD/BD"[RMS]),colour='Asesorías',tag="a)")  +
     scale_x_continuous(breaks = seq(from = 1960, to = 2062, by = 3)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70",'gray60'))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c('gray60'))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")


F_Frms <- ggplot() + 
    #geom_line(data=EstatusJul,aes(y=Frpr3, x=x, colour = "julio 2022"), linetype="solid",size=0.5)+
    #geom_line(data=EstatusMar,aes(y=Frpr2, x=x, colour = "marzo 2022"), linetype="dashed",size=0.5)+
    geom_line(data=EstatusSep,aes(y=Frpr1, x=x, colour = "sept 2022"), linetype="solid",size=0.5)+
    #geom_ribbon(data=EstatusJul,aes(ymin=lowerFrpr3, ymax=upperFrpr3, x=x, fill = "IC"), alpha = 0.2)+
    #geom_ribbon(data=EstatusMar,aes(ymin=lowerFrpr2, ymax=upperFrpr2, x=x, fill = "IC"), alpha = 0.2)+
    geom_ribbon(data=EstatusSep,aes(ymin=lowerFrpr1, ymax=upperFrpr1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = 1,colour=c('green3')) +
     annotate("text", x=2012, y=1+0.25,label=c(expression("F"[RMS]))) +
    labs(x = '', y = expression("F/F"[RMS]),colour='Asesorías',tag="c)")  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2062, by = 3)) +
     #scale_colour_manual("",values=c('blue','red','black'))+
     #scale_linetype_manual(values=c("solid", "longdash","dashed"))+
     #scale_fill_manual("",values=c("grey80","grey70",'gray60'))+
     scale_colour_manual("",values=c('black'))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c('gray60'))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

fig_desnb<- ggplot() + lims(y=c(0,4)) +
     #geom_polygon(data=densb_bj,aes(x=x, y=y, group=t,alpha=0.9),fill="gray80")+
     #geom_polygon(data=densb_bm,aes(x=x, y=y, group=t,alpha=0.9),fill="gray70")+
     geom_polygon(data=densb_bs,aes(x=x, y=y, group=t,alpha=0.9),fill="gray55")+
     #geom_line(aes(xbj,ybj), size=0.3,color="blue",linetype="solid")+
     #geom_line(aes(xbm,ybm), size=0.3,color="red",linetype="dashed")+
     geom_line(aes(xbs,ybs), size=0.3,color="black",linetype="solid")+
     annotate("text", x=c(1.2), y=c(3.9), colour = c("black"), size = 2.5,
              label=c(paste("IC95%_sept2022 = [",round(icbs[1],3),"-",round(icbs[2],3),"]",sep=" "))) +
     labs(x = expression("BD"[last]*"/BD"[RMS]), y = 'Densidad de probabilidad',tag="b)")  +
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

fig_desnf<- ggplot() + lims(y=c(0,4.5))+
     #geom_polygon(data=densb_fj,aes(x=x, y=y, group=t,alpha=0.9),fill="gray80")+
     #geom_polygon(data=densb_fm,aes(x=x, y=y, group=t,alpha=0.9),fill="gray70")+
     geom_polygon(data=densb_fs,aes(x=x, y=y, group=t,alpha=0.9),fill="gray55")+
     #geom_line(aes(xfj,yfj), size=0.3,color="blue",linetype="solid")+
     #geom_line(aes(xfm,yfm), size=0.3,color="red",linetype="dashed")+
     geom_line(aes(xfs,yfs), size=0.3,color="black",linetype="solid")+
     annotate("text", x=c(1.2), y=c(4.4), colour = c("black"), size = 2.5,
              label=c(paste("IC95%_sept2022  = [",round(icfs[1],3),"-",round(icfs[2],3),"]",sep=" "))) +
     labs(x = expression("F"[last]*"/F"[RMS]), y = 'Densidad de probabilidad',tag="d)")  +
     theme_bw(base_size=9) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


 {(BD_BDrms / F_Frms)   | (fig_desnb/fig_desnf)} +  plot_layout(ncol=2,widths=c(2,1))
 

```



```{r Fig40, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.pos="h!",fig.align="center",fig.path=dir.Fig,dev=fig,fig.cap="\\label{Fig40}Diagrama de fases de explotación de la biomasa desovante respecto de la mortalidad por pesca de la asesoría de septiembre 2022. Los ejes están estandarizados a los valores que generan el RMS proxy. Cruz azul corresponde a los intervalos de confianza de la razón $BD/BD_{RMS}$ y $F/F_{RMS}$. El año con cruz continua corresponde a \textit{Estatus completo}"}

source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name1<-"Asesoría de Septiembre 2022"
years1<-rep1$years
nyears1<-length(years1)

DiagramaFase2(name1,
             years1[1:nyears1-1],
             SpB1[1:nyears1-1],
             SpBSE1[1:nyears1-1],
             ln_Fyr1[1:nyears1-1],
             ln_FSE1[1:nyears1-1],
             SpB1[nyears1],
             SpBSE1[nyears1],
             ln_Fyr1[nyears1],
             ln_FSE1[nyears1],
             FRMS1,
             BRMS1,
             BLIM1,
             FLIM1,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=F,
             completo=T)

text(c(SpB1[1]/BRMS1,
       SpB1[nyears1]/BRMS1,
       SpB1[nyears1-1]/BRMS1),
     c(exp(ln_Fyr1[1])/FRMS1-0.05,
       exp(ln_Fyr1[nyears1])/FRMS1-0.05,
       exp(ln_Fyr1[nyears1-1])/FRMS1+0.05),
     c("1990/91","2021/22","2020/21"),cex=0.8)

```

<!--- Este estatus se cambia a eval=T para la asesoría de marzo -->

```{r Fig41, eval=F, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name2<-"Asesoría de Marzo 2022"
years2<-rep2$years
nyears2<-length(years2)

DiagramaFase2(name2,
             years2[1:nyears2-1],
             SpB2[1:nyears2-1],
             SpBSE2[1:nyears2-1],
             ln_Fyr2[1:nyears2-1],
             ln_FSE2[1:nyears2-1],
             SpB2[nyears2],
             SpBSE2[nyears2],
             ln_Fyr2[nyears2],
             ln_FSE2[nyears2],
             FRMS2,
             BRMS2,
             BLIM2,
             FLIM2,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=T,
             completo=F)

text(c(SpB2[1]/BRMS2,
       SpB2[nyears2]/BRMS2,
       SpB2[nyears2-1]/BRMS2),
     c(exp(ln_Fyr2[1])/FRMS2-0.05,
       exp(ln_Fyr2[nyears2])/FRMS2-0.05,
       exp(ln_Fyr2[nyears2-1])/FRMS2+0.05), 
     c("1990/91","2021/22","2020/21"),cex=0.8)

```


<!--- Este gráfico se utiliza para la sección de metodología, para hacer generarlo se debe cambia a eval=T -->

```{r statusMetodology, eval=F, warning=F, include=T, message=F, echo=F,fig.height=6,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name2<-""
years2<-rep2$years
nyears2<-length(years2)

DiagramaFase2(name2,
             years2[1:nyears2-1],
             SpB2[1:nyears2-1],
             SpBSE2[1:nyears2-1],
             ln_Fyr2[1:nyears2-1],
             ln_FSE2[1:nyears2-1],
             SpB2[nyears2],
             SpBSE2[nyears2],
             ln_Fyr2[nyears2],
             ln_FSE2[nyears2],
             FRMS2,
             BRMS2,
             BLIM2,
             FLIM2,
             color=F,
             dir.1,
             etiqueta=T,
             preliminar=T,
             completo=F)



```

<!--- Este estatus se cambia a eval=T para la asesoría de julio -->


```{r Fig41b, eval=F, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name3<-"Asesoría de Julio 2022"
years3<-rep3$years
nyears3<-length(years3)

DiagramaFase2(name3,
             years3[1:nyears3-1],
             SpB3[1:nyears3-1],
             SpBSE3[1:nyears3-1],
             ln_Fyr3[1:nyears3-1],
             ln_FSE3[1:nyears3-1],
             SpB3[nyears3],
             SpBSE3[nyears3],
             ln_Fyr3[nyears3],
             ln_FSE3[nyears3],
             FRMS3,
             BRMS3,
             BLIM3,
             FLIM3,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=F,
             completo=T)

text(c(SpB3[1]/BRMS3,SpB3[nyears3]/BRMS3,SpB3[nyears3-1]/BRMS3),
     c(exp(ln_Fyr3[1])/FRMS3-0.05,exp(ln_Fyr3[nyears3])/FRMS3-0.05,exp(ln_Fyr3[nyears3-1])/FRMS3+0.05), c("1990/91","2020/21","2019/20"),cex=1.2)

```


\pagebreak



```{r Fig34a, warning=F, include=T, message=F,eval=T,fig.pos="h!", echo=F,fig.height=7,fig.width=9,fig.align="center",fig.path="Figuras/",dev=fig,fig.cap="\\label{Fig44as}Proyección de dos años biológicos (2021/2022 y 2022/2023) de la biomasa desovante, razón $BD/BD_{RMS}$ y capturas en base a tres escenarios de reclutamiento proyectado. Asesoría de septiembre 2022"}


par(mfrow=c(2,2),mar=c(4,4,1,1)+0.5)
yearProy<-c(2022,2023)

#=======================================================
# plot reclutamientos 
plot(c(reps1a$years,yearProy),c(reps1a$Reclutas,NA,NA),type="o",
     ylab="Reclutamientos",xlab="Años",main="",
     cex.axis=1,cex.main=1,cex.lab=1,xlim=c(1991,2025),pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps2a$Np[1],
        reps2a$Np[1]),type="o",col=2,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps3a$Np[1],
        reps3a$Np[1]),type="o",col=3,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps1a$Np[1],
        reps1a$Np[1]),type="o",col=4,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        NA,
        NA),type="o",col=1,pch=19)

abline(h=c(reps1a$Np[1],
           reps2a$Np[1],
           reps3a$Np[1]),
       col=c(4,2,3))

text(2025,c(reps1a$Np[1],
            reps2a$Np[1],
            reps3a$Np[1])+15000,
     round(c(reps1a$Np[1]/1000,
             reps2a$Np[1]/1000,
             reps3a$Np[1]/1000),0),cex=0.7)
#text(2024,550000,"a)")
#=======================================================
# plot Biomasa desovante
plot(c(rep1$years,yearProy),
     c(rep1$SSB,bds3),
     type="o",ylab="Biomasa desovante (t)",xlab="Años",col=3,
     xlim=c(1991,2025),pch=19,main="")

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds2),
      type="o",col=2,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds1),type="o",col=4,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,c(NA,NA)),type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
legend(2000,2000000,c("Reclprom 1991-2007",
                      "Reclprom 2008-2012",
                      "Reclprom 2013-2021"),pch=19,lwd=1,col=c(4,2,3),bty="n")
#text(2024,2000000,"b)")

#=======================================================
# plot bd/BDrms
plot(c(rep1$years,yearProy),
     c(rep1$SSB,bds3)/BRMS1,
     type="o",ylab="BD/BDrms",col=3,xlab="Años",pch=19,xlim=c(1991,2025),ylim=c(0,3.1))

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds2)/BRMS1,
      type="o",col=2,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds1)/BRMS1,
      type="o",col=4,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,c(NA,NA))/BRMS1,
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)
abline(h=0.5,lty=2,col=2)
#text(2024,3,"c)")

#=======================================================
# plot capturas proyectadas
plot(c(rep1$years,yearProy),
     c(rep1$desembarquepred,cs3),type="o",
     ylab="Capturas (t)",col=3,xlab="Años",pch=19,xlim=c(1991,2025))

lines(c(rep1$years,yearProy),
      c(rep1$desembarquepred,cs2),
      type="o",col=2,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$desembarquepred,cs1),
      type="o",col=4,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$desembarquepred,c(NA,NA)),
      type="o",col=1,pch=19)


abline(v=yearProy[1]-1,lty=2)
#text(2024,820000,"d)")

```



<!-- Proyección del stock (Asesoría de septiembre) -->



```{r Tabla_32a,eval=F, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_sept("MAE922",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")
```

```{r Tabla_32b,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_sept("MAE922",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")

```

```{r Tabla_32c,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_sept("MAE922",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")
```

```{r DF_proysept, eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_sept/",sep=""))

admb_sept<-"MAE922"
data1        <- lisread(paste(admb_sept,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data
rep1         <- reptoRlist(paste(admb_sept,".rep",sep=""))
std1         <- read.table(paste(admb_sept,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep1$years                                                              
nyears     <- length(years)   
Bo         <- rep1$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep1$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep1$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep1$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std1,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std1,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std1,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std1,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std1,name=="log_Ft")$value)

```

```{r Fig45a_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(11,21,31)
admb_sept<-"MAE922"

for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$value   
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
     c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
      pch=19,col=c(2,2),cex=c(1,1))

text((SpBp/BRMS),
    c(Frmsp/FRMS-0.07),
    c("2021/22","2022/23"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)
text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)

```

```{r Fig45b_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(12,22,32)
admb_sept<-"MAE922"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
      c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22","2022/23"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 2008-2012"
#nesc<-c(12,22,32)
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```

```{r Fig45c_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(13,23,33)
admb_sept<-"MAE922"

for(i in 1:n){
name<-escR[3]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
      c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22","2022/23"),
     cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#nesc<-c(13,23,33)
#name<-"Reclprom 2013-2020"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```




```{r Fig42,  warning=F, include=T, message=F, eval=F, echo=FALSE,fig.height=3,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
library(strucchange)
years1<-rep1$years
nyears1<-length(years1)
bp.nile <- breakpoints(rep1$Reclutas/1000 ~ 1)
fm0 <- lm(rep1$Reclutas/1000 ~ 1)
fm1 <- lm(rep1$Reclutas/1000 ~ breakfactor(bp.nile, breaks = 2))
quiebres3<-fitted(fm1)

par(mfrow=c(1,1),mar=c(2,4,1,1))
plot(years1,rep1$Reclutas/1000,type="l",lty=2,pch=19,ylim=c(0,700),
     xaxp=c(1990,2020,30),yaxs="i",xlab="",ylab="Reclutamientos (miles de millones de ind.)",main="Escenarios de reclutamiento proyectado",cex.main=0.8,cex.axis=0.8,cex.lab=0.8)
points(years1,rep1$Reclutas/1000,col=1,pch=19)
lines(years1,quiebres3,lwd=2,col=4)
text(c(1999,2010,2017),c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23])+20,round(c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23]),0),col=2,font=1,cex=0.8)

```

\pagebreak



```{r Fig27_CBA,warning=F, include=T, message=F,fig.pos="h!", echo=F,fig.height=5,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf'),fig.cap="\\label{Fig44cs}Captura 2021/2022 y 2022/2023 a la edad bajo tres escenarios de reclutamiento proyectado en el hito 1. Asesoría Septiembre 2022."}

dira<-paste(dir.0,"/CBA_sept",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE92211.rep")  
reps2a     <- reptoRlist("MAE92212.rep") 
reps3a     <- reptoRlist("MAE92213.rep") 

#===============================================================================================================
# escenario 1
#===============================================================================================================
xca1 <-rnorm(1000, mean = CBAp_sept[1], 
                   sd   = CBApstd_sept[1])

xca  <-seq(min(xca1),max(xca1),0.5)

yca  <-dnorm(xca, mean = CBAp_sept[1],
                  sd   = CBApstd_sept[1])

icca <-qnorm(c(0.1,0.5,0.5),CBAp_sept[1],CBApstd_sept[1])

xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],
         rev(xca[xca>=icca[1]&xca<=icca[2]]))

yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],
         rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))
#===============================================================================================================
# escenario 2
#===============================================================================================================
xcb1 <-rnorm(1000, mean = CBAp_sept[2], 
                   sd   = CBApstd_sept[2])

xcb  <-seq(min(xcb1),max(xcb1),0.5)

ycb  <-dnorm(xcb, mean = CBAp_sept[2], 
                  sd   = CBApstd_sept[2])

iccb <-qnorm(c(0.1,0.5,0.5),
             CBAp_sept[2],
             CBApstd_sept[2])

xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],
         rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))

yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],
         rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))
#===============================================================================================================
# escenario 3
#===============================================================================================================
xcc1 <-rnorm(1000, mean = CBAp_sept[3], 
                   sd   = CBApstd_sept[3])

xcc  <-seq(min(xcc1),max(xcc1),0.5)

ycc  <-dnorm(xcc, mean = CBAp_sept[3], 
                  sd   = CBApstd_sept[3])

iccc <-qnorm(c(0.1,0.5,0.5),
             CBAp_sept[3],
             CBApstd_sept[3])

xxcc <-c(xcc[xcc>=iccc[1]&xcc<=iccc[2]],
         rev(xcc[xcc>=iccc[1]&xcc<=iccc[2]]))

yycc <-c(ycc[xcc>=iccc[1]&xcc<=iccc[2]],
         rep(0,length(ycc[xcc>=iccc[1]&xcc<=iccc[2]])))


par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot captura a la talla
plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[1,],type="h",main="Año 2021/2022",lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura  a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')
lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[1,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[1,],type="h",col='blue2',lwd=10)
text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[1,1],reps2a$YTP_p0W_proyectada[1,1],reps3a$YTP_p0W_proyectada[1,1]),c('33%','63%','43%'))
text(4,380000,'a)')

plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[2,],type="h",main="Año 2022/2023 ",lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')
lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[2,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[2,],type="h",col='blue2',lwd=10)
text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[2,1],reps2a$YTP_p0W_proyectada[2,1],reps3a$YTP_p0W_proyectada[2,1]),c('38%','48%','43%'))
text(rep(1.35,3),c(reps1a$YTP_p0W_proyectada[2,2],reps2a$YTP_p0W_proyectada[2,2],reps3a$YTP_p0W_proyectada[2,2]),c('32%','41%','36%'))
text(4,380000,'b)')

par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot densidad de probabilidad CBA
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",xlab="CBA 2022 (toneladas)",main="", cex.axis=1,cex.main=1,cex.lab=1,xlim=c(50000,1000000),ylim=c(0,8.5e-06))

polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
lines(xca,yca,lwd=1,col="blue2",lty=1)

polygon(xxcb,yycb,col=gray(0.8,0.7),border="gray80")
lines(xcb,ycb,lwd=1,col="red2",lty=1)

polygon(xxcc,yycc,col=gray(0.8,0.7),border="gray80")
lines(xcc,ycc,lwd=1,col="green2",lty=1)

legend(90000,8e-06,
       c(paste("CBA2022_R1991-2007 = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" "),
         paste("CBA2022_R2008-2012 = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),
         paste("CBA2022_R2013-2021 = [",round(iccc[1],0),"-",round(iccc[2],0),"]",sep=" ")), lty=c(1,1,1),col=c('blue2',"red2","green2"),bty="n",lwd=1,cex=0.8)
text(950000,8e-06,'a)')
box()

#===============================================================================================================
# plot percentiles de captura
plot(seq(10,50,10),CBA_sept[1,],type="o", ylab="CBA 2022 (toneladas)",xlab="Percentil de Captura (P*)",main="",cex.axis=1,cex.main=1,cex.lab=1,col="blue2",ylim=c(0,800000))
lines(seq(10,50,10),CBA_sept[2,],type="o",col="red2")
lines(seq(10,50,10),CBA_sept[3,],type="o",col="green2")

legend(12,8e+05,c("R1991-2007","R2008-2012","R2013-2021"),col=c(4,2,3),pch=c(19,19,19),lwd=1,bty="n",cex=0.8)
text(49,8e+05,'b)')
#===============================================================================================================
# plot resguardo

#plot(seq(10,50,10),buffer[1,],type="o",ylim=c(0,0.35), ylab="Resguardo = (1-CBA/Crms)",xlab="Percentil de Captura (*P)",main="",lwd=2,lty=1,col='blue2')
#lines(seq(10,50,10),buffer[2,],type="o",col='red2')
#lines(seq(10,50,10),buffer[3,],type="o",col='green2')
#text(49,0.345,'d)')


C1eryearR1<-round(reps1a$YTP_p0W_proyectada[1,],0)
C1eryearR2<-round(reps2a$YTP_p0W_proyectada[1,],0)
C1eryearR3<-round(reps3a$YTP_p0W_proyectada[1,],0)

C2doyearR1<-round(reps1a$YTP_p0W_proyectada[2,],0)
C2doyearR2<-round(reps2a$YTP_p0W_proyectada[2,],0)
C2doyearR3<-round(reps3a$YTP_p0W_proyectada[2,],0)

kable(t(data.frame(C1eryearR1,C1eryearR2,C1eryearR3,C2doyearR1,C2doyearR2,C2doyearR3)))


```


\pagebreak

<!--- # Primera revisión CBA  (Asesoría de marzo) -->




```{r proyeccion1eraRevision,warning=F, include=T, message=F,eval=F, echo=F}

dira<-paste(dir.0,"/CBA_marzo/",sep="")
setwd(dira)


years2<-rep2$years
nyears2<-length(years2)

reps1a     <- reptoRlist("MAE32211.rep")  
reps2a     <- reptoRlist("MAE32212.rep") 
reps3a     <- reptoRlist("MAE32213.rep") 

carpeta<-"/CBA_marzo/"
stds1     <- read.table(paste(dir.0,carpeta,"MAE32211.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds2     <- read.table(paste(dir.0,carpeta,"MAE32212.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds3     <- read.table(paste(dir.0,carpeta,"MAE32213.std", sep=''),header=T,sep="",na="NA",fill=T) 

bds1     <- subset(stds1,name=="BD_p0")$value ; 
bds1std  <- subset(stds1,name=="BD_p0")$std #reclutamiento medios
bds2     <- subset(stds2,name=="BD_p0")$value ; 
bds2std  <- subset(stds2,name=="BD_p0")$std #reclutamiento 2018
bds3     <- subset(stds3,name=="BD_p0")$value ; 
bds3std  <- subset(stds3,name=="BD_p0")$std #reclutamiento 2012

RpRps1     <- subset(stds1,name=="RPR_p0")$value ; 
RpRps1std  <- subset(stds1,name=="RPR_p0")$std #reclutamiento medios
RpRps2     <- subset(stds2,name=="RPR_p0")$value ; 
RpRps2std  <- subset(stds2,name=="RPR_p0")$std #reclutamiento 2018
RpRps3     <- subset(stds3,name=="RPR_p0")$value ; 
RpRps3std  <- subset(stds3,name=="RPR_p0")$std #reclutamiento 2012

cs1     <- subset(stds1,name=="YTP_p0")$value ; 
cs1std  <- subset(stds1,name=="YTP_p0")$std #reclutamiento medios
cs2     <- subset(stds2,name=="YTP_p0")$value ; 
cs2std  <- subset(stds2,name=="YTP_p0")$std #reclutamiento 2018
cs3     <- subset(stds3,name=="YTP_p0")$value ; 
cs3std  <- subset(stds3,name=="YTP_p0")$std #reclutamiento 2012



#CAPTURA ESTIMADA ULTIMO AÑO EVALUACIÓN

#Captura año biológico actual
cs0     <- subset(stds1,name=="YTP_r0")$value ; 
cs0std  <- subset(stds1,name=="YTP_r0")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem)
cs0D     <- subset(stds1,name=="YTP_r01ersem")$value ; 
cs0Dstd  <- subset(stds1,name=="YTP_r01ersem")$std 

#Captura primer semestre (año biológico actual - desembarque2dosem - remanente)
cs0R     <- subset(stds1,name=="YTP_r01ersemR")$value ; 
cs0Rstd  <- subset(stds1,name=="YTP_r01ersemR")$std 

#######################################################################
# DESCUENTO DEL DESCARTE
#######################################################################
#Captura año biológico actual - descarte
cs0d     <- subset(stds1,name=="YTP_r0d")$value ; 
cs0dstd  <- subset(stds1,name=="YTP_r0d")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem) - descarte
cs01erS     <- subset(stds1,name=="YTP_r0d1ersem")$value ; 
cs01erSstd  <- subset(stds1,name=="YTP_r0d1ersem")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem - remanente) - descarte
cs01erSR     <- subset(stds1,name=="YTP_r0d1ersemR")$value ; 
cs01erSRstd  <- subset(stds1,name=="YTP_r0d1ersemR")$std 


#######################################################################
# RECLUTAMIENTO ESTIMADO ULTIMO AÑO EVALUACIÓN (AÑO ACTUAL)
RTs0     <- subset(stds1,name=="Reclutas")$value[nyears2] ; 
RTs0std  <- subset(stds1,name=="Reclutas")$std[nyears2] 

#BIOMASA DESOVANTE ESTIMADA ULTIMO AÑO EVALUACIÓN
bds0     <- subset(stds1,name=="SSB")$value[nyears2] ; 
bds0std  <- subset(stds1,name=="SSB")$std[nyears2] 
#######################################################################

```



```{r estatusproyectado_marzo,warning=F, include=T, message=F, echo=F,eval=F}

# ULTIMO AÑO EVALUACIÓN DE STOCK
#######################################################################################
probEstatusM1<-round(rbind('Recl_2022'=c(RTs0)/1000,
                   "BD~RMS~ (mil t)"=c(BRMS2)/1000,
                   'BD~2022~ (mil t)'=round(c(bds0[1])/1000,0),
                   'C~2022~ (mil t)'=round(c(cs0)/1000,0),
                   'C~1erS2022~ (mil t)'=round(c(cs0*0.7)/1000,0),
                   'C~1erS2022Desemb~ (mil t)'=round(c(cs0D)/1000,0),
                   'C~1erS2022Desemb-remanente~ (mil t)'=round(c(cs0R)/1000,0),
                   'C~2022~ (-descarte mil t)'=round(c(cs0d)/1000,0),
                   'C~1erS2022~ (-descarte mil t)'=round(c(cs0d*0.7)/1000,0),
                   'BD~2022~/BD~RMS~'=round(c(rprMARZO),2),
                   "*p(BD~2022~<BD~RMS~)*"=round(c(pa_mar),2),
                  "*p(sobreexplotación)*"=round(c(pc_mar),2),
                  "*p(agotado/colapsado)*"=round(c(pd_mar),2)),2)

colnames(probEstatusM1)<-c("R_2021/2022")
kable(probEstatusM1)


# PRIMER AÑO PROYECTADO
#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pa2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pa3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pc2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pc3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd1<-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pd2<-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pd3<-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)

#######################################################################################
propCaptura<-0.3
probEstatus<-round(rbind("BD~RMS~ (mil t)"=c(BRMS2)/1000,
                   'BD~proy2023~ (mil t)'=round(c(bds1[1],
                                              bds2[1],
                                              bds3[1])/1000,0),
                   'C~proy2023~ (mil t)'=round(c(cs1[1],
                                             cs2[1],
                                             cs3[1])/1000,0),
                   'C~2doS2023~ ( mil t)'=round(c((cs1[1])*propCaptura,
                                                  (cs2[1])*propCaptura,
                                                  (cs3[1])*propCaptura)/1000,0),
                    'C~calendario2022~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0*0.7),
                                                         (cs2[1]*propCaptura+cs0*0.7),
                                                         (cs3[1]*propCaptura+cs0*0.7))/1000,0),
                    'C~calendario2022-Desemb2Sem~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0D),
                                                         (cs2[1]*propCaptura+cs0D),
                                                         (cs3[1]*propCaptura+cs0D))/1000,0),
                    'C~calendario2022-Desemb2Sem-Reman~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0R),
                                                         (cs2[1]*propCaptura+cs0R),
                                                         (cs3[1]*propCaptura+cs0R))/1000,0),
                   'C~proy2023~ (-descarte mil t)'=round(c(cs1[1]*0.96,
                                                       cs2[1]*0.96,
                                                       cs3[1]*0.96)/1000,0),
                   'C~2doS2023~ (-descarte mil t)'=round(c((cs1[1]*0.96)*propCaptura,
                                                           (cs2[1]*0.96)*propCaptura,
                                                           (cs3[1]*0.96)*propCaptura)/1000,0),
                   'BD~2023~/BD~RMS~'=round(c(RpRps1[1],
                                              RpRps2[1],
                                              RpRps3[1]),2),
                   "*p(BD~2023~<BD~RMS~)*"=round(c(pa1,
                                                   pa2,
                                                   pa3),2),
                  "*p(sobreexplotación)*"=round(c(pc1,
                                                  pc2,
                                                  pc3),2),
                  "*p(agotado/colapsado)*"=round(c(pd1,
                                                   pd2,
                                                   pd3),2)),2)

colnames(probEstatus)<-c("R1",'R2','R3')
kable(probEstatus)

#######################################################################################




```


<!--- # Figuras de proyección  (Asesoría de marzo) -->

```{r Fig34a_marzo, warning=F, include=T, message=F,eval=F, echo=F,fig.height=7,fig.width=9,fig.align="center",fig.path="Figuras/",dev=fig}
par(mfrow=c(2,2),mar=c(4,4,1,1)+0.5)
yearProy<-c(2023)

#=======================================================
# plot reclutamientos 
plot(c(reps1a$years,yearProy),
     c(reps1a$Reclutas,NA),type="o",
     ylab="Reclutamientos",xlab="Años",main="",
     cex.axis=1,cex.main=1,cex.lab=1,xlim=c(1991,2025),pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps2a$Np[1]),type="o",col=2,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps3a$Np[1]),type="o",col=3,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps1a$Np[1]),type="o",col=4,pch=19)


lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        NA),type="o",col=1,pch=19)

abline(h=c(reps1a$Np[1],
           reps2a$Np[1],
           reps3a$Np[1]),
       col=c(4,2,3))

text(2025,c(reps1a$Np[1],
            reps2a$Np[1],
            reps3a$Np[1])+15000,
     round(c(reps1a$Np[1]/1000,
             reps2a$Np[1]/1000,
             reps3a$Np[1]/1000),0),cex=0.7)
text(2024,550000,"a)")
#=======================================================
# plot Biomasa desovante
plot(c(rep2$years,yearProy),
     c(rep2$SSB,bds3[1]),
     type="o",ylab="Biomasa desovante (t)",xlab="Años",col=3,
     xlim=c(1991,2025),pch=19,main="")

lines(c(rep2$years,yearProy),
      c(rep2$SSB,bds2[1]),
      type="o",col=2,pch=19)

lines(c(rep2$years,yearProy),
      c(rep2$SSB,bds1[1]),type="o",col=4,pch=19,lty=1)

lines(c(rep2$years,yearProy),
      c(rep2$SSB,c(NA)),type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
legend(2000,2000000,c("Reclprom 1991-2007","Reclprom 2008-2012","Reclprom 2013-2022"),pch=19,lwd=1,col=c(4,2,3),bty="n")
text(2024,2000000,"b)")
#=======================================================
# plot bd/BDrms
plot(c(rep2$years,yearProy),
     c(rep2$SSB,bds3[1])/BRMS2,
     type="o",ylab="BD/BDrms",col=3,xlab="Años",pch=19,xlim=c(1991,2025),ylim=c(0,3.1))

lines(c(rep2$years,yearProy),
      c(rep2$SSB,bds2[1])/BRMS2,
      type="o",col=2,pch=19)

lines(c(rep2$years,yearProy),
      c(rep2$SSB,bds1[1])/BRMS2,
      type="o",col=4,pch=19,lty=1)

lines(c(rep2$years,yearProy),
      c(rep2$SSB,c(NA))/BRMS2,
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)
abline(h=0.5,lty=2,col=2)
text(2024,3,"c)")

#=======================================================
# plot capturas proyectadas
plot(c(rep2$years,yearProy),
     c(rep2$desembarquepred,cs3[1]),type="o",
     ylab="Capturas (t)",col=3,xlab="Años",pch=19,xlim=c(1991,2025),)
lines(c(rep2$years,yearProy),
      c(rep2$desembarquepred,cs2[1]),
      type="o",col=2,pch=19)
lines(c(rep2$years,yearProy),
      c(rep2$desembarquepred,cs1[1]),
      type="o",col=4,pch=19)

lines(c(rep2$years,yearProy),
      c(rep2$desembarquepred,c(NA)),
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
#abline(h=cs0,lty=2,col=1)
text(2024,900000,"d)")

```


\pagebreak

<!--- # Proyeccion de Estatus de proyección (Asesoría de marzo) -->

```{r Tabla32_CBA_marzo, echo=FALSE, warning=F, include=T, message=F,eval=F}
dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_marzo     <- matrix(ncol=nq,nrow=nes)
CBAp_marzo    <- matrix(ncol=1,nrow=1)
CBApstd_marzo <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzo[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_marzo[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_marzo[i,j]<-qnorm(q[j],CBAp_marzo[i],CBApstd_marzo[i])}}

```


```{r Tabla_32a_marzo,eval=F, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_marzo("MAE322",mfyr,escR,year2="2021/22",year3="2022/23")
```

```{r Tabla_32b_marzo,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_marzo("MAE322",mfyr,escR,year2="2021/22",year3="2022/23")

```

```{r Tabla_32c_marzo,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_marzo("MAE322",mfyr,escR,year2="2021/22",year3="2022/23")
```

```{r DF_proymarzo2, eval=F,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))

admb_marzo<-"MAE322"
data1        <- lisread(paste(admb_marzo,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data
rep1         <- reptoRlist(paste(admb_marzo,".rep",sep=""))
std1         <- read.table(paste(admb_marzo,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep2$years                                                              
nyears     <- length(years)   
Bo         <- rep2$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep2$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep2$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep2$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std2,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std2,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std2,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std2,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std2,name=="log_Ft")$value)

```



```{r Fig45a_marzo, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))

pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(11,21,31)
admb_marzo<-"MAE322"

for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))
rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$value   
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprMARZO,SpBp[1]/BRMS),
     c(FrprMARZO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
      pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
    c(Frmsp[1]/FRMS-0.07),
    c("2022/23"),cex=c(0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)
text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)

```


```{r Fig45b_marzo, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(12,22,32)
admb_marzo<-"MAE322"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))
rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprMARZO,SpBp[1]/BRMS),
      c(FrprMARZO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp[1]/FRMS-0.07),
     c("2022/23","2023/24"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 2008-2012"
#nesc<-c(12,22,32)
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```

```{r Fig45c_marzo, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(13,23,33)
admb_marzo<-"MAE322"

for(i in 1:n){
name<-escR[3]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))
rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprMARZO,SpBp[1]/BRMS),
      c(FrprMARZO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp[1]/FRMS-0.07),
     c("2022/23","2023/24"),
     cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#nesc<-c(13,23,33)
#name<-"Reclprom 2013-2020"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```



\pagebreak

<!--- # PRIMERA REVISIÓN DE CBA (Asesoría de marzo) -->

```{r CBAinicial_marzo, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_marzo     <- matrix(ncol=nq,nrow=nes)
CBAp_marzo    <- matrix(ncol=1,nrow=1)
CBApstd_marzo <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzo[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_marzo[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_marzo[i,j]<-qnorm(q[j],CBAp_marzo[i],CBApstd_marzo[i])}}

```


```{r CBAinicial_marzoDescarte, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_marzoD     <- matrix(ncol=nq,nrow=nes)
CBAp_marzoD    <- matrix(ncol=1,nrow=1)
CBApstd_marzoD <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzoD[i]    <-subset(std,name=="CBA_c0d")$value[1]
	CBApstd_marzoD[i] <-subset(std,name=="CBA_c0d")$std[1]
	for(j in 1:nq){	CBA_marzoD[i,j]<-qnorm(q[j],CBAp_marzoD[i],CBApstd_marzoD[i])}}

```


```{r Tabla29a_CBAinicial_marzo,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzo<-cbind(CBAp_marzo,CBApstd_marzo,CBA_marzo)
colnames(tCBA_marzo)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzo)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzo,0)))
```


```{r Tabla29a_CBAinicial_marzoDescarte,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzoD<-cbind(CBAp_marzoD,CBApstd_marzoD,CBA_marzoD)
colnames(tCBA_marzoD)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzoD)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzoD,0)))
```


```{r Tabla30_resguardo_marzo, eval=F,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]<-round(1-CBA_marzo[i,j]/CBA_marzo[i,5],2)}}
colnames(buffer)<-c("10%","20%","30%","40%","50%")
row.names(buffer)<-c("1991-2007","2008-2012","2013-2021")
kable(t(buffer))
```


```{r Tabla31b_diferenciasdescarte_marzo, eval=F, echo=FALSE, warning=F, include=T, message=F}

descarte_marzo <- matrix(ncol=nq,nrow=nes)
descarte_sept <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_marzo[i,j]<-round(CBA_marzoD[i,j],0)}} # descarte 4% (1-0.04 = 0.94)
for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBAd_sept[i,j],0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementos<--round(1-(descarte_marzo/descarte_sept),2)*100
colnames(tablaincrementos)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementos)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementos))

```



<!--- # CBA - desembarque (Asesoría de marzo) -->


```{r CBAinicial_marzo-desembarque2doSem, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)          

CBA_marzoD2S     <- matrix(ncol=nq,nrow=nes)
CBAp_marzoD2S    <- matrix(ncol=1,nrow=1)
CBApstd_marzoD2S <- matrix(ncol=1,nrow=1)

bufferD2S   <- matrix(ncol=nq,nrow=nes)
descarteD2S <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzoD2S[i]    <-subset(std,name=="CBA_c0D")$value[1]
	CBApstd_marzoD2S[i] <-subset(std,name=="CBA_c0D")$std[1]
	for(j in 1:nq){	
	CBA_marzoD2S[i,j]<-qnorm(q[j],CBAp_marzoD2S[i],CBApstd_marzoD2S[i])}}

```



```{r CBAinicial_marzoDescarte-desembarque2doSem, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)  

CBA_marzoD2Sd     <- matrix(ncol=nq,nrow=nes)
CBAp_marzoD2Sd    <- matrix(ncol=1,nrow=1)
CBApstd_marzoD2Sd <- matrix(ncol=1,nrow=1)

bufferD2Sd   <- matrix(ncol=nq,nrow=nes)
descarteD2Sd <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzoD2Sd[i]    <-subset(std,name=="CBA_c0dD")$value[1]
	CBApstd_marzoD2Sd[i] <-subset(std,name=="CBA_c0dD")$std[1]
	for(j in 1:nq){	
	CBA_marzoD2Sd[i,j]<-qnorm(q[j],CBAp_marzoD2Sd[i],CBApstd_marzoD2Sd[i])}}

```



```{r Tabla29a_CBA_marzo-Desembarque2doSem,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzoD2S<-cbind(CBAp_marzoD2S,CBApstd_marzoD2S,CBA_marzoD2S)
colnames(tCBA_marzoD2S)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzoD2S)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzoD2S,0)))
```


```{r Tabla29a_CBA_marzoDescarte-Desembarque2doSem,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzoD2Sd<-cbind(CBAp_marzoD2Sd,CBApstd_marzoD2Sd,CBA_marzoD2Sd)
colnames(tCBA_marzoD2Sd)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzoD2Sd)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzoD2Sd,0)))
```



```{r Tabla30_resguardo_marzo-Desembarque2doSem, eval=F,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
bufferD2S[i,j]<-round(1-CBA_marzoD2S[i,j]/CBA_marzoD2S[i,5],2)}}
colnames(bufferD2S)<-c("10%","20%","30%","40%","50%")
row.names(bufferD2S)<-c("1991-2007","2008-2012","2013-2021")
kable(t(bufferD2S))
```


```{r Tabla31b_diferenciasdescarte_marzo-Desembarque2doSem, eval=F, echo=FALSE, warning=F, include=T, message=F}

descarte_marzoD2S <- matrix(ncol=nq,nrow=nes)
descarte_sept <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_marzoD2S[i,j]<-round(CBA_marzoD2Sd[i,j],0)}} # descarte 4% (1-0.04 = 0.94)
for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBAd_sept[i,j],0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementosD2S<--round(1-(descarte_marzoD2S/descarte_sept),2)*100
colnames(tablaincrementosD2S)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementosD2S)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementosD2S))

```




<!--- # CBA - desembarque - Remanente (Asesoría de marzo) -->


```{r CBA_marzo-desembarque2doSem-Remanente, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)          

CBA_marzoD2SR     <- matrix(ncol=nq,nrow=nes)
CBAp_marzoD2SR    <- matrix(ncol=1,nrow=1)
CBApstd_marzoD2SR <- matrix(ncol=1,nrow=1)

bufferD2SR   <- matrix(ncol=nq,nrow=nes)
descarteD2SR <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzoD2SR[i]    <-subset(std,name=="CBA_c0R")$value[1]
	CBApstd_marzoD2SR[i] <-subset(std,name=="CBA_c0R")$std[1]
	
	for(j in 1:nq){	
	CBA_marzoD2SR[i,j]<-qnorm(q[j],
	                          CBAp_marzoD2SR[i],
	                          CBApstd_marzoD2SR[i])}}

```




```{r Tabla29a_CBA_marzo-desembarque2doSem-Remanente,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzoD2SR<-cbind(CBAp_marzoD2SR,
                      CBApstd_marzoD2SR,
                      CBA_marzoD2SR)

colnames(tCBA_marzoD2SR)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzoD2SR)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzoD2SR,0)))
```


```{r CBA_marzoDescarte-desembarque2doSem-Remanente, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)  

CBA_marzoD2SdR     <- matrix(ncol=nq,nrow=nes)
CBAp_marzoD2SdR    <- matrix(ncol=1,nrow=1)
CBApstd_marzoD2SdR <- matrix(ncol=1,nrow=1)

bufferD2SdR   <- matrix(ncol=nq,nrow=nes)
descarteD2SdR <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE3221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzoD2SdR[i]    <-subset(std,name=="CBA_c0dR")$value[1]
	CBApstd_marzoD2SdR[i] <-subset(std,name=="CBA_c0dR")$std[1]
	for(j in 1:nq){	
	CBA_marzoD2SdR[i,j]<-qnorm(q[j],
	                           CBAp_marzoD2SdR[i],
	                           CBApstd_marzoD2SdR[i])}}

```


```{r Tabla29a_CBA_marzoDescarte-desembarque2doSem-Remanente,eval=F, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzoD2SdR<-cbind(CBAp_marzoD2SdR,
                       CBApstd_marzoD2SdR,
                       CBA_marzoD2SdR)
colnames(tCBA_marzoD2SdR)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzoD2SdR)<-c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_marzoD2SdR,0)))
```


```{r Tabla30_resguardo_marzo-Desembarque2doSem-Remanente, eval=F,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
bufferD2SR[i,j]<-round(1-CBA_marzoD2SR[i,j]/CBA_marzoD2SR[i,5],2)}}
colnames(bufferD2SR)<-c("10%","20%","30%","40%","50%")
row.names(bufferD2SR)<-c("1991-2007","2008-2012","2013-2021")
kable(t(bufferD2SR))
```


```{r Tabla31b_diferenciasdescarte_marzo-Desembarque2doSem-Remanente, eval=F, echo=FALSE, warning=F, include=T, message=F}

descarte_marzoD2SdR <- matrix(ncol=nq,nrow=nes)
descarte_sept <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_marzoD2SdR[i,j]<-round(CBA_marzoD2SdR[i,j],0)}} # descarte 4% (1-0.04 = 0.94)
for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBAd_sept[i,j],0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementosD2SR<--round(1-(descarte_marzoD2SdR/descarte_sept),2)*100
colnames(tablaincrementosD2SR)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementosD2SR)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementosD2SR))

```



<!--- # Figuras de CBA_RMS -->


```{r Fig27_CBAmarzo,warning=F, include=T, message=F,eval=F, echo=F,fig.height=5,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dira<-paste(dir.0,"/CBA_marzo",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE32211.rep")  
reps2a     <- reptoRlist("MAE32212.rep") 
reps3a     <- reptoRlist("MAE32213.rep") 

#===============================================================================================================
# escenario 1
#===============================================================================================================
xca1 <-rnorm(1000, mean = CBAp_marzo[1], 
                   sd   = CBApstd_marzo[1])

xca  <-seq(min(xca1),max(xca1),0.5)

yca  <-dnorm(xca, mean = CBAp_marzo[1],
                  sd   = CBApstd_marzo[1])

icca <-qnorm(c(0.1,0.5,0.5),CBAp_marzo[1],CBApstd_marzo[1])

xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],
         rev(xca[xca>=icca[1]&xca<=icca[2]]))

yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],
         rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))
#===============================================================================================================
# escenario 2
#===============================================================================================================
xcb1 <-rnorm(1000, mean = CBAp_marzo[2], 
                   sd   = CBApstd_marzo[2])

xcb  <-seq(min(xcb1),max(xcb1),0.5)

ycb  <-dnorm(xcb, mean = CBAp_marzo[2], 
                  sd   = CBApstd_marzo[2])

iccb <-qnorm(c(0.1,0.5,0.5),
             CBAp_marzo[2],
             CBApstd_marzo[2])

xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],
         rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))

yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],
         rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))
#===============================================================================================================
# escenario 3
#===============================================================================================================
xcc1 <-rnorm(1000, mean = CBAp_marzo[3], 
                   sd   = CBApstd_marzo[3])

xcc  <-seq(min(xcc1),max(xcc1),0.5)

ycc  <-dnorm(xcc, mean = CBAp_marzo[3], 
                  sd   = CBApstd_marzo[3])

iccc <-qnorm(c(0.1,0.5,0.5),
             CBAp_marzo[3],
             CBApstd_marzo[3])

xxcc <-c(xcc[xcc>=iccc[1]&xcc<=iccc[2]],
         rev(xcc[xcc>=iccc[1]&xcc<=iccc[2]]))

yycc <-c(ycc[xcc>=iccc[1]&xcc<=iccc[2]],
         rep(0,length(ycc[xcc>=iccc[1]&xcc<=iccc[2]])))


par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================


C1eryearR1act<-round(reps1a$YTP_r0W_actual[1]/sum(reps1a$YTP_r0W_actual),2)
C1eryearR1act2<-round(reps1a$YTP_r0W_actual[2]/sum(reps1a$YTP_r0W_actual),2)

C1eryearR1<-round(reps1a$YTP_p0W_proyectada[1,1]/sum(reps1a$YTP_p0W_proyectada[1,]),2)
C1eryearR2<-round(reps2a$YTP_p0W_proyectada[1,1]/sum(reps2a$YTP_p0W_proyectada[1,]),2)
C1eryearR3<-round(reps3a$YTP_p0W_proyectada[1,1]/sum(reps3a$YTP_p0W_proyectada[1,]),2)

C1eryearR12<-round(reps1a$YTP_p0W_proyectada[1,2]/sum(reps1a$YTP_p0W_proyectada[1,]),2)
C1eryearR22<-round(reps2a$YTP_p0W_proyectada[1,2]/sum(reps2a$YTP_p0W_proyectada[1,]),2)
C1eryearR32<-round(reps3a$YTP_p0W_proyectada[1,2]/sum(reps3a$YTP_p0W_proyectada[1,]),2)

#===============================================================================================================

# plot captura a la talla
plot(seq(0,4,1),reps1a$YTP_r0W_actual,type="h",main="Año 2021/2022",
     lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura  a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='gray50')
text(c(rep(0.35,1),1.35),c(reps1a$YTP_r0W_actual[1],reps1a$YTP_r0W_actual[2]),c(C1eryearR1act,C1eryearR1act2))
text(4,380000,'a)')



plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[1,],type="h",main="Año 2022/2023 ",lwd=20,ylim=c(0,400000),yaxs= "i",ylab="Captura a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')

lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[1,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[1,],type="h",col='blue2',lwd=10)

text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[1,1],
                   reps2a$YTP_p0W_proyectada[1,1],
                   reps3a$YTP_p0W_proyectada[1,1]),
                  c(C1eryearR1,C1eryearR2,C1eryearR3))
text(4,380000,'b)')

par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot densidad de probabilidad CBA
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",xlab="CBA 2022 (toneladas)",main="", cex.axis=1,cex.main=1,cex.lab=1,xlim=c(50000,1000000),ylim=c(0,5e-06))

polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
lines(xca,yca,lwd=1,col="blue2",lty=1)

polygon(xxcb,yycb,col=gray(0.8,0.7),border="gray80")
lines(xcb,ycb,lwd=1,col="red2",lty=1)

polygon(xxcc,yycc,col=gray(0.8,0.7),border="gray80")
lines(xcc,ycc,lwd=1,col="green2",lty=1)

legend(90000,5e-06,
       c(paste("CBA2022_R1991-2007 = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" "),
         paste("CBA2022_R2008-2012 = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),
         paste("CBA2022_R2013-2022 = [",round(iccc[1],0),"-",round(iccc[2],0),"]",sep=" ")), lty=c(1,1,1),col=c('blue2',"red2","green2"),bty="n",lwd=1,cex=0.8)
text(950000,8e-06,'a)')
box()

#===============================================================================================================
# plot percentiles de captura
plot(seq(10,50,10),CBA_marzo[1,],type="o", ylab="CBA 2022 (toneladas)",xlab="Percentil de Captura (P*)",main="",cex.axis=1,cex.main=1,cex.lab=1,col="blue2",ylim=c(0,800000))
lines(seq(10,50,10),CBA_marzo[2,],type="o",col="red2")
lines(seq(10,50,10),CBA_marzo[3,],type="o",col="green2")

legend(12,8e+05,c("R1991-2007","R2008-2012","R2013-2022"),col=c(4,2,3),pch=c(19,19,19),lwd=1,bty="n",cex=0.8)
text(49,8e+05,'b)')
#===============================================================================================================
# plot resguardo

#plot(seq(10,50,10),buffer[1,],type="o",ylim=c(0,0.35), ylab="Resguardo = (1-CBA/Crms)",xlab="Percentil de Captura (*P)",main="",lwd=2,lty=1,col='blue2')
#lines(seq(10,50,10),buffer[2,],type="o",col='red2')
#lines(seq(10,50,10),buffer[3,],type="o",col='green2')
#text(49,0.345,'d)')


kable(t(data.frame(C1eryearR1act,C1eryearR1,C1eryearR2,C1eryearR3)))

kable(t(data.frame(C1eryearR1act2,C1eryearR12,C1eryearR22,C1eryearR32)))

```

\pagebreak

<!--- # SEGUNDA REVISION CBA (Asesoría de JULIO) -->



```{r proyeccion2daRevision,warning=F, include=T, message=F,eval=F, echo=F}

dira<-paste(dir.0,"/CBA_julio/",sep="")
setwd(dira)


years3<-rep3$years
nyears3<-length(years3)

reps1a     <- reptoRlist("MAE72211.rep")  
reps2a     <- reptoRlist("MAE72212.rep") 
reps3a     <- reptoRlist("MAE72213.rep") 

carpeta<-"/CBA_julio/"
stds1     <- read.table(paste(dir.0,carpeta,"MAE72211.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds2     <- read.table(paste(dir.0,carpeta,"MAE72212.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds3     <- read.table(paste(dir.0,carpeta,"MAE72213.std", sep=''),header=T,sep="",na="NA",fill=T) 

bds1     <- subset(stds1,name=="BD_p0")$value ; 
bds1std  <- subset(stds1,name=="BD_p0")$std #reclutamiento medios
bds2     <- subset(stds2,name=="BD_p0")$value ; 
bds2std  <- subset(stds2,name=="BD_p0")$std #reclutamiento 2018
bds3     <- subset(stds3,name=="BD_p0")$value ; 
bds3std  <- subset(stds3,name=="BD_p0")$std #reclutamiento 2012

RpRps1     <- subset(stds1,name=="RPR_p0")$value ; 
RpRps1std  <- subset(stds1,name=="RPR_p0")$std #reclutamiento medios
RpRps2     <- subset(stds2,name=="RPR_p0")$value ; 
RpRps2std  <- subset(stds2,name=="RPR_p0")$std #reclutamiento 2018
RpRps3     <- subset(stds3,name=="RPR_p0")$value ; 
RpRps3std  <- subset(stds3,name=="RPR_p0")$std #reclutamiento 2012

cs1     <- subset(stds1,name=="YTP_p0")$value ; 
cs1std  <- subset(stds1,name=="YTP_p0")$std #reclutamiento medios
cs2     <- subset(stds2,name=="YTP_p0")$value ; 
cs2std  <- subset(stds2,name=="YTP_p0")$std #reclutamiento 2018
cs3     <- subset(stds3,name=="YTP_p0")$value ; 
cs3std  <- subset(stds3,name=="YTP_p0")$std #reclutamiento 2012



#CAPTURA ESTIMADA ULTIMO AÑO EVALUACIÓN

#Captura año biológico actual
cs0     <- subset(stds1,name=="YTP_r0")$value ; 
cs0std  <- subset(stds1,name=="YTP_r0")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem)
cs0D     <- subset(stds1,name=="YTP_r01ersem")$value ; 
cs0Dstd  <- subset(stds1,name=="YTP_r01ersem")$std 

#Captura primer semestre (año biológico actual - desembarque2dosem - remanente)
cs0R     <- subset(stds1,name=="YTP_r01ersemR")$value ; 
cs0Rstd  <- subset(stds1,name=="YTP_r01ersemR")$std 

#######################################################################
# DESCUENTO DEL DESCARTE
#######################################################################
#Captura año biológico actual - descarte
cs0d     <- subset(stds1,name=="YTP_r0d")$value ; 
cs0dstd  <- subset(stds1,name=="YTP_r0d")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem) - descarte
cs01erS     <- subset(stds1,name=="YTP_r0d1ersem")$value ; 
cs01erSstd  <- subset(stds1,name=="YTP_r0d1ersem")$std 

#Captura primer semestre (Captura año biológico actual - desembarque2dosem - remanente) - descarte
cs01erSR     <- subset(stds1,name=="YTP_r0d1ersemR")$value ; 
cs01erSRstd  <- subset(stds1,name=="YTP_r0d1ersemR")$std 


#######################################################################
# RECLUTAMIENTO ESTIMADO ULTIMO AÑO EVALUACIÓN (AÑO ACTUAL)
RTs0     <- subset(stds1,name=="Reclutas")$value[nyears3] ; 
RTs0std  <- subset(stds1,name=="Reclutas")$std[nyears3] 

#BIOMASA DESOVANTE ESTIMADA ULTIMO AÑO EVALUACIÓN
bds0     <- subset(stds1,name=="SSB")$value[nyears3] ; 
bds0std  <- subset(stds1,name=="SSB")$std[nyears3] 
#######################################################################

```




```{r estatusproyectado_julio,warning=F, include=T, message=F, echo=F,eval=F}

prop1erSem<-0.845885
# ULTIMO AÑO EVALUACIÓN DE STOCK
#######################################################################################
probEstatusM1<-round(rbind('Recl_2022'=c(RTs0)/1000,
                   "BD~RMS~ (mil t)"=c(BRMS3)/1000,
                   'BD~2022~ (mil t)'=round(c(bds0[1])/1000,0),
                   'C~2022~ (mil t)'=round(c(cs0)/1000,0),
                   'C~1erS2022~ (mil t)'=round(c(cs0*prop1erSem)/1000,0),
                   'C~1erS2022Desemb~ (mil t)'=round(c(cs0D)/1000,0),
                   'C~1erS2022Desemb-remanente~ (mil t)'=round(c(cs0R)/1000,0),
                   'C~2022~ (-descarte mil t)'=round(c(cs0d)/1000,0),
                   'C~1erS2022~ (-descarte mil t)'=round(c(cs0d*prop1erSem)/1000,0),
                   'BD~2022~/BD~RMS~'=round(c(rprJULIO),2),
                   "*p(BD~2022~<BD~RMS~)*"=round(c(pa_jul),2),
                  "*p(sobreexplotación)*"=round(c(pc_jul),2),
                  "*p(agotado/colapsado)*"=round(c(pd_jul),2)),2)

colnames(probEstatusM1)<-c("R_2021/2022")
kable(probEstatusM1)


# PRIMER AÑO PROYECTADO
#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pa2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pa3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pc2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pc3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd1<-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pd2<-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pd3<-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)

#######################################################################################
propCaptura<-0.3
probEstatus<-round(rbind("BD~RMS~ (mil t)"=c(BRMS2)/1000,
                   'BD~proy2023~ (mil t)'=round(c(bds1[1],
                                              bds2[1],
                                              bds3[1])/1000,0),
                   'C~proy2023~ (mil t)'=round(c(cs1[1],
                                             cs2[1],
                                             cs3[1])/1000,0),
                   'C~2doS2023~ ( mil t)'=round(c((cs1[1])*propCaptura,
                                                  (cs2[1])*propCaptura,
                                                  (cs3[1])*propCaptura)/1000,0),
                    'C~calendario2022~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0*prop1erSem),
                                                         (cs2[1]*propCaptura+cs0*prop1erSem),
                                                         (cs3[1]*propCaptura+cs0*prop1erSem))/1000,0),
                    'C~calendario2022-Desemb2Sem~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0D),
                                                         (cs2[1]*propCaptura+cs0D),
                                                         (cs3[1]*propCaptura+cs0D))/1000,0),
                    'C~calendario2022-Desemb2Sem-Reman~ ( mil t)'=round(c((cs1[1]*propCaptura+cs0R),
                                                         (cs2[1]*propCaptura+cs0R),
                                                         (cs3[1]*propCaptura+cs0R))/1000,0),
                   'C~proy2023~ (-descarte mil t)'=round(c(cs1[1]*0.96,
                                                       cs2[1]*0.96,
                                                       cs3[1]*0.96)/1000,0),
                   'C~2doS2023~ (-descarte mil t)'=round(c((cs1[1]*0.96)*propCaptura,
                                                           (cs2[1]*0.96)*propCaptura,
                                                           (cs3[1]*0.96)*propCaptura)/1000,0),
                   'BD~2023~/BD~RMS~'=round(c(RpRps1[1],
                                              RpRps2[1],
                                              RpRps3[1]),2),
                   "*p(BD~2023~<BD~RMS~)*"=round(c(pa1,
                                                   pa2,
                                                   pa3),2),
                  "*p(sobreexplotación)*"=round(c(pc1,
                                                  pc2,
                                                  pc3),2),
                  "*p(agotado/colapsado)*"=round(c(pd1,
                                                   pd2,
                                                   pd3),2)),2)

colnames(probEstatus)<-c("R1",'R2','R3')
kable(probEstatus)

#######################################################################################




```





<!--- # Figuras de proyección  (Asesoría de julio) -->

```{r Fig34a_julio, warning=F, include=T, message=F,eval=F, echo=F,fig.height=7,fig.width=9,fig.align="center",fig.path="Figuras/",dev=fig}
par(mfrow=c(2,2),mar=c(4,4,1,1)+0.5)
yearProy<-c(2023)

#=======================================================
# plot reclutamientos 
plot(c(reps1a$years,yearProy),
     c(reps1a$Reclutas,NA),type="o",
     ylab="Reclutamientos",xlab="Años",main="",
     cex.axis=1,cex.main=1,cex.lab=1,xlim=c(1991,2025),pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps2a$Np[1]),type="o",col=2,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps3a$Np[1]),type="o",col=3,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        reps1a$Np[1]),type="o",col=4,pch=19)


lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,
        NA),type="o",col=1,pch=19)

abline(h=c(reps1a$Np[1],
           reps2a$Np[1],
           reps3a$Np[1]),
       col=c(4,2,3))

text(2025,c(reps1a$Np[1],
            reps2a$Np[1],
            reps3a$Np[1])+15000,
     round(c(reps1a$Np[1]/1000,
             reps2a$Np[1]/1000,
             reps3a$Np[1]/1000),0),cex=0.7)
text(2024,550000,"a)")
#=======================================================
# plot Biomasa desovante
plot(c(rep3$years,yearProy),
     c(rep3$SSB,bds3[1]),
     type="o",ylab="Biomasa desovante (t)",xlab="Años",col=3,
     xlim=c(1991,2025),pch=19,main="")

lines(c(rep3$years,yearProy),
      c(rep3$SSB,bds2[1]),
      type="o",col=2,pch=19)

lines(c(rep3$years,yearProy),
      c(rep3$SSB,bds1[1]),type="o",col=4,pch=19,lty=1)

lines(c(rep3$years,yearProy),
      c(rep3$SSB,c(NA)),type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
legend(2000,2000000,c("Reclprom 1991-2007","Reclprom 2008-2012","Reclprom 2013-2022"),pch=19,lwd=1,col=c(4,2,3),bty="n")
text(2024,2000000,"b)")
#=======================================================
# plot bd/BDrms
plot(c(rep3$years,yearProy),
     c(rep3$SSB,bds3[1])/BRMS3,
     type="o",ylab="BD/BDrms",col=3,xlab="Años",pch=19,xlim=c(1991,2025),ylim=c(0,3.1))

lines(c(rep3$years,yearProy),
      c(rep3$SSB,bds2[1])/BRMS3,
      type="o",col=2,pch=19)

lines(c(rep3$years,yearProy),
      c(rep3$SSB,bds1[1])/BRMS3,
      type="o",col=4,pch=19,lty=1)

lines(c(rep3$years,yearProy),
      c(rep3$SSB,c(NA))/BRMS3,
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)
abline(h=0.5,lty=2,col=2)
text(2024,3,"c)")

#=======================================================
# plot capturas proyectadas
plot(c(rep3$years,yearProy),
     c(rep3$desembarquepred,cs3[1]),type="o",
     ylab="Capturas (t)",col=3,xlab="Años",pch=19,xlim=c(1991,2025),)
lines(c(rep3$years,yearProy),
      c(rep3$desembarquepred,cs2[1]),
      type="o",col=2,pch=19)
lines(c(rep3$years,yearProy),
      c(rep3$desembarquepred,cs1[1]),
      type="o",col=4,pch=19)

lines(c(rep3$years,yearProy),
      c(rep3$desembarquepred,c(NA)),
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
#abline(h=cs0,lty=2,col=1)
text(2024,900000,"d)")

```

\pagebreak

<!--- # Proyeccion de Estatus de proyección (Asesoría de julio) -->

```{r Tabla32_CBA_julio, echo=FALSE, warning=F, include=T, message=F,eval=F}
dir.4<-paste(dir.0,"/CBA_julio/",sep="")

EscRecl <- seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes     <- length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q) 

CBA_julio     <- matrix(ncol=nq,nrow=nes)
CBAp_julio    <- matrix(ncol=1,nrow=1)
CBApstd_julio <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std              <- read.table(paste(dir.4,"MAE7221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_julio[i]    <- subset(std,name=="CBA_c0")$value[1]
	CBApstd_julio[i] <- subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	
	  CBA_julio[i,j] <- qnorm(q[j],CBAp_julio[i],CBApstd_julio[i])}}

```


```{r Tabla_32a_julio,eval=F, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_marzo("MAE722",mfyr,escR,year2="2021/22",year3="2022/23")
```

```{r Tabla_32b_julio,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_marzo("MAE722",mfyr,escR,year2="2021/22",year3="2022/23")

```

```{r Tabla_32c_julio,eval=F, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_marzo("MAE722",mfyr,escR,year2="2021/22",year3="2022/23")
```

```{r DF_proy_julio2, eval=F,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_julio/",sep=""))

admb_julio<-"MAE722"
data1        <- lisread(paste(admb_julio,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data
rep1         <- reptoRlist(paste(admb_julio,".rep",sep=""))
std1         <- read.table(paste(admb_julio,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep3$years                                                              
nyears     <- length(years)   
Bo         <- rep3$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep3$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep3$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep3$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std3,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std3,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std3,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std3,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std3,name=="log_Ft")$value)

```



```{r Fig45a_julio, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))

pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(11,21,31)
admb_julio<-"MAE722"

for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))
rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$value   
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprJULIO,SpBp[1]/BRMS),
     c(FrprJULIO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
      pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
    c(Frmsp[1]/FRMS-0.07),
    c("2022/23"),cex=c(0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)
text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)

```


```{r Fig45b_julio, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(12,22,32)
admb_julio<-"MAE722"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))
rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprJULIO,SpBp[1]/BRMS),
      c(FrprJULIO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp[1]/FRMS-0.07),
     c("2022/23","2023/24"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 2008-2012"
#nesc<-c(12,22,32)
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```

```{r Fig45c_julio, eval=F, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2022",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(13,23,33)
admb_julio<-"MAE722"

for(i in 1:n){
name<-escR[3]
DiagramaFase_proy(name,
                  years[31:32],
                  SpB[31:32],
                  SpBSE[31:32],
                  ln_Fyr[31:32],
                  ln_FSE[31:32],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))
rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprJULIO,SpBp[1]/BRMS),
      c(FrprJULIO,Frmsp[1]/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp[1]/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp[1]/FRMS-0.07),
     c("2022/23","2023/24"),
     cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2021/22","2020/21"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#nesc<-c(13,23,33)
#name<-"Reclprom 2013-2020"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```


\pagebreak

<!--- # CBA (Asesoría de julio) -->


```{r CBA_julio, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_julio/",sep="")

EscRecl <- seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes     <- length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)

CBA_julio     <- matrix(ncol=nq,nrow=nes)
CBAp_julio    <- matrix(ncol=1,nrow=1)
CBApstd_julio <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std              <- read.table(paste(dir.4,"MAE7221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_julio[i]    <- subset(std,name=="CBA_c0")$value[1]
	CBApstd_julio[i] <- subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	
	CBA_julio[i,j]<-qnorm(q[j],CBAp_julio[i],CBApstd_julio[i])}}

```


```{r Tabla29a_CBA_julio,eval=F, echo=FALSE, warning=F, include=T, message=F}

tCBA_julio            <- cbind(CBAp_julio,CBApstd_julio,CBA_julio)
colnames(tCBA_julio)  <- c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_julio) <- c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_julio,0)))

```

<!-- CBA julio menos descarte -->
<!-- Este análisis se realiza en el tercer informe (asesoría de julio), se debe revisar que el código corresponda a julio del año correspondiente (ejemplo MAE723, codigo MAE de julio (7) del año 2023 (23) y cambiar eval=T -->


```{r CBA_julio_Descarte, eval=F, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_julio/",sep="")

EscRecl <- seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes     <- length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)  

CBA_julio_D     <- matrix(ncol=nq,nrow=nes)
CBAp_julio_D    <- matrix(ncol=1,nrow=1)
CBApstd_julio_D <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std                <- read.table(paste(dir.4,"MAE7221",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_julio_D[i]    <- subset(std,name=="CBA_c0d")$value[1]
	CBApstd_julio_D[i] <- subset(std,name=="CBA_c0d")$std[1]
	for(j in 1:nq){	
	CBA_julio_D[i,j]   <- qnorm(q[j],CBAp_julio_D[i],CBApstd_julio_D[i])}}

```


```{r Tabla29a_CBA_julio_Descarte,eval=F, echo=FALSE, warning=F, include=T, message=F}

tCBA_julio_D            <- cbind(CBAp_julio_D,CBApstd_julio_D,CBA_julio_D)
colnames(tCBA_julio_D)  <- c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_julio_D) <- c("1991-2007","2008-2012","2013-2022")
kable(t(round(tCBA_julio_D,0)))

```

<!--- # Resguardo CBA julio -->


```{r Tabla30_resguardo_julio, eval=F,echo=FALSE, warning=F, include=T, message=F}

for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]       <- round(1-CBA_julio[i,j]/CBA_julio[i,5],2)}}
colnames(buffer)  <- c("10%","20%","30%","40%","50%")
row.names(buffer) <- c("1991-2007","2008-2012","2013-2021")
kable(t(buffer))

```


<!--- # Diferencia entre CBAs asesoría de septiembre y julio -->

```{r Tabla31b_diferenciasdescarte_julioseptiembre, eval=F, echo=FALSE, warning=F, include=T, message=F}

descarte_julio <- matrix(ncol=nq,nrow=nes)
descarte_marzo <- matrix(ncol=nq,nrow=nes)
descarte_sept  <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_julio[i,j]<-round(CBA_julio_D[i,j],0)}} # descarte 4% (1-0.04 = 0.94)


for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBAd_sept[i,j],0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementos_julio_sept<--round(1-(descarte_julio/descarte_sept),2)*100
colnames(tablaincrementos_julio_sept)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementos_julio_sept)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementos_julio_sept))


```

<!--- # Diferencia entre CBAs asesoría de marzo y julio -->

```{r Tabla31b_diferenciasdescarte_juliomarzo, eval=F, echo=FALSE, warning=F, include=T, message=F}

descarte_julio <- matrix(ncol=nq,nrow=nes)
descarte_marzo <- matrix(ncol=nq,nrow=nes)


for(i in 1:nes){for(j in 1:nq){	
descarte_julio[i,j]<-round(CBA_julio_D[i,j],0)}} # descarte 4% (1-0.04 = 0.94)

for(i in 1:nes){for(j in 1:nq){	
descarte_marzo[i,j]<-round(CBA_marzoD2SdR[i,j],0)}} # descarte 4% (1-0.04 = 0.94)


tablaincrementos_julio_marzo<--round(1-(descarte_julio/descarte_marzoD2SdR),2)*100
colnames(tablaincrementos_julio_marzo)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementos_julio_marzo)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementos_julio_marzo))

```



\pagebreak



<!--- # Figuras de CBA_RMS -->


```{r Fig27_CBAjulio,warning=F, include=T, message=F,eval=F, echo=F,fig.height=5,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dira<-paste(dir.0,"/CBA_julio",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE72211.rep")  
reps2a     <- reptoRlist("MAE72212.rep") 
reps3a     <- reptoRlist("MAE72213.rep") 

#===============================================================================================================
# escenario 1
#===============================================================================================================
xca1 <-rnorm(1000, mean = CBAp_julio[1], 
                   sd   = CBApstd_julio[1])

xca  <-seq(min(xca1),max(xca1),0.5)

yca  <-dnorm(xca, mean = CBAp_julio[1],
                  sd   = CBApstd_julio[1])

icca <-qnorm(c(0.1,0.5,0.5),
             CBAp_julio[1],
             CBApstd_julio[1])

xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],
         rev(xca[xca>=icca[1]&xca<=icca[2]]))

yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],
         rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))
#===============================================================================================================
# escenario 2
#===============================================================================================================
xcb1 <-rnorm(1000, mean = CBAp_julio[2], 
                   sd   = CBApstd_julio[2])

xcb  <-seq(min(xcb1),max(xcb1),0.5)

ycb  <-dnorm(xcb, mean = CBAp_julio[2], 
                  sd   = CBApstd_julio[2])

iccb <-qnorm(c(0.1,0.5,0.5),
             CBAp_julio[2],
             CBApstd_julio[2])

xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],
         rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))

yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],
         rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))
#===============================================================================================================
# escenario 3
#===============================================================================================================
xcc1 <-rnorm(1000, mean = CBAp_julio[3], 
                   sd   = CBApstd_julio[3])

xcc  <-seq(min(xcc1),max(xcc1),0.5)

ycc  <-dnorm(xcc, mean = CBAp_julio[3], 
                  sd   = CBApstd_julio[3])

iccc <-qnorm(c(0.1,0.5,0.5),
             CBAp_julio[3],
             CBApstd_julio[3])

xxcc <-c(xcc[xcc>=iccc[1]&xcc<=iccc[2]],
         rev(xcc[xcc>=iccc[1]&xcc<=iccc[2]]))

yycc <-c(ycc[xcc>=iccc[1]&xcc<=iccc[2]],
         rep(0,length(ycc[xcc>=iccc[1]&xcc<=iccc[2]])))


par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================


C1eryearR1act<-round(reps1a$YTP_r0W_actual[1]/sum(reps1a$YTP_r0W_actual),2)
C1eryearR1act2<-round(reps1a$YTP_r0W_actual[2]/sum(reps1a$YTP_r0W_actual),2)

C1eryearR1<-round(reps1a$YTP_p0W_proyectada[1,1]/sum(reps1a$YTP_p0W_proyectada[1,]),2)
C1eryearR2<-round(reps2a$YTP_p0W_proyectada[1,1]/sum(reps2a$YTP_p0W_proyectada[1,]),2)
C1eryearR3<-round(reps3a$YTP_p0W_proyectada[1,1]/sum(reps3a$YTP_p0W_proyectada[1,]),2)

C1eryearR12<-round(reps1a$YTP_p0W_proyectada[1,2]/sum(reps1a$YTP_p0W_proyectada[1,]),2)
C1eryearR22<-round(reps2a$YTP_p0W_proyectada[1,2]/sum(reps2a$YTP_p0W_proyectada[1,]),2)
C1eryearR32<-round(reps3a$YTP_p0W_proyectada[1,2]/sum(reps3a$YTP_p0W_proyectada[1,]),2)

#===============================================================================================================

# plot captura a la talla
plot(seq(0,4,1),reps1a$YTP_r0W_actual,type="h",main="Año 2021/2022",
     lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura  a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='gray50')
text(c(rep(0.35,1),1.35),c(reps1a$YTP_r0W_actual[1],reps1a$YTP_r0W_actual[2]),c(C1eryearR1act,C1eryearR1act2))
text(4,380000,'a)')



plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[1,],type="h",main="Año 2022/2023 ",lwd=20,ylim=c(0,400000),yaxs= "i",ylab="Captura a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')

lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[1,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[1,],type="h",col='blue2',lwd=10)

text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[1,1],
                   reps2a$YTP_p0W_proyectada[1,1],
                   reps3a$YTP_p0W_proyectada[1,1]),
                  c(C1eryearR1,C1eryearR2,C1eryearR3))
text(4,380000,'b)')

par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot densidad de probabilidad CBA
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",xlab="CBA 2022 (toneladas)",main="", cex.axis=1,cex.main=1,cex.lab=1,xlim=c(180000,480000),ylim=c(0,2.35e-05))

polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
lines(xca,yca,lwd=1,col="blue2",lty=1)

polygon(xxcb,yycb,col=gray(0.8,0.7),border="gray80")
lines(xcb,ycb,lwd=1,col="red2",lty=1)

polygon(xxcc,yycc,col=gray(0.8,0.7),border="gray80")
lines(xcc,ycc,lwd=1,col="green2",lty=1)

legend(200000,2.35e-05,
       c(paste("CBA2022_R1991-2007 = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" "),
         paste("CBA2022_R2008-2012 = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),
         paste("CBA2022_R2013-2022 = [",round(iccc[1],0),"-",round(iccc[2],0),"]",sep=" ")), lty=c(1,1,1),col=c('blue2',"red2","green2"),bty="n",lwd=1,cex=0.8)
text(200000,2.2e-05,'a)')
box()

#===============================================================================================================
# plot percentiles de captura
plot(seq(10,50,10),CBA_julio[1,],type="o", ylab="CBA 2022 (toneladas)",xlab="Percentil de Captura (P*)",main="",cex.axis=1,cex.main=1,cex.lab=1,col="blue2",ylim=c(0,600000))
lines(seq(10,50,10),CBA_julio[2,],type="o",col="red2")
lines(seq(10,50,10),CBA_julio[3,],type="o",col="green2")

legend(12,6e+05,c("R1991-2007","R2008-2012","R2013-2022"),col=c(4,2,3),pch=c(19,19,19),lwd=1,bty="n",cex=0.8)
text(49,5.8e+05,'b)')
#===============================================================================================================
# plot resguardo

#plot(seq(10,50,10),buffer[1,],type="o",ylim=c(0,0.35), ylab="Resguardo = (1-CBA/Crms)",xlab="Percentil de Captura (*P)",main="",lwd=2,lty=1,col='blue2')
#lines(seq(10,50,10),buffer[2,],type="o",col='red2')
#lines(seq(10,50,10),buffer[3,],type="o",col='green2')
#text(49,0.345,'d)')


kable(t(data.frame(C1eryearR1act,C1eryearR1,C1eryearR2,C1eryearR3)))

kable(t(data.frame(C1eryearR1act2,C1eryearR12,C1eryearR22,C1eryearR32)))

```

\pagebreak



# \Huge \textbf{TABLAS} {-}



```{r kbl_t1, echo=FALSE,eval=T,warning=F, include=T, message=F}

kbl(dataInd, booktabs = T,format = "latex",position="h!",escape = F,align="c",format.args=list(big.mark = '.'),
    col.names = linebreak(c("Año\ncalendario ", "Biomasa crucero\nde verano\n(toneladas)",
                            "Biomasa crucero\nde otoño\n(toneladas)","Biomasa desovante\nMPDH\n(toneladas)"),align="c"),
caption = "\\label{t1} Estimaciones de biomasas utilizadas en la evaluación de stock de sardina común provenientes de los cruceros de Verano (RECLAS), Otoño (PELACES) y crucero de huevos (MPDH).") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=10)

```

\pagebreak


```{r kbl_t2 desembarques y descarte, echo=FALSE,eval=T,warning=F, include=T, message=F}

kbl(dataDes_y_descar, booktabs = T,format = "latex",position="h!",align="c",format.args=list(big.mark = '.'),
caption = "\\label{t2} Desembarques en toneladas, porcentaje de descarte supuesto,
captura descartada (toneladas) y captura total (toneladas) estimadas en año biológico para sardina común de las Regiones de Valparaíso a Los Lagos.") %>% kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=10)

```

\pagebreak



```{r kbl_Tab17, echo=F,warning=FALSE,include=T}


VarPobl1<- cbind(yearsb,
                 format(round(c(BD1),0),nsmall=0, big.mark="."),
                 format(round(c(BT1),0),nsmall=0, big.mark="."),
                 format(round(c(Rt1),0),nsmall=0, big.mark="."),
                 formatC(c(round(exp(Ft1),3)),decimal.mark = ",",digits = 3))


VarPobl1 %>%
kbl(booktabs = T,format = "latex",position="h!",escape = F,align="c",
    col.names = linebreak(c('Año\nbiológico',"Biomasa\ndesovante",
                            "Biomasa\ntotal","Reclutamientos",
                            "Mortalidad\npor pesca"),align="c"),
caption = "\\label{Tab17}Estimaciones medias de las biomasa desovante (t) , biomasa total (t), reclutamientos (\\#) y  mortalidad por pesca (año-1)  estimadas en la asesoría de septiembre 2022 de sardina común de las regiones de Valparaíso a Los Lagos.") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)


#write.csv(VarPobl1, file="Tablas/indicadorespoblacionales.csv")

```




```{r Tabla_20_promedios, echo=F,warning=FALSE,include=F,eval=T}

# Reclutimientos 
Rprom_1991_2007<-mean(Rt1[1:17])
Rprom_2008_2012<-mean(Rt1[18:22])
Rprom_2013_2022<-mean(Rt1[23:32])
Rprom_2013_2021<-mean(Rt1[23:31])
Rprom_historico<-mean(Rt1)

Rprom<-rbind(Rprom_1991_2007,
      Rprom_2008_2012,
      Rprom_2013_2022,
      Rprom_2013_2021,
      Rprom_historico)

#diferencia del Rúltimo año y los promedios de los tres períodos principales
Rlast_1991_2007<-1-(Rt1[32]/Rprom_1991_2007)
Rlast_2008_2012<-1-(Rt1[32]/Rprom_2008_2012)
Rlast_2013_2022<-1-(Rt1[32]/Rprom_2013_2022)
Rlast_2013_2021<-1-(Rt1[32]/Rprom_2013_2021)
Rlast_historico<-1-(Rt1[32]/Rprom_historico)

difR<-rbind(Rlast_1991_2007,
      Rlast_2008_2012,
      Rlast_2013_2022,
      Rlast_2013_2021,
      Rlast_historico)

# Biomasa total (BT) asesoría marzo 2021
BTprom_1991_2007<-mean(BT1[1:17])
BTprom_2008_2012<-mean(BT1[18:22])
BTprom_2013_2022<-mean(BT1[23:32])
BTprom_2013_2021<-mean(BT1[23:31])
BTprom_historico<-mean(BT1)

BTprom<-rbind(BTprom_1991_2007,
      BTprom_2008_2012,
      BTprom_2013_2022,
      BTprom_2013_2021,
      BTprom_historico)

#diferencia del BT último año y los promedios de los tres períodos principales
BTlast_1991_2007<-1-(BT1[32]/BTprom_1991_2007)
BTlast_2008_2012<-1-(BT1[32]/BTprom_2008_2012)
BTlast_2013_2022<-1-(BT1[32]/BTprom_2013_2022)
BTlast_2013_2021<-1-(BT1[32]/BTprom_2013_2021)
BTlast_historico<-1-(BT1[32]/BTprom_historico)

difBT<- rbind(BTlast_1991_2007,
      BTlast_2008_2012,
      BTlast_2013_2022,
      BTlast_2013_2021,
      BTlast_historico)


# Biomasa desovante (BD) asesoría marzo 2021

BDprom_1991_2007<-mean(BD1[1:17])
BDprom_2008_2012<-mean(BD1[18:22])
BDprom_2013_2022<-mean(BD1[23:32])
BDprom_2013_2021<-mean(BD1[23:31])
BDprom_historico<-mean(BD1)
  
BDprom<-rbind(BDprom_1991_2007,
      BDprom_2008_2012,
      BDprom_2013_2022,
      BDprom_2013_2021,
      BDprom_historico)

#diferencia del BD último año y los promedios de los tres períodos principales
BDlast_1991_2007<-1-(BD1[32]/BDprom_1991_2007)
BDlast_2008_2012<-1-(BD1[32]/BDprom_2008_2012)
BDlast_2013_2022<-1-(BD1[32]/BDprom_2013_2022)
BDlast_2013_2021<-1-(BD1[32]/BDprom_2013_2021)
BDlast_historico<-1-(BD1[32]/BDprom_historico)

difBD<-rbind(BDlast_1991_2007,
      BDlast_2008_2012,
      BDlast_2013_2022,
      BDlast_2013_2021,
      BDlast_historico)


diferencias<-cbind(difR,difBT,difBD,Rprom,BTprom,BDprom)
colnames(diferencias)<-c("difRt","difBT","difBD","Rprom","BTprom","BDprom")
diferencias

#write.csv(diferencias, file="Tablas/diferencias.csv")


```

\pagebreak


```{r Tabla_22_indicesEstatus, echo=F,warning=FALSE}
yearsb<-c("1990/91","1991/92","1992/93","1993/94","1994/95","1995/96","1996/97","1997/98","1998/99","1999/00","2000/01","2001/02","2002/03","2003/04","2004/05","2005/06","2006/07","2007/08","2008/09","2009/10","2010/11","2011/12","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20",'2020/21','2021/22')

VarPobl2<- data.frame('Años'=yearsb,
                 "F_FRMS"=formatC(c(round(exp(Ft1)/FRMS1,3)), decimal.mark = ","),
                 "BD_BDRMS"=formatC(c(round(BD1/BRMS1,3)), decimal.mark = ","),
                 "Y_BT"=formatC(c(round(rep1$desembarquepred/BT1,3)), decimal.mark = ","),
                 "C_N"=formatC(c(round(rowSums(rep1$pred_Ctot)/rowSums(rep1$N),3)), decimal.mark = ","))


kbl(VarPobl2, booktabs = T,format = "latex",position="h!",escape = F,align="c",
    col.names = linebreak(c('Año\nbiológico',
                            '$F/F_{RMS}$',
                            '$BD/BD_{RMS}$',
                            '$Y/BT$',
                            '$C\\#/N\\#$'),align="c"),
caption = "\\label{Tab22}Índices de reducción de F respecto de $F_{RMS}$ ($F/F_{RMS}$), BD respecto de $BD_{RMS}$ ($BD/BD_{RMS}$), tasas de explotación anual referidos a la biomasa ($Y/BT$) y a la abundancia estimada ($C\\#/N\\#$), estimadas en la evaluación de septiembre 2022 de sardina común de las regiones de Valparaíso a Los Lagos.") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)

```

<!--- Esta tabla se separa en el hito 2 o 3 (asesoría de marzo o julio) -->

```{r Tabla_22b_tasaExplotacion, echo=F,warning=FALSE,eval=F}

VarPobl2b<- cbind('Años'=yearsb,
                 "$Y/BT_{sept}$"=c(round(rep1$desembarquepred/BT1,3)),
                 "$C/N_{sept}$"=c(round(c(rowSums(rep1$pred_Ctot)/rowSums(rep1$N)),3)))
kable(VarPobl2b, align = 'c')

#setwd(dir.basedatos)
write.csv(VarPobl2b, file="Tablas/tasasExplotacion.csv")
#setwd(dir.1)

```



\pagebreak

<!--- RESULTADOS DE CALCULO DE PBRS PARA LA  ASESORÍA DE SEPTIEMBRE (HITO 1) -->

```{r Tabla_18_PBRs_septiembre, echo=F,eval=T,warning=FALSE,include=T,message=F}
Tabla3.1<-rbind( "BDpromedio"=c(round(Bmed1/10^3,0)),
                 "Fmh"=c(round(Fmedian1,2)), 
                 "%BDPR_Fmh"=c(pSPR_Fmh1*100), 
                 "%BDPR_F~RMS~"=c(60),
                 "%BD_Fmh"=c(pB_Fmh1*100),
                 "%BD_F~RMS~"=c(55),
                 "BDo"=c(round(Bo1/10^3,0)),
                 "BD55%"=c(round(BRMS1/10^3,0)),
                 "BD27.5%"=c(round(BLIM1/10^3,0)))

colnames(Tabla3.1)<-c("septiembre 2022")


kbl(Tabla3.1, booktabs = T,format = "latex",position="h!",align="c",format.args=list(big.mark = '.'),
caption = "\\label{Tab18}Procedimiento de cálculo de los puntos biológicos de referencia de biomasa (miles t) estimados en la evaluación de stock de septiembre 2022 para sardina común de las regiones de Valparaíso a Los Lagos, calculados siguiendo los pasos descritos en la metodología de este informe.") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)

#write.csv(Tabla3.1, file="Tablas/PBRsporasesoria.csv")

#Fmedian3

```



```{r Tabla23_probEstatus_sept, echo=F,eval=T,warning=FALSE,include=T,message=F}
Tabla4.1<-rbind("Año biológico"=c("2021/22"),
                "$F_{RMS}$"=c(round(FRMS1,2)),
                "$BD_{RMS}$"=c(round(BRMS1/10^3,0)),
                "$BD_{LIM}$"=c(round(BLIM1/10^3,0)),
                "$p(BD_{last}<BD_{RMS})$"=round(c(pa_sept),2),
                "$p(F_{last}>F_{RMS})$"=round(c(pb_sept),2),
                "$p(sobre-explotación)$"=round(c(pc_sept),2),
                "$p(agotado/colapsado)$"=round(c(pd_sept),2),
                "$p(sobrepesca)$"=round(c(pe_sept),2))

colnames(Tabla4.1)<-c("Septiembre 2022")



kbl(Tabla4.1, booktabs = T,format = "latex",position="h!",align="c",format.args=list(big.mark = '.', decimal.mark = ","),
caption = "\\label{Tab23}Puntos Biológicos de referencia (PBRs) y probabilidades de estar bajo $BD_{RMS}$ y sobre $F_{RMS}$ y en sobreexplotación, colapsado o sobrepesca.") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)


```

\pagebreak

<!--- RESULTADOS DE PROYECCIÓN ASESORÍA DE SEPTIEMBRE (HITO 1) -->

```{r estatusproyectado,warning=F, include=T, message=F, echo=F}

# PRIMER AÑO PROYECTADO
#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pa2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pa3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,
               RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pc2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,
               RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pc3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)-pnorm(0.5,
               RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd1<-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pd2<-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pd3<-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)

#######################################################################################
probEstatus<-round(rbind("BDRMS (mil t)"=c(BRMS1)/1000,
                   'BD2022 (mil t)'=round(c(bds1[1],
                                              bds2[1],
                                              bds3[1])/1000,0),
                   'C2022 (mil t)'=round(c(cs1[1],
                                             cs2[1],
                                             cs3[1])/1000,0),
                   'C1erS2022 ( mil t)'=round(c((cs1[1])*0.7,
                                                  (cs2[1])*0.7,
                                                  (cs3[1])*0.7)/1000,0),
                   'C2022 (-descarte mil t)'=round(c(cs1[1]*0.96,
                                                       cs2[1]*0.96,
                                                       cs3[1]*0.96)/1000,0),
                   'C1erS2022 (-descarte mil t)'=round(c((cs1[1]*0.96)*0.7,
                                                           (cs2[1]*0.96)*0.7,
                                                           (cs3[1]*0.96)*0.7)/1000,0),
                   'BD2022/BDRMS'=round(c(RpRps1[1],
                                              RpRps2[1],
                                              RpRps3[1]),2),
                   "*p(BD2022<BDRMS)*"=round(c(pa1,
                                                   pa2,
                                                   pa3),2),
                  "*p(sobreexplotación)*"=round(c(pc1,
                                                  pc2,
                                                  pc3),2),
                  "*p(agotado/colapsado)*"=round(c(pd1,
                                                   pd2,
                                                   pd3),2)),2)

colnames(probEstatus)<-c("R1",'R2','R3')

kbl(probEstatus, booktabs = T,format = "latex",position="h!",align="c",escape = FALSE,
caption = "Proyección primer año biológico asesoría de septiembre ") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)

#######################################################################################

# SEGUNDO AÑO PROYECTADO

#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa12<-pnorm(0.9,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pa22<-pnorm(0.9,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pa32<-pnorm(0.9,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc12<-pnorm(0.9,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)-pnorm(0.5,
                RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pc22<-pnorm(0.9,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)-pnorm(0.5,
                RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pc32<-pnorm(0.9,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)-pnorm(0.5,
                RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd12<-pnorm(0.5,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pd22<-pnorm(0.5,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pd32<-pnorm(0.5,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)

#######################################################################################
probEstatus2y<-round(rbind("BDRMS (mil t)"=c(BRMS1)/1000,
                   'BD2023(mil t)'=round(c(bds1[2],bds2[2],bds3[2])/1000,0),
                    'C2023(mil t)'=round(c(cs1[2],cs2[2],cs3[2])/1000,0),
                   'C2doS2022 ( mil t)'=round(c((cs1[2])*0.3,(cs2[2])*0.3,(cs3[2])*0.3)/1000,0),
                   'C2023 (-descarte mil t)'=round(c(cs1[2]*0.96,cs2[2]*0.96,cs3[2]*0.96)/1000,0),
                   'C2doS2022 (-descarte mil t)'=round(c((cs1[2]*0.96)*0.3,(cs2[2]*0.96)*0.3,(cs3[2]*0.96)*0.3)/1000,0),
                   'BD2023/BDRMS'=round(c(RpRps1[2],RpRps2[2],RpRps3[2]),2),
                   "*p(BD2023\\<BDRMS)*"=round(c(pa12,pa22,pa32),2),
                  "*p(sobreexplotación)*"=round(c(pc12,pc22,pc32),2),
                  "*p(agotado/colapsado)*"=round(c(pd12,pd22,pd32),2)),2)

colnames(probEstatus2y)<-c("R1",'R2','R3')




kbl(probEstatus2y, booktabs = T,format = "latex",position="h!",align="c",escape = FALSE,
caption = "Proyección segundo año biológico asesoría de septiembre") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)

```

\pagebreak


```{r Tabla25a_CBAinicial_sept,eval=T, echo=FALSE, warning=F, include=T, message=F}

percentiles<-c("10\\%","20\\%","30\\%","40\\%","50\\%")
escrec<-c("$R_{1991-2007}$","$R_{2008-2012}$","$R_{2013-2021}$")

tCBA<-t(data.frame(CBAp_sept,CBApstd_sept,CBA_sept))
colnames(tCBA)<-escrec
row.names(tCBA)<-c('mean','sd',percentiles)

kbl(round(tCBA,0), booktabs = T,format = "latex",position="h!",align="c",escape = FALSE,
caption = "CBA 2023 asesoría de septiembre") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)%>% 
  add_header_above(c(" " = 1,
                    "Escenarios de reclutamiento" = 3),line = F)%>% 
  add_header_above(c(" " = 1,
                    "CBA 2023" = 3))

```



```{r Tabla25a_CBAinicial-descarte_sept,eval=T, echo=FALSE, warning=F, include=T, message=F}

tCBAd<-t(data.frame(CBApd_sept,CBApdstd_sept,CBAd_sept))
colnames(tCBAd)<-escrec
row.names(tCBAd)<-c('mean','sd',percentiles)

kbl(round(tCBAd,0), booktabs = T,format = "latex",position="h!",align="c",escape = FALSE,
caption = "CBA 2023 con descuento del descarte asesoría de septiembre") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)%>% 
  add_header_above(c(" " = 1,
                    "Escenarios de reclutamiento" = 3),line = F)%>% 
  add_header_above(c(" " = 1,
                    "CBA 2023 - 4\\% descarte" = 3))

```


```{r Tabla26_resguardo_sept, eval=T,echo=FALSE, warning=F, include=T, message=F}

buffer<-matrix(ncol=5,nrow=3)

for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]<-round(1-CBA_sept[i,j]/CBA_sept[i,5],2)}}

buffer2<-data.frame(t(buffer))
colnames(buffer2)<-escrec
row.names(buffer2)<-percentiles


kbl(buffer2, booktabs = T,format = "latex",position="h!",align="c",escape = FALSE,
caption = "Buffer asesoría de septiembre") %>% 
  kable_styling(latex_options = c("striped", "condensed"),
                full_width = FALSE,font_size=8)%>% 
  add_header_above(c(" " = 1,
                    "Escenarios de reclutamiento" = 3),line = F)%>% 
  add_header_above(c(" " = 1,
                    "Resguardo" = 3))

```


\pagebreak

# REFERENCIAS {-}